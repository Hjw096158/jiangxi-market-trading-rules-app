<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê±üË•øÁîµÂäõÂ∏ÇÂú∫ËßÑÂàôÈóØÂÖ≥Á≥ªÁªü</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
            --card-bg: rgba(255, 255, 255, 0.08);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-color: #38bdf8;
            --success-color: #4ade80;
            --error-color: #f87171;
            --warning-color: #fbbf24;
            --locked-color: #475569;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.5;
        }

        /* --- Layout --- */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid var(--card-border);
        }

        .user-stats {
            display: flex;
            gap: 20px;
            font-weight: 600;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- Navigation/Pages --- */
        .page {
            display: none;
            animation: fadeIn 0.4s ease-out;
            flex: 1;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Map View --- */
        .map-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding-bottom: 40px;
        }

        .level-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 25px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden;
        }

        .level-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(0.8);
        }

        .level-card:not(.locked):hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-color);
        }

        .level-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .level-num {
            font-size: 0.9em;
            color: var(--accent-color);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .level-title {
            font-size: 1.25em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .level-info {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .progress-bar-bg {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--success-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* --- Sub-Level Navigation --- */
        .sub-level-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 12px;
            overflow-x: auto;
        }

        .sub-level-btn {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            font-weight: 600;
        }

        .sub-level-btn:hover {
            background: rgba(255,255,255,0.05);
        }

        .sub-level-btn.active {
            background: var(--accent-color);
            color: #fff;
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
        }

        /* --- Learning Section --- */
        .section-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .nav-btn.active {
            background: var(--accent-color);
            color: #fff;
            font-weight: bold;
        }

        /* Knowledge Cards */
        .knowledge-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .info-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--card-border);
        }

        .info-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .info-icon {
            font-size: 1.5em;
            background: rgba(255, 255, 255, 0.1);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .info-title {
            font-weight: bold;
            font-size: 1.1em;
            flex: 1;
        }

        .info-details {
            font-size: 0.9em;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Quiz Section */
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            border: 1px solid var(--card-border);
        }

        .question-card {
            margin-bottom: 20px;
            animation: fadeIn 0.3s;
        }

        .question-text {
            font-size: 1.2em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .options-grid {
            display: grid;
            gap: 12px;
        }

        /* Quiz Option Styles */
        .option-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            padding: 15px;
            border-radius: 10px;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .option-btn:hover:not(.disabled) {
            background: rgba(255, 255, 255, 0.15);
        }

        .option-btn.selected {
            border-color: var(--accent-color);
            background: rgba(56, 189, 248, 0.1);
        }

        .option-btn.correct {
            background: rgba(74, 222, 128, 0.2);
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .option-btn.wrong {
            background: rgba(248, 113, 113, 0.2);
            border-color: var(--error-color);
            color: var(--error-color);
        }

        /* True/False Switch */
        .tf-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
        }
        
        .tf-btn {
            padding: 15px 40px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .tf-btn.active-true { background: var(--success-color); color: #000; border-color: var(--success-color); }
        .tf-btn.active-false { background: var(--error-color); color: #fff; border-color: var(--error-color); }

        /* Case Study */
        .case-content {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--warning-color);
            font-size: 0.95em;
            line-height: 1.6;
        }

        .explanation {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.9em;
            display: none;
            border-left: 4px solid var(--accent-color);
        }

        .explanation.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* Simulator Game */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.2);
            padding: 10px 20px;
            border-radius: 12px;
        }

        .game-area {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            height: 600px;
        }

        .card-pool {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 15px;
            overflow-y: auto;
            border: 1px solid var(--card-border);
            position: relative;
        }

        .game-card {
            background: #fff;
            color: #1e293b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.2s;
            border-left: 4px solid var(--accent-color);
            font-size: 0.9em;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .game-card:active {
            cursor: grabbing;
            transform: scale(1.02);
        }

        .game-card.dragging {
            opacity: 0.5;
        }

        .drop-zones {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
        }

        .drop-zone {
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .drop-zone.drag-over {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent-color);
            transform: scale(1.02);
        }

        .drop-zone.correct-flash {
            animation: flashGreen 0.5s;
        }

        .drop-zone.wrong-flash {
            animation: flashRed 0.5s;
        }

        @keyframes flashGreen {
            0% { background: rgba(74, 222, 128, 0.5); }
            100% { background: rgba(255, 255, 255, 0.05); }
        }

        @keyframes flashRed {
            0% { background: rgba(248, 113, 113, 0.5); }
            100% { background: rgba(255, 255, 255, 0.05); }
        }

        .zone-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .zone-label {
            font-weight: bold;
        }

        /* Timeline Game Styles */
        .timeline-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        .timeline-slot {
            background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .timeline-slot.filled {
            border-style: solid;
            background: rgba(255,255,255,0.1);
        }
        .timeline-index {
            font-weight: bold;
            color: var(--accent-color);
            width: 30px;
        }
        .timeline-item {
            background: var(--accent-color);
            color: #000;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: grab;
            flex: 1;
        }

        /* Matching Game Styles */
        .match-game-container {
            display: grid;
            grid-template-columns: 1fr 100px 1fr;
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        .match-col {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .match-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            padding: 15px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .match-btn:hover { background: rgba(255,255,255,0.2); }
        .match-btn.selected { border-color: var(--accent-color); background: rgba(56, 189, 248, 0.2); }
        .match-btn.matched { border-color: var(--success-color); background: rgba(74, 222, 128, 0.2); opacity: 0.6; cursor: default; }
        .match-btn.wrong { animation: shake 0.4s; border-color: var(--error-color); }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Particle Effect */
        .particle {
            position: absolute;
            pointer-events: none;
            animation: particleFly 1s ease-out forwards;
            font-size: 1.2em;
        }

        @keyframes particleFly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        /* Result Page */
        .result-container {
            text-align: center;
            max-width: 600px;
            margin: 50px auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--card-border);
        }

        .stars {
            font-size: 3em;
            margin: 20px 0;
            letter-spacing: 10px;
        }

        .star.active { color: var(--warning-color); text-shadow: 0 0 20px var(--warning-color); }
        .star.inactive { color: #475569; }

        .score-display {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .action-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
            transition: all 0.2s;
            font-weight: bold;
        }

        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
        }

        .secondary-btn {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .secondary-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
                grid-template-rows: 150px 1fr;
                height: auto;
            }
            .card-pool {
                display: flex;
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 10px;
            }
            .game-card {
                display: inline-block;
                width: 160px;
                margin-right: 10px;
                white-space: normal;
                vertical-align: top;
            }
            .drop-zones {
                grid-template-columns: 1fr;
            }
            .match-game-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        /* Utility */
        .hidden { display: none !important; }
        .text-green { color: var(--success-color); }
        .text-red { color: var(--error-color); }
        .combo-text {
            color: var(--warning-color);
            font-weight: bold;
            font-size: 1.2em;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Header -->
    <header>
        <div class="logo">
            <span style="font-size: 1.5em; font-weight: bold;">‚ö° Ê±üË•øÁîµÂäõÂ∏ÇÂú∫</span>
            <span style="font-size: 0.8em; color: var(--text-secondary); margin-left: 10px;">Â≠¶‰π†ÈóØÂÖ≥Á≥ªÁªü MVP</span>
        </div>
        <div class="user-stats">
            <div class="stat-item">
                <span class="stat-icon">‚≠ê</span>
                <span id="total-score">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-icon">üîì</span>
                <span id="levels-unlocked">1/7</span>
            </div>
        </div>
    </header>

    <div id="pages">
        <!-- 1. Map Page -->
        <div id="page-map" class="page active">
            <h2 style="margin-bottom: 20px;">ÂÖ≥Âç°Âú∞Âõæ</h2>
            <div class="map-grid" id="level-grid">
                <!-- Levels will be injected by JS -->
            </div>
            <div style="margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>ÊÄª‰ΩìÂ≠¶‰π†ËøõÂ∫¶</span>
                    <span id="overall-progress-text">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="overall-progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- 2. Level Detail Page -->
        <div id="page-level" class="page">
            <div style="display:flex; align-items:center; margin-bottom:20px;">
                <button onclick="router.go('map')" style="background:none; border:none; color:white; font-size:1.5em; cursor:pointer; margin-right:15px;">‚Üê</button>
                <div>
                    <h2 id="current-level-title">Á¨¨1ÂÖ≥ÔºöÂ∏ÇÂú∫ÂáÜÂÖ•ÁØá</h2>
                    <p style="color:var(--text-secondary); font-size:0.9em;" id="current-level-subtitle">ÁªèËê•‰∏ª‰Ωì‰∏éÊ≥®ÂÜåÊµÅÁ®ã</p>
                </div>
            </div>

            <!-- Sub-Level Navigation -->
            <div class="sub-level-nav" id="sub-level-nav">
                <!-- Injected via JS -->
            </div>

            <div class="section-nav">
                <button class="nav-btn active" onclick="levelManager.switchTab('learn')">üìñ Áü•ËØÜÂ≠¶‰π†</button>
                <button class="nav-btn" onclick="levelManager.switchTab('quiz')">‚úçÔ∏è È¢òÁõÆÊåëÊàò</button>
                <button class="nav-btn" id="btn-tab-game" onclick="levelManager.switchTab('game')">üéÆ Ê®°ÊãüÂÆûÊàò</button>
            </div>

            <!-- Tab: Learn -->
            <div id="tab-learn" class="tab-content">
                <div class="knowledge-container" id="knowledge-content">
                    <!-- Content injected by JS -->
                </div>
                <div style="text-align:center; margin-top:30px;">
                    <button class="action-btn" onclick="levelManager.switchTab('quiz')">ÂºÄÂßãÁ≠îÈ¢òÊåëÊàò ‚Üí</button>
                </div>
            </div>

            <!-- Tab: Quiz -->
            <div id="tab-quiz" class="tab-content hidden">
                <div class="quiz-container">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px; color:var(--text-secondary);">
                        <span>ËøõÂ∫¶: <span id="quiz-progress">1/5</span></span>
                        <span>ÂæóÂàÜ: <span id="quiz-score">0</span></span>
                    </div>
                    <div id="quiz-area">
                        <!-- Question injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Tab: Game -->
            <div id="tab-game" class="tab-content hidden">
                <div class="game-header">
                    <div>
                        <h3 id="game-title">‰∏ª‰ΩìË∫´‰ªΩËØÜÂà´Âô®</h3>
                        <small style="color:var(--text-secondary)" id="game-instruction">ÊãñÊãΩÂç°ÁâáÂà∞Ê≠£Á°ÆÁöÑÁ±ªÂûãÊ°Ü</small>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:1.2em; font-weight:bold;">
                            ÂæóÂàÜ: <span id="game-score" class="text-green">0</span>
                            <span id="combo-display" class="combo-text hidden">COMBO x2!</span>
                        </div>
                        <div>‚è±Ô∏è <span id="game-timer">60</span>s | Ââ©‰Ωô: <span id="game-remaining">0</span></div>
                    </div>
                </div>
                
                <div id="game-start-overlay" style="text-align:center; padding:50px; background:var(--card-bg); border-radius:12px;">
                    <h3 id="game-start-title">ÂáÜÂ§áÂ•Ω‰∫ÜÂêóÔºü</h3>
                    <p style="margin:20px 0; color:var(--text-secondary)" id="game-start-desc">ÈúÄË¶ÅÂú®60ÁßíÂÜÖÂÆåÊàêÊåëÊàò„ÄÇ</p>
                    <button class="action-btn" onclick="simulator.start()">ÂºÄÂßãÊåëÊàò</button>
                </div>

                <!-- Game Type 1: Drag & Drop (1-1) -->
                <div id="game-area-drag" class="game-area hidden">
                    <div class="card-pool" id="game-pool">
                        <!-- Draggable cards -->
                    </div>
                    <div class="drop-zones" id="game-zones">
                        <!-- Drop zones -->
                    </div>
                </div>

                <!-- Game Type 2: Timeline Sort (1-3) -->
                <div id="game-area-timeline" class="hidden">
                    <div class="timeline-container" id="timeline-slots">
                        <!-- Slots injected by JS -->
                    </div>
                    <div style="margin-top:20px; text-align:center;">
                        <div id="timeline-pool" style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:20px;">
                            <!-- Draggable items -->
                        </div>
                        <button class="action-btn" onclick="simulator.checkTimeline()">Êèê‰∫§ÊéíÂ∫è</button>
                    </div>
                </div>

                <!-- Game Type 3: Matching (1-4) -->
                <div id="game-area-match" class="hidden">
                    <div class="match-game-container">
                        <div class="match-col" id="match-left"></div>
                        <div style="display:flex; align-items:center; justify-content:center; color:var(--text-secondary);">‚ÜîÔ∏è</div>
                        <div class="match-col" id="match-right"></div>
                    </div>
                </div>

                <!-- Game Type 4: Boss Challenge (1-5) -->
                <div id="game-area-boss" class="hidden">
                    <div class="quiz-container">
                        <div id="boss-quiz-area"></div>
                    </div>
                </div>

            </div>
        </div>

        <!-- 3. Result Page -->
        <div id="page-result" class="page">
            <div class="result-container">
                <h2 id="result-title">üéâ ÂÖ≥Âç°ÂÆåÊàêÔºÅ</h2>
                <div class="stars" id="result-stars">
                    <span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span>
                </div>
                <div class="score-display" id="result-score">95</div>
                <p style="color:var(--text-secondary); margin-bottom:30px;" id="result-msg">Â§™Ê£í‰∫ÜÔºÅ‰Ω†Â∑≤ÁªèÊéåÊè°‰∫ÜÊ†∏ÂøÉÁü•ËØÜ„ÄÇ</p>
                
                <div id="badges" style="display:flex; justify-content:center; gap:15px; margin-bottom:30px;">
                    <!-- Badges injected -->
                </div>

                <div>
                    <button class="action-btn" onclick="router.go('map')">ËøîÂõûÂú∞Âõæ</button>
                    <button class="action-btn secondary-btn" onclick="levelManager.resetLevel()">ÈáçÊñ∞ÊåëÊàò</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Data ---
    const LEVELS = [
        { id: 1, title: "Â∏ÇÂú∫ÂáÜÂÖ•ÁØá", subtitle: "ÁªèËê•‰∏ª‰Ωì‰∏éÊ≥®ÂÜåÊµÅÁ®ã", stars: 0, locked: false, progress: 0 },
        { id: 2, title: "‰∏≠ÈïøÊúüÂü∫Á°Ä", subtitle: "‰∫§ÊòìÂìÅÁßç‰∏éÂêàÂêåË¶ÅÁ¥†", stars: 0, locked: true, progress: 0 },
        { id: 3, title: "‰∫§ÊòìÊñπÂºèÁØá", subtitle: "ÂèåËæπ„ÄÅÁ´û‰ª∑‰∏éÊíÆÂêà", stars: 0, locked: true, progress: 0 },
        { id: 4, title: "‰ª∑Ê†º‰∏éÁîµÈáè", subtitle: "48Êó∂ÊÆµ‰∏éÁ∫¶ÊùüËÆ°ÁÆó", stars: 0, locked: true, progress: 0 },
        { id: 5, title: "ÁªøËâ≤ÁîµÂäõ", subtitle: "ÁªøÁîµ‰∫§Êòì‰∏éÁªøËØÅ", stars: 0, locked: true, progress: 0 },
        { id: 6, title: "ÁªìÁÆó‰ΩìÁ≥ª", subtitle: "ÁîµË¥πÁªìÁÆó‰∏éÂÅèÂ∑Æ", stars: 0, locked: true, progress: 0 },
        { id: 7, title: "ÁªºÂêàÂÆûÊàò", subtitle: "ÂÖ®ÊµÅÁ®ãÊ®°Êãü‰∫§Êòì", stars: 0, locked: true, progress: 0 }
    ];

    const SUB_LEVELS = {
        1: [
            { id: '1-1', title: '1-1 ÁªèËê•‰∏ª‰ΩìÁ±ªÂûãËØÜÂà´', hasSimulator: true, gameType: 'drag' },
            { id: '1-2', title: '1-2 Ê≥®ÂÜåÊù°‰ª∂Âà§Êñ≠', hasSimulator: false },
            { id: '1-3', title: '1-3 ‰∫§ÊòìÂìÅÁßçËÆ§Áü•', hasSimulator: true, gameType: 'timeline' },
            { id: '1-4', title: '1-4 Â∏ÇÂú∫ÁªìÊûÑËß£Êûê', hasSimulator: true, gameType: 'match' },
            { id: '1-5', title: '1-5 Âü∫Á°ÄÊ¶ÇÂøµÁªºÂêà', hasSimulator: true, gameType: 'boss' }
        ]
    };

    const KNOWLEDGE_DB = {
        '1-1': [
            { title: "ÂèëÁîµ‰ºÅ‰∏ö", icon: "üè≠", desc: "Êã•ÊúâÂèëÁîµÂéÇÔºåÂèñÂæóÁîµÂäõ‰∏öÂä°ËÆ∏ÂèØËØÅÔºåÂçïÊú∫ÂÆπÈáè6MWÂèä‰ª•‰∏ä„ÄÇÂåÖÊã¨ÁáÉÁÖ§„ÄÅÁáÉÊ∞î„ÄÅÊ∞¥Áîµ„ÄÅÊñ∞ËÉΩÊ∫êÁ≠â„ÄÇ" },
            { title: "ÂîÆÁîµÂÖ¨Âè∏", icon: "üè¢", desc: "ËµÑ‰∫ßÊÄªÈ¢ù‰∏ç‰Ωé‰∫é2000‰∏áÂÖÉÔºåÂÖ∑Â§á‰ø°ÊÅØÁ≥ªÁªüÔºå‰∏çÊã•ÊúâÁîµÁΩëËµÑ‰∫ßÔºåË¥üË¥£‰ª£ÁêÜÁî®Êà∑Ë¥≠Áîµ„ÄÇ" },
            { title: "ÁîµÂäõÁî®Êà∑", icon: "üè≠", desc: "ÁªèËê•ÊÄßÁî®Êà∑„ÄÇÊâπÂèëÁî®Êà∑ÈúÄÊé•ÂÖ•110kVÂèä‰ª•‰∏ä‰∏îÂπ¥Áî®ÁîµÈáè5000‰∏ákWh‰ª•‰∏äÔºõÂÖ∂‰ªñ‰∏∫Èõ∂ÂîÆÁî®Êà∑„ÄÇ" },
            { title: "Êñ∞ÂûãÂÇ®ËÉΩ", icon: "üîã", desc: "Áã¨Á´ãËÆ°Èáè„ÄÅÁã¨Á´ãÊéßÂà∂ÔºåÂèØÁã¨Á´ãÂèÇ‰∏éÁîµÂäõÂ∏ÇÂú∫‰∫§ÊòìÁöÑÁîµÂåñÂ≠¶ÂÇ®ËÉΩ„ÄÅÂéãÁº©Á©∫Ê∞îÂÇ®ËÉΩÁ≠â„ÄÇ" },
            { title: "ËôöÊãüÁîµÂéÇ", icon: "üåê", desc: "ËÅöÂêàÂàÜÂ∏ÉÂºèÁîµÊ∫ê„ÄÅÂèØÊéßË¥üËç∑„ÄÅÂÇ®ËÉΩÁ≠âËµÑÊ∫êÔºå‰Ωú‰∏∫‰∏Ä‰∏™Êï¥‰ΩìÂèÇ‰∏éÁîµÁΩëË∞ÉÂ∫¶ÂíåÂ∏ÇÂú∫‰∫§Êòì„ÄÇ" }
        ],
        '1-2': [
            { title: "ÂèëÁîµ‰ºÅ‰∏öÂáÜÂÖ•", icon: "‚ö°", desc: "‰æùÊ≥ïÂèñÂæóÊ†∏ÂáÜ/Â§áÊ°àÊñá‰ª∂ÔºõÂèñÂæóÁîµÂäõ‰∏öÂä°ËÆ∏ÂèØËØÅÔºõÂçïÊú∫ÂÆπÈáè6MWÂèä‰ª•‰∏äÔºõÁ≠æËÆ¢Âπ∂ÁΩëË∞ÉÂ∫¶ÂçèËÆÆ„ÄÇ" },
            { title: "ÂîÆÁîµÂÖ¨Âè∏ÂáÜÂÖ•", icon: "üíº", desc: "ËµÑ‰∫ßÊÄªÈ¢ù‚â•2000‰∏áÂÖÉÔºõÊúâÂõ∫ÂÆöÂú∫ÊâÄÂíå‰∏ìËÅå‰∫∫ÂëòÔºõÂÖ∑Â§á‰ø°ÊÅØÁ≥ªÁªüÂíåÂÆ¢Êà∑ÊúçÂä°ËÉΩÂäõÔºõÊó†‰∏çËâØ‰ø°Áî®ËÆ∞ÂΩï„ÄÇ" },
            { title: "ÁîµÂäõÁî®Êà∑ÂáÜÂÖ•", icon: "üè≠", desc: "Â∑•ÂïÜ‰∏öÁî®Êà∑ÂéüÂàô‰∏äÂÖ®ÈÉ®ÂèÇ‰∏éÂ∏ÇÂú∫ÔºõÊâπÂèëÁî®Êà∑ÈúÄ110kVÂèä‰ª•‰∏äÔºõÁªèËê•ÊÄßÁî®Êà∑ÈúÄÁ¨¶Âêà‰∫ß‰∏öÊîøÁ≠ñ„ÄÇ" },
            { title: "Ê≥®ÂÜåÊµÅÁ®ã", icon: "üìù", desc: "Áî≥ËØ∑ ‚Üí ÊâøËØ∫ ‚Üí ÂÆ°Êü•(5‰∏™Â∑•‰ΩúÊó•) ‚Üí ÂÖ¨Á§∫(ÂîÆÁîµÂÖ¨Âè∏10‰∏™Â∑•‰ΩúÊó•) ‚Üí ÁîüÊïà„ÄÇ" }
        ],
        '1-3': [
            { title: "‰∫§ÊòìÂìÅÁßç", icon: "üìä", desc: "ÂåÖÊã¨ÁîµËÉΩÈáè‰∫§ÊòìÔºàÁõ¥Êé•‰∫§ÊòìÔºâ„ÄÅÂêàÂêå‰∫§ÊòìÔºàËΩ¨ËÆ©/ÂõûË¥≠Ôºâ„ÄÅÁªøËâ≤ÁîµÂäõ‰∫§ÊòìÔºàÁîµËÉΩÈáè+ÁéØÂ¢É‰ª∑ÂÄºÔºâ„ÄÇ" },
            { title: "Âπ¥Â∫¶‰∫§Êòì", icon: "üìÖ", desc: "ÈÄöÂ∏∏Âú®ÊØèÂπ¥12ÊúàÂºÄÂ±ïÔºå‰∏ªË¶ÅÈááÁî®ÂèåËæπÂçèÂïÜÊñπÂºèÔºåÁ°ÆÂÆö‰∏ã‰∏ÄÂπ¥Â∫¶ÁöÑÂü∫Á°ÄÁîµÈáèÂíå‰ª∑Ê†º„ÄÇ" },
            { title: "ÊúàÂ∫¶‰∫§Êòì", icon: "üóìÔ∏è", desc: "ÂåÖÊã¨ÊúàÂ∫¶ÂèåËæπ„ÄÅÈõÜ‰∏≠Á´û‰ª∑„ÄÅÊåÇÁâåÁ≠âÊñπÂºèÔºåÂØπÂπ¥Â∫¶ÂêàÂêåËøõË°åË°•ÂÖÖÂíåË∞ÉÊï¥„ÄÇ" },
            { title: "D-2Êó•‰∫§Êòì", icon: "‚è≥", desc: "Âú®ËøêË°åÊó•Ââç2Â§©ËøõË°åÁöÑËûçÂêà‰∫§ÊòìÔºåËøûÊé•‰∏≠ÈïøÊúü‰∏éÁé∞Ë¥ßÂ∏ÇÂú∫„ÄÇ" }
        ],
        '1-4': [
            { title: "ÁîµÁΩë‰ºÅ‰∏ö", icon: "üîå", desc: "Ë¥üË¥£ËæìÈÖçÁîµÊúçÂä°„ÄÅÁîµÁΩëÂÆâÂÖ®ËøêË°å„ÄÅ‰ª£Êî∂ÁîµË¥πÔºå‰∏çÂèÇ‰∏éÂ∏ÇÂú∫Á´û‰∫âÔºåÊèê‰æõ‰øùÂ∫ïÂíå‰ª£ÁêÜË¥≠ÁîµÊúçÂä°„ÄÇ" },
            { title: "‰∫§ÊòìÊú∫ÊûÑ", icon: "üèõÔ∏è", desc: "Ë¥üË¥£Â∏ÇÂú∫Ê≥®ÂÜå„ÄÅÁªÑÁªá‰∫§Êòì„ÄÅÂá∫ÂÖ∑ÁªìÁÆó‰æùÊçÆ„ÄÅ‰ø°ÊÅØÊä´Èú≤ÔºåÊòØÂ∏ÇÂú∫ÁöÑÁªÑÁªáËÄÖ„ÄÇ" },
            { title: "Ë∞ÉÂ∫¶Êú∫ÊûÑ", icon: "üì°", desc: "Ë¥üË¥£ÂÆâÂÖ®Ê†°Ê†∏„ÄÅÂÆûÊó∂Ë∞ÉÂ∫¶„ÄÅËæÖÂä©ÊúçÂä°ÁÆ°ÁêÜÔºå‰øùÈöúÁîµÁΩëÂÆûÊó∂Âπ≥Ë°°„ÄÇ" },
            { title: "ÊùÉË¥£ËæπÁïå", icon: "‚öñÔ∏è", desc: "ÂèëÁîµ‰æßË¥üË¥£Áîü‰∫ßÔºåÁî®Êà∑‰æßË¥üË¥£Ê∂àË¥πÔºåÂîÆÁîµ‰æßË¥üË¥£ÊúçÂä°ÔºåÁîµÁΩë‰æßË¥üË¥£ËæìÈÄÅÔºå‰∫§Êòì/Ë∞ÉÂ∫¶Ë¥üË¥£ËøêËê•„ÄÇ" }
        ],
        '1-5': [
            { title: "Á¨¨1Á´†ÊÄªÂ§ç‰π†", icon: "üìö", desc: "ÂõûÈ°æÂ∏ÇÂú∫‰∏ª‰ΩìÂáÜÂÖ•Êù°‰ª∂„ÄÅÊ≥®ÂÜåÊµÅÁ®ã„ÄÅ‰∫§ÊòìÂìÅÁßçÂèäÂë®Êúü„ÄÅÂêÑÊñπÊùÉÂà©‰πâÂä°„ÄÇÂáÜÂ§áÂ•ΩËøéÊé•ÁªºÂêàÊåëÊàò‰∫ÜÂêóÔºü" }
        ]
    };

    const QUIZ_DB = {
        '1-1': [
            { type: 'sc', q: "Ê±üË•øÁîµÂäõÂ∏ÇÂú∫‰∏≠Ôºå‰∏ãÂàóÂì™È°π‰∏çÂ±û‰∫éÂ∏ÇÂú∫ÁªèËê•‰∏ª‰ΩìÔºü", options: ["ÂèëÁîµ‰ºÅ‰∏ö", "ÂîÆÁîµÂÖ¨Âè∏", "ÁîµÁΩë‰ºÅ‰∏ö", "ÁîµÂäõÁî®Êà∑"], answer: 2, explanation: "ÁîµÁΩë‰ºÅ‰∏ö‰∏ªË¶ÅË¥üË¥£ËæìÈÖçÁîµÊúçÂä°Ôºå‰∏çÂèÇ‰∏éÂ∏ÇÂú∫Á´û‰∫â„ÄÇ" },
            { type: 'sc', q: "ÊâπÂèëÁî®Êà∑ÂèÇ‰∏éÂ∏ÇÂú∫ÁöÑÁîµÂéãÁ≠âÁ∫ßË¶ÅÊ±ÇÂéüÂàô‰∏ä‰∏∫Ôºü", options: ["10kVÂèä‰ª•‰∏ä", "35kVÂèä‰ª•‰∏ä", "110kVÂèä‰ª•‰∏ä", "220kVÂèä‰ª•‰∏ä"], answer: 2, explanation: "ÊâπÂèëÁî®Êà∑ÂéüÂàô‰∏äÈúÄÊé•ÂÖ•ÁîµÂéãÁ≠âÁ∫ß110kVÂèä‰ª•‰∏ä„ÄÇ" },
            { type: 'sc', q: "ÂîÆÁîµÂÖ¨Âè∏Ê≥®ÂÜåÊó∂ÁöÑËµÑ‰∫ßÊÄªÈ¢ù‰∏çÂæó‰Ωé‰∫éÂ§öÂ∞ë‰∫∫Ê∞ëÂ∏ÅÔºü", options: ["500‰∏áÂÖÉ", "1000‰∏áÂÖÉ", "2000‰∏áÂÖÉ", "5000‰∏áÂÖÉ"], answer: 2, explanation: "ÂîÆÁîµÂÖ¨Âè∏ËµÑ‰∫ßÊÄªÈ¢ù‰∏çÂæó‰Ωé‰∫é2000‰∏áÂÖÉ‰∫∫Ê∞ëÂ∏Å„ÄÇ" },
            { type: 'sc', q: "ÂèëÁîµ‰ºÅ‰∏öÂèÇ‰∏éÂ∏ÇÂú∫ÁöÑÂçïÂè∞Êú∫ÁªÑÂÆπÈáèÈó®ÊßõÊòØÔºü", options: ["1MWÂèä‰ª•‰∏ä", "6MWÂèä‰ª•‰∏ä", "10MWÂèä‰ª•‰∏ä", "30MWÂèä‰ª•‰∏ä"], answer: 1, explanation: "ÂèëÁîµ‰ºÅ‰∏öÂçïÂè∞Êú∫ÁªÑÂÆπÈáèÈúÄËææÂà∞6MWÂèä‰ª•‰∏ä„ÄÇ" },
            { type: 'sc', q: "‰∏ãÂàóÂì™È°πÂ±û‰∫é‚ÄúÊñ∞ÂûãÁªèËê•‰∏ª‰Ωì‚ÄùÔºü", options: ["ÁáÉÁÖ§ÁîµÂéÇ", "ËôöÊãüÁîµÂéÇ", "Â±ÖÊ∞ëÁî®Êà∑", "ÁîµÁΩëÂÖ¨Âè∏"], answer: 1, explanation: "Êñ∞ÂûãÁªèËê•‰∏ª‰ΩìÂåÖÊã¨Êñ∞ÂûãÂÇ®ËÉΩ„ÄÅËôöÊãüÁîµÂéÇÁ≠â„ÄÇ" }
        ],
        '1-2': [
            { type: 'tf', q: "ÂèëÁîµ‰ºÅ‰∏öÁöÑÂçïÂè∞Êú∫ÁªÑÂÆπÈáèÂøÖÈ°ªËææÂà∞6ÂÖÜÁì¶Âèä‰ª•‰∏äÊâçËÉΩÂèÇ‰∏éÂ∏ÇÂú∫„ÄÇ", answer: true, explanation: "ËßÑÂàôÁ¨¨ÂÖ≠Êù°ËßÑÂÆöÔºåÂèëÁîµ‰ºÅ‰∏öÂçïÂè∞Êú∫ÁªÑÂÆπÈáèÈúÄ6MWÂèä‰ª•‰∏ä„ÄÇ" },
            { type: 'tf', q: "ÂîÆÁîµÂÖ¨Âè∏Ê≥®ÂÜåÂêéÈúÄË¶ÅËøõË°å10‰∏™Â∑•‰ΩúÊó•ÁöÑÂÖ¨Á§∫Êúü„ÄÇ", answer: true, explanation: "ÂîÆÁîµÂÖ¨Âè∏ÈúÄÂÖ¨Á§∫10‰∏™Â∑•‰ΩúÊó•ÔºåÂÖ∂‰ªñ‰∏ª‰ΩìÂÖçÂÖ¨Á§∫„ÄÇ" },
            { type: 'tf', q: "ÁîµÁΩë‰ºÅ‰∏öÂèØ‰ª•‰Ωú‰∏∫ÂîÆÁîµ‰∏ª‰ΩìÂèÇ‰∏éÂ∏ÇÂú∫Á´û‰∫â„ÄÇ", answer: false, explanation: "ÁîµÁΩë‰ºÅ‰∏ö‰∏çÂèÇ‰∏éÂ∏ÇÂú∫Á´û‰∫âÔºå‰ªÖÊèê‰æõ‰øùÂ∫ïÂíå‰ª£ÁêÜË¥≠Áîµ„ÄÇ" },
            { type: 'mc', q: "ÂîÆÁîµÂÖ¨Âè∏Ê≥®ÂÜåÈúÄË¶ÅÊª°Ë∂≥Âì™‰∫õÊù°‰ª∂Ôºü", options: ["ËµÑ‰∫ß‚â•2000‰∏á", "Êúâ‰∏ìËÅå‰∫∫Âëò", "Êúâ‰ø°ÊÅØÁ≥ªÁªü", "Êã•ÊúâÈÖçÁîµÁΩë"], answer: [0, 1, 2], explanation: "ÂîÆÁîµÂÖ¨Âè∏‰∏çÊã•ÊúâÁîµÁΩëËµÑ‰∫ß„ÄÇ" },
            { type: 'case', q: "ÊüêÂÖ¨Âè∏ËµÑ‰∫ß1800‰∏áÂÖÉÔºåÁî≥ËØ∑Ê≥®ÂÜåÂîÆÁîµÂÖ¨Âè∏„ÄÇ", subQ: "ËØ•ÂÖ¨Âè∏ÊòØÂê¶Á¨¶ÂêàÂáÜÂÖ•Êù°‰ª∂Ôºü", options: ["Á¨¶Âêà", "‰∏çÁ¨¶Âêà"], answer: 1, explanation: "ËµÑ‰∫ßÂøÖÈ°ª‚â•2000‰∏áÂÖÉÔºå1800‰∏áÂÖÉ‰∏çËææÊ†á„ÄÇ" }
        ],
        '1-3': [
            { type: 'sc', q: "‰∏≠ÈïøÊúüÂ∏ÇÂú∫ÁöÑ‰∏ªË¶Å‰∫§ÊòìÂìÅÁßç‰∏çÂåÖÊã¨Ôºü", options: ["ÁîµÂäõÁõ¥Êé•‰∫§Êòì", "ÂèëÁîµÊùÉ‰∫§Êòì", "ÂêàÂêåÁîµÈáèËΩ¨ËÆ©", "ÂÆûÊó∂Âπ≥Ë°°‰∫§Êòì"], answer: 3, explanation: "ÂÆûÊó∂Âπ≥Ë°°‰∫§ÊòìÂ±û‰∫éÁé∞Ë¥ßÂ∏ÇÂú∫ËåÉÁï¥„ÄÇ" },
            { type: 'sc', q: "Âπ¥Â∫¶ÂèåËæπÂçèÂïÜ‰∫§ÊòìÈÄöÂ∏∏Âú®ÊØèÂπ¥‰ªÄ‰πàÊó∂ÂÄôÂºÄÂ±ïÔºü", options: ["1Êúà", "6Êúà", "10Êúà", "12Êúà"], answer: 3, explanation: "Âπ¥Â∫¶‰∫§ÊòìÈÄöÂ∏∏Âú®‰∏ä‰∏ÄÂπ¥Â∫¶12Êúà‰ªΩÁªÑÁªáÂºÄÂ±ï„ÄÇ" },
            { type: 'mc', q: "‰ª•‰∏ãÂì™‰∫õÂ±û‰∫éÊúàÂ∫¶Âèä‰ª•ÂÜÖÁöÑ‰∏≠ÈïøÊúü‰∫§ÊòìÊñπÂºèÔºü", options: ["ÂèåËæπÂçèÂïÜ", "ÈõÜ‰∏≠Á´û‰ª∑", "ÊåÇÁâå", "ÊªöÂä®ÊíÆÂêà"], answer: [0, 1, 2, 3], explanation: "ÊúàÂ∫¶Âèä‰ª•ÂÜÖÂåÖÊã¨ÂèåËæπ„ÄÅÁ´û‰ª∑„ÄÅÊåÇÁâåÂíåÊªöÂä®ÊíÆÂêàÂõõÁßçÊñπÂºè„ÄÇ" },
            { type: 'tf', q: "48Êó∂ÊÆµÊòØÊåáÂ∞Ü‰∏ÄÂ§©24Â∞èÊó∂ÂàíÂàÜ‰∏∫48‰∏™ÂçäÂ∞èÊó∂ÁöÑ‰∫§ÊòìÊó∂ÊÆµ„ÄÇ", answer: true, explanation: "‰∏≠ÈïøÊúüÂ∏ÇÂú∫‰ª•48Êó∂ÊÆµ‰∏∫‰∫§ÊòìÊ†áÁöÑÁâ©„ÄÇ" },
            { type: 'sc', q: "ÊúàÂÜÖÊªöÂä®ÊíÆÂêà‰∫§ÊòìÁöÑ‰∏ªË¶ÅÂéüÂàôÊòØÔºü", options: ["‰ª∑Ê†º‰ºòÂÖà", "Êó∂Èó¥‰ºòÂÖà", "Êó∂Èó¥‰ºòÂÖà„ÄÅ‰ª∑Ê†º‰ºòÂÖà", "ÈöèÊú∫ÊíÆÂêà"], answer: 2, explanation: "ÊªöÂä®ÊíÆÂêà‰∫§ÊòìÊåâ‚ÄúÊó∂Èó¥‰ºòÂÖà„ÄÅ‰ª∑Ê†º‰ºòÂÖà‚ÄùÂéüÂàôËøõË°å„ÄÇ" }
        ],
        '1-4': [
            { type: 'sc', q: "Âú®Ê±üË•øÁîµÂäõÂ∏ÇÂú∫‰∏≠ÔºåË¥üË¥£ÁªÑÁªáÂ∏ÇÂú∫‰∫§ÊòìÁöÑÊú∫ÊûÑÊòØÔºü", options: ["ËÉΩÊ∫êÂ±Ä", "ÁîµÁΩë‰ºÅ‰∏ö", "ÁîµÂäõ‰∫§ÊòìÊú∫ÊûÑ", "Ë∞ÉÂ∫¶Êú∫ÊûÑ"], answer: 2, explanation: "ÁîµÂäõ‰∫§ÊòìÊú∫ÊûÑË¥üË¥£ÁªÑÁªáÂºÄÂ±ïÂ∏ÇÂú∫‰∫§Êòì„ÄÇ" },
            { type: 'mc', q: "ÁîµÂäõ‰∫§ÊòìÊú∫ÊûÑÁöÑ‰∏ªË¶ÅËÅåË¥£ÂåÖÊã¨Ôºü", options: ["ÁªÑÁªá‰∫§Êòì", "ËøêË°åÂπ≥Âè∞", "Âá∫ÂÖ∑ÁªìÁÆó‰æùÊçÆ", "Êî∂ÂèñÁîµË¥π"], answer: [0, 1, 2], explanation: "Êî∂ÂèñÁîµË¥πÊòØÁîµÁΩë‰ºÅ‰∏öÁöÑËÅåË¥£„ÄÇ" },
            { type: 'tf', q: "ÁîµÁΩë‰ºÅ‰∏öÂú®ÁîµÂäõÂ∏ÇÂú∫‰∏≠Êó¢Ë¥üË¥£ËæìÈÖçÁîµÊúçÂä°Ôºå‰πüÂèØ‰ª•‰Ωú‰∏∫ÁªèËê•‰∏ª‰ΩìÂèÇ‰∏éÂ∏ÇÂú∫‰∫§Êòì„ÄÇ", answer: false, explanation: "ÁîµÁΩë‰ºÅ‰∏ö‰∏çÂèÇ‰∏éÂ∏ÇÂú∫Á´û‰∫âÔºå‰ªÖÊèê‰æõ‰øùÂ∫ïÂíå‰ª£ÁêÜË¥≠Áîµ„ÄÇ" },
            { type: 'sc', q: "ÁîµÂäõË∞ÉÂ∫¶Êú∫ÊûÑÂú®Â∏ÇÂú∫ËøêËê•‰∏≠ÁöÑ‰∏ªË¶ÅËÅåË¥£ÊòØÔºü", options: ["Âà∂ÂÆöËßÑÂàô", "ÁªÑÁªáÂá∫Ê∏Ö", "ÂÆâÂÖ®Ê†°Ê†∏", "ÁõëÁù£Â∏ÇÂú∫"], answer: 2, explanation: "Ë∞ÉÂ∫¶Êú∫ÊûÑË¥üË¥£ÂÆâÂÖ®Ê†°Ê†∏ÂíåÂÆûÊó∂Ë∞ÉÂ∫¶„ÄÇ" },
            { type: 'mc', q: "‰ª•‰∏ãÂÖ≥‰∫éÂ∏ÇÂú∫ËøêËê•Êú∫ÊûÑÁöÑÊèèËø∞ÔºåÊ≠£Á°ÆÁöÑÊòØÔºü", options: ["‰∫§ÊòìÊú∫ÊûÑÁªÑÁªá‰∫§Êòì", "ÁîµÁΩë‰ºÅ‰∏öË¥üË¥£ÁªìÁÆó", "Ë∞ÉÂ∫¶Êú∫ÊûÑË¥üË¥£ÂÆâÂÖ®", "ÁõëÁÆ°ÈÉ®Èó®Âà∂ÂÆöËßÑÂàô"], answer: [0, 1, 2], explanation: "Â∏ÇÂú∫ËßÑÂàôÁî±ÊîøÂ∫úÈÉ®Èó®‰ºöÂêåÁõëÁÆ°ÈÉ®Èó®Âà∂ÂÆö„ÄÇ" }
        ],
        '1-5': [
            // Boss level uses a mix, populated dynamically or predefined
        ]
    };

    // Populate Boss Level (Mix of previous questions)
    const allQuestions = [...QUIZ_DB['1-1'], ...QUIZ_DB['1-2'], ...QUIZ_DB['1-3'], ...QUIZ_DB['1-4']];
    QUIZ_DB['1-5'] = allQuestions.sort(() => 0.5 - Math.random()).slice(0, 15);

    // --- Game Data ---
    const GAME_DATA = {
        '1-1': {
            title: "‰∏ª‰ΩìË∫´‰ªΩËØÜÂà´Âô®",
            instruction: "ÊãñÊãΩÂç°ÁâáÂà∞Ê≠£Á°ÆÁöÑÁ±ªÂûãÊ°Ü",
            desc: "ÈúÄË¶ÅÂú®60ÁßíÂÜÖÂÆåÊàê10‰∏™‰∏ª‰ΩìÁöÑÂàÜÁ±ªÂåπÈÖç„ÄÇ",
            zones: [
                { id: "generator", label: "ÂèëÁîµ‰ºÅ‰∏ö", icon: "üè≠" },
                { id: "retailer", label: "ÂîÆÁîµÂÖ¨Âè∏", icon: "üè¢" },
                { id: "user", label: "ÁîµÂäõÁî®Êà∑", icon: "üè≠" },
                { id: "storage", label: "Êñ∞ÂûãÂÇ®ËÉΩ", icon: "üîã" },
                { id: "vpp", label: "ËôöÊãüÁîµÂéÇ", icon: "üåê" }
            ],
            items: [
                { id: 1, name: "ÂçéËÉΩ‰∫ïÂÜàÂ±±ÁîµÂéÇ", desc: "300MWÁáÉÁÖ§Êú∫ÁªÑ", type: "generator" },
                { id: 2, name: "Ëµ£Ê±üÊñ∞Âå∫ÂîÆÁîµÂÖ¨Âè∏", desc: "Ê≥®ÂÜåËµÑÊú¨2000‰∏á", type: "retailer" },
                { id: 3, name: "ÂçóÊòåÊüêÈí¢ÈìÅÈõÜÂõ¢", desc: "110kV‰∏ìÁ∫ø‰æõÁîµ", type: "user" },
                { id: 4, name: "ÂÆúÊò•ÈîÇÁîµÂÇ®ËÉΩÁ´ô", desc: "Áã¨Á´ãËÆ°ÈáèÊé•ÂÖ•", type: "storage" },
                { id: 5, name: "ÊüêË¥üËç∑ËÅöÂêàÂïÜ", desc: "ËÅöÂêà500‰∏™ÂÖÖÁîµÊ°©", type: "vpp" },
                { id: 6, name: "Ê±üË•øÊüêÈ£éÁîµÂú∫", desc: "Ë£ÖÊú∫ÂÆπÈáè50MW", type: "generator" },
                { id: 7, name: "‰πùÊ±üÊüêÊ∞¥Ê≥•ÂéÇ", desc: "Âπ¥Áî®Áîµ8000‰∏ákWh", type: "user" },
                { id: 8, name: "ÊüêËÉΩÊ∫êÊúçÂä°ÂÖ¨Âè∏", desc: "‰ª£ÁêÜ100ÂÆ∂‰∏≠Â∞èÁî®Êà∑", type: "retailer" },
                { id: 9, name: "ÊüêÊ•ºÂÆáÁ©∫Ë∞ÉËÅöÂêà", desc: "ÂÖ∑Â§áË∞ÉËäÇËÉΩÂäõ", type: "vpp" },
                { id: 10, name: "Á£∑ÈÖ∏ÈìÅÈîÇÁîµÊ±†Á´ô", desc: "ÂèÇ‰∏éË∞ÉÂ≥∞ËæÖÂä©ÊúçÂä°", type: "storage" }
            ]
        },
        '1-3': {
            title: "‰∫§ÊòìÊó∂Èó¥ËΩ¥ÊéíÂ∫è",
            instruction: "Â∞Ü‰∫§ÊòìÁ±ªÂûãÊåâÊ≠£Á°ÆÁöÑÊó∂Èó¥È°∫Â∫èÊéíÂàó",
            desc: "ÊãñÊãΩ‰∏ãÊñπÂç°ÁâáÂà∞‰∏äÊñπÁöÑÊó∂Èó¥ËΩ¥ÊèíÊßΩ‰∏≠„ÄÇ",
            correctOrder: ["annual", "monthly", "intra", "d2", "spot", "realtime"],
            items: [
                { id: "monthly", label: "ÊúàÂ∫¶‰∫§Êòì" },
                { id: "spot", label: "Áé∞Ë¥ß‰∫§Êòì(D-1)" },
                { id: "annual", label: "Âπ¥Â∫¶‰∫§Êòì" },
                { id: "realtime", label: "ÂÆûÊó∂ËøêË°å(D)" },
                { id: "d2", label: "D-2Êó•ËûçÂêà" },
                { id: "intra", label: "ÊúàÂÜÖ‰∫§Êòì" }
            ]
        },
        '1-4': {
            title: "Â∏ÇÂú∫ËßíËâ≤ËøûÁ∫ø",
            instruction: "ÁÇπÂáªÂ∑¶‰æßËÅåË¥£ÔºåÂÜçÁÇπÂáªÂè≥‰æßÂØπÂ∫î‰∏ª‰ΩìËøõË°åÂåπÈÖç",
            desc: "Â∞ÜÂ∏ÇÂú∫ËÅåË¥£‰∏éË¥£‰ªª‰∏ª‰ΩìÊ≠£Á°ÆÂØπÂ∫î„ÄÇ",
            pairs: [
                { left: "ËæìÈÖçÁîµÊúçÂä°", right: "ÁîµÁΩë‰ºÅ‰∏ö" },
                { left: "ÁªÑÁªáÂ∏ÇÂú∫‰∫§Êòì", right: "‰∫§ÊòìÊú∫ÊûÑ" },
                { left: "ÁîµÁΩëÂÆâÂÖ®Ê†°Ê†∏", right: "Ë∞ÉÂ∫¶Êú∫ÊûÑ" },
                { left: "Áîü‰∫ßÁªøËâ≤ÁîµÂäõ", right: "ÂèëÁîµ‰ºÅ‰∏ö" },
                { left: "‰ª£ÁêÜÁî®Êà∑Ë¥≠Áîµ", right: "ÂîÆÁîµÂÖ¨Âè∏" }
            ]
        },
        '1-5': {
            title: "Á¨¨1Á´† BOSSÊåëÊàò",
            instruction: "ÈôêÊó∂15ÂàÜÈíüÔºåÂÆåÊàê15ÈÅìÁªºÂêàÊµãËØïÈ¢ò",
            desc: "ËøôÊòØÊúÄÁªàËÄÉÈ™åÔºÅÁ≠îÂØπ12È¢ò‰ª•‰∏äÊâçËÉΩÈÄöÂÖ≥„ÄÇ",
            timeLimit: 900 // 15 mins
        }
    };

    // --- State Management ---
    const state = {
        totalScore: 0,
        currentLevelIdx: 0,
        currentSubLevelId: '1-1',
        quiz: {
            currentIdx: 0,
            score: 0,
            answers: [],
            completed: false
        },
        game: {
            active: false,
            score: 0,
            completedCount: 0,
            timer: 60,
            combo: 0,
            timerInterval: null,
            timelineSlots: [],
            matchSelection: { left: null, right: null },
            bossAnswers: []
        }
    };

    // --- Router ---
    const router = {
        go: (pageId) => {
            // ÁßªÈô§ÊâÄÊúâÈ°µÈù¢ÁöÑactiveÁ±ª
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // ÊøÄÊ¥ªÁõÆÊ†áÈ°µÈù¢
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            window.scrollTo(0, 0);
            
            // Â¶ÇÊûúÊòØÂú∞ÂõæÈ°µÈù¢ÔºåÈáçÊñ∞Ê∏≤ÊüìÂú∞Âõæ
            if (pageId === 'map') renderMap();
        }
    };

    // --- Level Manager ---
    const levelManager = {
        init: () => {
            renderMap();
        },

        startLevel: (idx) => {
            if (LEVELS[idx].locked) return;
            state.currentLevelIdx = idx;
            const subLevels = SUB_LEVELS[LEVELS[idx].id];
            if (subLevels) {
                levelManager.switchSubLevel(subLevels[0].id);
            }
            router.go('level');
        },

        switchSubLevel: (subLevelId) => {
            state.currentSubLevelId = subLevelId;
            state.quiz = { currentIdx: 0, score: 0, answers: [], completed: false };
            state.game = { active: false, score: 0, completedCount: 0, timer: 60, combo: 0, timerInterval: null, timelineSlots: [], matchSelection: {left:null, right:null}, bossAnswers: [] };
            
            // Render Nav
            const subLevels = SUB_LEVELS[LEVELS[state.currentLevelIdx].id];
            const navContainer = document.getElementById('sub-level-nav');
            navContainer.innerHTML = subLevels.map(sl => `
                <button class="sub-level-btn ${sl.id === subLevelId ? 'active' : ''}" 
                        onclick="levelManager.switchSubLevel('${sl.id}')">
                    ${sl.title}
                </button>
            `).join('');

            // Update Header
            const currentSL = subLevels.find(sl => sl.id === subLevelId);
            document.getElementById('current-level-title').innerText = currentSL.title;
            
            // Toggle Game Tab Visibility
            const gameBtn = document.getElementById('btn-tab-game');
            if (currentSL.hasSimulator) {
                gameBtn.classList.remove('hidden');
                // Setup Game UI based on type
                const gData = GAME_DATA[subLevelId];
                if(gData) {
                    document.getElementById('game-title').innerText = gData.title;
                    document.getElementById('game-instruction').innerText = gData.instruction;
                    document.getElementById('game-start-title').innerText = subLevelId === '1-5' ? "BOSS ÊåëÊàò" : "ÂáÜÂ§áÂ•Ω‰∫ÜÂêóÔºü";
                    document.getElementById('game-start-desc').innerText = gData.desc;
                    document.getElementById('game-timer').innerText = gData.timeLimit || 60;
                }
            } else {
                gameBtn.classList.add('hidden');
            }

            // Reset Tab
            levelManager.switchTab('learn');
        },

        switchTab: (tabId) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            if(tabId === 'learn') {
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
                renderKnowledge();
            }
            if(tabId === 'quiz') {
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
                renderQuiz();
            }
            if(tabId === 'game') {
                document.querySelectorAll('.nav-btn')[2].classList.add('active');
                document.getElementById('game-start-overlay').classList.remove('hidden');
                document.querySelectorAll('.game-area').forEach(e => e.classList.add('hidden'));
                document.getElementById('game-area-timeline').classList.add('hidden');
                document.getElementById('game-area-match').classList.add('hidden');
                document.getElementById('game-area-boss').classList.add('hidden');
            }
        },

        finishSubLevel: () => {
            const qData = QUIZ_DB[state.currentSubLevelId] || [];
            const quizScore = state.quiz.score * 10;
            let gameScore = state.game.score;
            
            // For Boss level, game score is the main score
            if(state.currentSubLevelId === '1-5') {
                gameScore = state.game.score * 10; // 15 questions * 10
            }

            const total = state.currentSubLevelId === '1-5' ? gameScore : (quizScore + gameScore);
            
            // Badges
            const badgesEl = document.getElementById('badges');
            badgesEl.innerHTML = '';
            if (total >= 80) badgesEl.innerHTML += `<div style="text-align:center">üèÜ<br><small>‰ºòÁßÄ</small></div>`;
            if (state.currentSubLevelId === '1-5' && total >= 120) badgesEl.innerHTML += `<div style="text-align:center">üéñÔ∏è<br><small>‰∏ìÂÆ∂</small></div>`;

            document.getElementById('result-score').innerText = total;
            document.getElementById('result-msg').innerText = total >= 60 ? "ÊÅ≠ÂñúÈÄöÂÖ≥ÔºÅ" : "ËøòÈúÄË¶ÅÁªßÁª≠Âä™ÂäõÂì¶ÔºÅ";
            
            let stars = 0;
            if (total >= 60) stars = 1;
            if (total >= 80) stars = 2;
            if (total >= 90) stars = 3;
            
            const starsEl = document.getElementById('result-stars');
            starsEl.innerHTML = '';
            for(let i=0; i<3; i++) {
                starsEl.innerHTML += `<span class="star ${i < stars ? 'active' : 'inactive'}">‚òÖ</span>`;
            }

            // Unlock next
            if (total >= 60) {
                const subLevels = SUB_LEVELS[1];
                const currIdx = subLevels.findIndex(s => s.id === state.currentSubLevelId);
                if (currIdx < subLevels.length - 1) {
                    document.getElementById('result-msg').innerText += ` ‰∏ã‰∏ÄÂÖ≥Ôºö${subLevels[currIdx+1].title}`;
                } else {
                    document.getElementById('result-msg').innerText += " Á¨¨1Á´†ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ";
                    LEVELS[0].progress = 100;
                    LEVELS[0].stars = 3;
                    LEVELS[1].locked = false;
                }
            }

            router.go('result');
        },

        resetLevel: () => {
            levelManager.switchSubLevel(state.currentSubLevelId);
        }
    };

    // --- Render Functions ---
    function renderMap() {
        const grid = document.getElementById('level-grid');
        grid.innerHTML = '';
        let unlockedCount = 0;
        LEVELS.forEach((lvl, idx) => {
            if (!lvl.locked) unlockedCount++;
            const card = document.createElement('div');
            card.className = `level-card ${lvl.locked ? 'locked' : ''}`;
            card.onclick = () => levelManager.startLevel(idx);
            let starsHtml = '';
            for(let i=0; i<3; i++) starsHtml += `<span style="color:${i < lvl.stars ? '#fbbf24' : '#475569'}">‚òÖ</span>`;
            card.innerHTML = `
                <div class="level-header"><span class="level-num">LEVEL ${lvl.id}</span><div>${starsHtml}</div></div>
                <div class="level-title">${lvl.title}</div>
                <div class="level-info"><span>${lvl.subtitle}</span></div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${lvl.progress}%"></div></div>
                ${lvl.locked ? '<div style="margin-top:10px; font-size:0.8em;">üîí ÈúÄÂÆåÊàê‰∏ä‰∏ÄÂÖ≥Ëß£ÈîÅ</div>' : ''}
            `;
            grid.appendChild(card);
        });
        document.getElementById('levels-unlocked').innerText = `${unlockedCount}/${LEVELS.length}`;
    }

    function renderKnowledge() {
        const container = document.getElementById('knowledge-content');
        const data = KNOWLEDGE_DB[state.currentSubLevelId] || [];
        container.innerHTML = data.map(item => `
            <div class="info-card">
                <div class="info-header" onclick="this.nextElementSibling.classList.toggle('hidden')">
                    <div class="info-icon">${item.icon}</div>
                    <div class="info-title">${item.title}</div>
                    <div style="font-size:0.8em; color:var(--accent-color)">‚ñº</div>
                </div>
                <div class="info-details hidden">${item.desc}</div>
            </div>
        `).join('');
        if(container.firstChild) container.firstChild.querySelector('.info-details').classList.remove('hidden');
    }

    // --- Quiz Engine ---
    function renderQuiz(isBoss = false) {
        const qData = QUIZ_DB[state.currentSubLevelId] || [];
        const qIdx = state.quiz.currentIdx;
        const area = document.getElementById(isBoss ? 'boss-quiz-area' : 'quiz-area');

        if (!isBoss) {
            document.getElementById('quiz-progress').innerText = `${qIdx + 1}/${qData.length}`;
            document.getElementById('quiz-score').innerText = state.quiz.score * 10;
        }

        if (qIdx >= qData.length) {
            if(isBoss) {
                simulator.end(true);
                return;
            }
            state.quiz.completed = true;
            const currentSL = SUB_LEVELS[1].find(s => s.id === state.currentSubLevelId);
            area.innerHTML = `
                <div style="text-align:center; padding:40px;">
                    <h3>È¢òÁõÆÊåëÊàòÂÆåÊàêÔºÅ</h3>
                    <p style="margin:20px 0;">‰Ω†Á≠îÂØπ‰∫Ü ${state.quiz.score} / ${qData.length} È¢ò</p>
                    ${currentSL.hasSimulator ? 
                        `<button class="action-btn" onclick="levelManager.switchTab('game')">ËøõÂÖ•Ê®°ÊãüÂÆûÊàò ‚Üí</button>` : 
                        `<button class="action-btn" onclick="levelManager.finishSubLevel()">Êü•ÁúãÊàêÁª© ‚Üí</button>`
                    }
                </div>
            `;
            return;
        }

        const q = qData[qIdx];
        let inputHtml = '';

        if (q.type === 'sc') {
            inputHtml = `<div class="options-grid">
                ${q.options.map((opt, i) => `
                    <div class="option-btn" onclick="handleQuizAnswer(${i}, this, ${isBoss})">
                        <span>${["A", "B", "C", "D"][i]}. ${opt}</span>
                    </div>
                `).join('')}
            </div>`;
        } else if (q.type === 'tf') {
            inputHtml = `<div class="tf-container">
                <div class="tf-btn" onclick="handleTFAnswer(true, this, ${isBoss})">Ê≠£Á°Æ</div>
                <div class="tf-btn" onclick="handleTFAnswer(false, this, ${isBoss})">ÈîôËØØ</div>
            </div>`;
        } else if (q.type === 'mc') {
            inputHtml = `<div class="options-grid">
                ${q.options.map((opt, i) => `
                    <div class="option-btn" id="mc-opt-${i}" onclick="toggleMCSelection(${i})">
                        <span>${opt}</span>
                    </div>
                `).join('')}
            </div>
            <div style="margin-top:20px; text-align:center;">
                <button class="action-btn" onclick="submitMCAnswer(${isBoss})">Êèê‰∫§Á≠îÊ°à</button>
            </div>`;
        } else if (q.type === 'case') {
            inputHtml = `<div class="case-content"><strong>Ê°à‰æãÔºö</strong>${q.q}</div>
            <div class="question-text">${q.subQ}</div>
            <div class="options-grid">
                ${q.options.map((opt, i) => `
                    <div class="option-btn" onclick="handleQuizAnswer(${i}, this, ${isBoss})">
                        <span>${opt}</span>
                    </div>
                `).join('')}
            </div>`;
        }

        area.innerHTML = `
            <div class="question-card">
                <div class="question-text">${qIdx + 1}. ${q.type !== 'case' ? q.q : ''}</div>
                ${inputHtml}
                <div class="explanation" id="${isBoss ? 'boss-explanation' : 'explanation'}">
                    <strong>Ëß£ÊûêÔºö</strong> ${q.explanation}
                    <div style="margin-top:15px; text-align:right;">
                        <button class="action-btn" style="padding:5px 15px; font-size:0.9em;" onclick="nextQuestion(${isBoss})">‰∏ã‰∏ÄÈ¢ò</button>
                    </div>
                </div>
            </div>
        `;
    }

    window.handleQuizAnswer = (selectedIndex, btnElement, isBoss) => {
        const expId = isBoss ? 'boss-explanation' : 'explanation';
        if (document.getElementById(expId).classList.contains('show')) return;
        
        const q = QUIZ_DB[state.currentSubLevelId][state.quiz.currentIdx];
        const isCorrect = selectedIndex === q.answer;
        
        if (isCorrect) {
            btnElement.classList.add('correct');
            if(isBoss) state.game.score++; else state.quiz.score++;
        } else {
            btnElement.classList.add('wrong');
            const siblings = btnElement.parentElement.children;
            if(siblings[q.answer]) siblings[q.answer].classList.add('correct');
        }
        document.getElementById(expId).classList.add('show');
    };

    window.handleTFAnswer = (boolVal, btnElement, isBoss) => {
        const expId = isBoss ? 'boss-explanation' : 'explanation';
        if (document.getElementById(expId).classList.contains('show')) return;
        const q = QUIZ_DB[state.currentSubLevelId][state.quiz.currentIdx];
        const isCorrect = boolVal === q.answer;
        
        if(isCorrect) {
            btnElement.classList.add(boolVal ? 'active-true' : 'active-false');
            if(isBoss) state.game.score++; else state.quiz.score++;
        } else {
            btnElement.style.opacity = '0.5';
            const siblings = btnElement.parentElement.children;
            const correctBtn = boolVal ? siblings[1] : siblings[0];
            correctBtn.classList.add(!boolVal ? 'active-true' : 'active-false');
        }
        document.getElementById(expId).classList.add('show');
    };

    let mcSelection = [];
    window.toggleMCSelection = (idx) => {
        const btn = document.getElementById(`mc-opt-${idx}`);
        if(mcSelection.includes(idx)) {
            mcSelection = mcSelection.filter(i => i !== idx);
            btn.classList.remove('selected');
        } else {
            mcSelection.push(idx);
            btn.classList.add('selected');
        }
    };

    window.submitMCAnswer = (isBoss) => {
        const expId = isBoss ? 'boss-explanation' : 'explanation';
        if (document.getElementById(expId).classList.contains('show')) return;
        const q = QUIZ_DB[state.currentSubLevelId][state.quiz.currentIdx];
        const correct = q.answer.sort().toString() === mcSelection.sort().toString();
        
        mcSelection.forEach(idx => {
            const btn = document.getElementById(`mc-opt-${idx}`);
            if(q.answer.includes(idx)) btn.classList.add('correct');
            else btn.classList.add('wrong');
        });
        q.answer.forEach(idx => {
             const btn = document.getElementById(`mc-opt-${idx}`);
             if(!mcSelection.includes(idx)) btn.classList.add('correct');
        });

        if(correct) {
            if(isBoss) state.game.score++; else state.quiz.score++;
        }
        mcSelection = [];
        document.getElementById(expId).classList.add('show');
    };

    window.nextQuestion = (isBoss) => {
        state.quiz.currentIdx++;
        renderQuiz(isBoss);
    };

    // --- Simulator Engine ---
    const simulator = {
        start: () => {
            document.getElementById('game-start-overlay').classList.add('hidden');
            const subLevel = SUB_LEVELS[1].find(s => s.id === state.currentSubLevelId);
            const type = subLevel.gameType;

            state.game.active = true;
            state.game.score = 0;
            state.game.timer = GAME_DATA[state.currentSubLevelId]?.timeLimit || 60;
            
            clearInterval(state.game.timerInterval);
            state.game.timerInterval = setInterval(() => {
                state.game.timer--;
                document.getElementById('game-timer').innerText = state.game.timer;
                if(state.game.timer <= 0) simulator.end(false);
            }, 1000);

            if(type === 'drag') simulator.startDragGame();
            if(type === 'timeline') simulator.startTimelineGame();
            if(type === 'match') simulator.startMatchGame();
            if(type === 'boss') simulator.startBossGame();
        },

        // Type 1: Drag (1-1)
        startDragGame: () => {
            document.getElementById('game-area-drag').classList.remove('hidden');
            const data = GAME_DATA['1-1'];
            
            // Render Zones
            const zones = document.getElementById('game-zones');
            zones.innerHTML = data.zones.map(z => `
                <div class="drop-zone" id="zone-${z.id}" 
                     ondragover="simulator.allowDrop(event)" 
                     ondrop="simulator.drop(event, '${z.id}')">
                    <div class="zone-icon">${z.icon}</div>
                    <div class="zone-label">${z.label}</div>
                </div>
            `).join('');

            // Fill Pool
            const pool = document.getElementById('game-pool');
            pool.innerHTML = '';
            const deck = [...data.items].sort(() => 0.5 - Math.random());
            document.getElementById('game-remaining').innerText = deck.length;
            
            deck.forEach(item => {
                const card = document.createElement('div');
                card.className = 'game-card';
                card.draggable = true;
                card.id = `card-${item.id}`;
                card.dataset.type = item.type;
                card.innerHTML = `<strong>${item.name}</strong><br>${item.desc}`;
                card.ondragstart = (e) => {
                    e.dataTransfer.setData("text", item.id);
                    e.target.classList.add('dragging');
                };
                card.ondragend = (e) => e.target.classList.remove('dragging');
                pool.appendChild(card);
            });
        },

        allowDrop: (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); },

        drop: (e, zoneId) => {
            e.preventDefault();
            const zoneEl = document.getElementById(`zone-${zoneId}`);
            zoneEl.classList.remove('drag-over');
            const cardId = e.dataTransfer.getData("text");
            const cardEl = document.getElementById(`card-${cardId}`);
            if(!cardEl) return;

            if (cardEl.dataset.type === zoneId) {
                state.game.combo++;
                state.game.score += (10 + (state.game.combo > 1 ? state.game.combo * 2 : 0));
                zoneEl.classList.add('correct-flash');
                setTimeout(() => zoneEl.classList.remove('correct-flash'), 500);
                cardEl.remove();
                
                const remaining = document.getElementById('game-pool').children.length;
                document.getElementById('game-remaining').innerText = remaining;
                if(remaining === 0) simulator.end(true);
            } else {
                state.game.combo = 0;
                state.game.score = Math.max(0, state.game.score - 5);
                zoneEl.classList.add('wrong-flash');
                setTimeout(() => zoneEl.classList.remove('wrong-flash'), 500);
            }
            document.getElementById('game-score').innerText = state.game.score;
        },

        // Type 2: Timeline (1-3)
        startTimelineGame: () => {
            document.getElementById('game-area-timeline').classList.remove('hidden');
            const data = GAME_DATA['1-3'];
            state.game.timelineSlots = new Array(6).fill(null);

            // Render Slots
            const slotsContainer = document.getElementById('timeline-slots');
            slotsContainer.innerHTML = '';
            for(let i=0; i<6; i++) {
                const slot = document.createElement('div');
                slot.className = 'timeline-slot';
                slot.dataset.index = i;
                slot.innerHTML = `<span class="timeline-index">${i+1}</span><div class="slot-content" style="flex:1"></div>`;
                slot.ondragover = (e) => e.preventDefault();
                slot.ondrop = (e) => simulator.dropTimeline(e, i);
                slotsContainer.appendChild(slot);
            }

            // Render Items
            const pool = document.getElementById('timeline-pool');
            pool.innerHTML = '';
            const items = [...data.items].sort(() => 0.5 - Math.random());
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'timeline-item';
                el.draggable = true;
                el.id = `tl-item-${item.id}`;
                el.innerText = item.label;
                el.dataset.id = item.id;
                el.ondragstart = (e) => e.dataTransfer.setData("text", item.id);
                pool.appendChild(el);
            });
        },

        dropTimeline: (e, index) => {
            e.preventDefault();
            const itemId = e.dataTransfer.getData("text");
            const itemEl = document.getElementById(`tl-item-${itemId}`);
            if(!itemEl) return;

            // Remove from old slot if exists
            if(itemEl.parentElement.classList.contains('slot-content')) {
                const oldIdx = itemEl.parentElement.parentElement.dataset.index;
                state.game.timelineSlots[oldIdx] = null;
            }

            // Place in new slot
            const slotContent = e.currentTarget.querySelector('.slot-content');
            if(slotContent.children.length > 0) {
                document.getElementById('timeline-pool').appendChild(slotContent.children[0]);
            }
            slotContent.appendChild(itemEl);
            state.game.timelineSlots[index] = itemId;
        },

        checkTimeline: () => {
            const correctOrder = GAME_DATA['1-3'].correctOrder;
            let correctCount = 0;
            state.game.timelineSlots.forEach((id, idx) => {
                const slot = document.querySelectorAll('.timeline-slot')[idx];
                if(id === correctOrder[idx]) {
                    slot.style.borderColor = 'var(--success-color)';
                    correctCount++;
                } else {
                    slot.style.borderColor = 'var(--error-color)';
                }
            });

            if(correctCount === 6) {
                state.game.score = 100;
                simulator.end(true);
            } else {
                alert(`Âè™Êúâ ${correctCount} ‰∏™Ê≠£Á°ÆÔºåËØ∑Ë∞ÉÊï¥ÂêéÈáçËØïÔºÅ`);
            }
        },

        // Type 3: Match (1-4)
        startMatchGame: () => {
            document.getElementById('game-area-match').classList.remove('hidden');
            const data = GAME_DATA['1-4'];
            const leftCol = document.getElementById('match-left');
            const rightCol = document.getElementById('match-right');
            
            leftCol.innerHTML = '';
            rightCol.innerHTML = '';

            // Shuffle
            const pairs = data.pairs;
            const lefts = pairs.map(p => p.left).sort(() => 0.5 - Math.random());
            const rights = pairs.map(p => p.right).sort(() => 0.5 - Math.random());

            lefts.forEach(txt => {
                const btn = document.createElement('div');
                btn.className = 'match-btn';
                btn.innerText = txt;
                btn.onclick = () => simulator.selectMatch('left', txt, btn);
                leftCol.appendChild(btn);
            });

            rights.forEach(txt => {
                const btn = document.createElement('div');
                btn.className = 'match-btn';
                btn.innerText = txt;
                btn.onclick = () => simulator.selectMatch('right', txt, btn);
                rightCol.appendChild(btn);
            });
        },

        selectMatch: (side, value, el) => {
            if(el.classList.contains('matched')) return;
            
            // Clear previous selection on same side
            if(state.game.matchSelection[side]) {
                state.game.matchSelection[side].el.classList.remove('selected');
            }

            state.game.matchSelection[side] = { value, el };
            el.classList.add('selected');

            // Check match
            if(state.game.matchSelection.left && state.game.matchSelection.right) {
                simulator.checkMatch();
            }
        },

        checkMatch: () => {
            const left = state.game.matchSelection.left;
            const right = state.game.matchSelection.right;
            const pair = GAME_DATA['1-4'].pairs.find(p => p.left === left.value);
            
            if(pair && pair.right === right.value) {
                // Correct
                left.el.classList.add('matched');
                right.el.classList.add('matched');
                left.el.classList.remove('selected');
                right.el.classList.remove('selected');
                state.game.score += 20;
                state.game.completedCount++;
                
                if(state.game.completedCount === 5) simulator.end(true);
            } else {
                // Wrong
                left.el.classList.add('wrong');
                right.el.classList.add('wrong');
                setTimeout(() => {
                    left.el.classList.remove('wrong', 'selected');
                    right.el.classList.remove('wrong', 'selected');
                }, 500);
            }
            state.game.matchSelection = { left: null, right: null };
            document.getElementById('game-score').innerText = state.game.score;
        },

        // Type 4: Boss (1-5)
        startBossGame: () => {
            document.getElementById('game-area-boss').classList.remove('hidden');
            state.quiz.currentIdx = 0;
            state.quiz.score = 0; // used to count correct answers
            renderQuiz(true);
        },

        end: (success) => {
            clearInterval(state.game.timerInterval);
            state.game.active = false;
            
            if (success) {
                // For Boss level, check if pass requirement met
                if (state.currentSubLevelId === '1-5') {
                    if (state.game.score >= 12) { // 12/15
                        alert(`ÊåëÊàòÊàêÂäüÔºÅÁ≠îÂØπ ${state.game.score}/15 È¢ò`);
                        levelManager.finishSubLevel();
                    } else {
                        alert(`ÊåëÊàòÂ§±Ë¥•ÔºÅ‰ªÖÁ≠îÂØπ ${state.game.score} È¢òÔºåÈúÄË¶Å 12 È¢ò„ÄÇ`);
                        levelManager.switchTab('game');
                    }
                } else {
                    alert(`ÊåëÊàòÊàêÂäüÔºÅÂæóÂàÜÔºö${state.game.score}`);
                    levelManager.finishSubLevel();
                }
            } else {
                alert("Êó∂Èó¥Âà∞ÔºÅÊåëÊàòÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ");
                levelManager.switchTab('game');
            }
        }
    };

    // --- Init ---
    levelManager.init();

</script>
</body>
</html>