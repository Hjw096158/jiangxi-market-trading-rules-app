
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- 基础SEO信息 -->
    <title>蒙西电力市场交易规则闯关游戏 - DKFile - 免费HTML网页托管平台 | Free HTML Website Hosting</title>
    <meta name="description" content="一步步上手：中长期 现货 滚动撮合 阻塞盈余 分摊返还 风险防范 辅助服务等（含案例与计算器）。">
    <meta name="keywords" content="所有内容均为, 教学化简化模型, 用于理解规则逻辑与计算步骤, 风险点, 拆开学, 永远不迷路, DKFile, 免费网页托管, HTML托管, 静态网站托管, 网页发布, 免费建站">
    <meta name="author" content="xiaochu1235">
    <meta name="generator" content="DKFile - 免费HTML网页托管平台 | Free HTML Website Hosting">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    <meta name="rating" content="general">
    <meta name="revisit-after" content="7 days">
    <meta name="distribution" content="global">
    <meta name="language" content="zh-CN">
    <meta name="geo.region" content="CN">
    <meta name="geo.country" content="China">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#007bff">
    <meta name="msapplication-TileColor" content="#007bff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="蒙西电力市场交易规则闯关游戏">
    
    <!-- CSRF Token for AJAX requests -->
    <meta name="csrf-token" content="894259d73dd9cf0c57fcb948c9e4caab00dbadb3799536758a86b8e1ec498da0">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    
    <!-- 反馈弹窗样式 -->
    <style>
        #feedbackModal .modal-content {
            border-radius: 16px;
            overflow: hidden;
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        #feedbackModal .modal-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-bottom: none;
            padding: 1.5rem 1.5rem 1rem;
        }
        
        #feedbackModal .modal-header .btn-close {
            filter: invert(1);
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        #feedbackModal .modal-header .btn-close:hover {
            opacity: 1;
        }
        
        #feedbackModal .modal-title {
            color: white;
            font-weight: 600;
            font-size: 1.25rem;
        }
        
        #feedbackModal .modal-title i {
            color: rgba(255, 255, 255, 0.9);
        }
        
        #feedbackModal .modal-body {
            padding: 1.5rem;
        }
        
        #feedbackModal .modal-footer {
            padding: 1rem 1.5rem 1.5rem;
            border-top: none;
        }
        
        .feedback-type-btn {
            transition: all 0.3s ease;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .feedback-type-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .feedback-textarea {
            transition: border-color 0.3s ease;
        }
        
        .feedback-textarea:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        
        @media (max-width: 768px) {
            .feedback-type-btn {
                min-height: 40px;
                font-size: 0.85rem;
            }
        }
        
        /* 右下角浮动反馈按钮样式 */
        .floating-feedback-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            border: none;
            text-decoration: none;
        }
        
        .floating-feedback-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
            color: white;
            text-decoration: none;
        }
        
        .floating-feedback-btn:active {
            transform: translateY(0) scale(0.95);
        }
        
        .floating-feedback-btn i {
            font-size: 20px;
            margin-bottom: 2px;
        }
        
        .floating-btn-text {
            font-size: 10px;
            font-weight: 500;
            line-height: 1;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .floating-feedback-btn {
                bottom: 80px;
                right: 15px;
                width: 50px;
                height: 50px;
            }
            
            .floating-feedback-btn i {
                font-size: 18px;
            }
            
            .floating-btn-text {
                font-size: 9px;
            }
        }
        
        /* 手机端主菜单按钮样式 - 默认隐藏（桌面端不显示），手机端在媒体查询中显示 */
        /* 注意：手机端显示规则在 @media (max-width: 768px) 中定义 */
        @media (min-width: 769px) {
            #floatingMenuBtn,
            #dkfile-floating-buttons > #floatingMenuBtn,
            body > #dkfile-floating-buttons > #floatingMenuBtn,
            html > body > #dkfile-floating-buttons > #floatingMenuBtn,
            .floating-menu-btn {
                display: none !important;
            }
        }
        
        /* 手机端展开状态遮罩层 */
        #floatingButtonsOverlay,
        .floating-buttons-overlay {
            display: none;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.3) !important;
            z-index: 9999 !important;
            backdrop-filter: blur(2px) !important;
            pointer-events: none !important;
        }
        
        #floatingButtonsOverlay.active,
        .floating-buttons-overlay.active {
            display: block !important;
            pointer-events: auto !important;
        }
        
        /* 右下角固定浮层按钮组 - 优化版本 */
        /* 浮动按钮容器 - 使用最高优先级，防止用户覆盖 */
        body > .floating-action-buttons,
        html > body > .floating-action-buttons,
        body:last-child > .floating-action-buttons,
        .content-wrapper ~ .floating-action-buttons,
        #dkfile-floating-buttons {
            position: fixed !important;
            bottom: 80px !important;
            right: 20px !important;
            left: auto !important;
            top: auto !important;
            z-index: 10000 !important;
            display: flex !important;
            flex-direction: column-reverse !important;
            align-items: center !important;
            justify-content: flex-start !important;
            gap: 8px !important;
            margin: 0 !important;
            padding: 0 !important;
            width: auto !important;
            height: auto !important;
            transform: none !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }
        
        /* 平台标识按钮 - 集成到浮动按钮组下方，使用相同的fixed定位机制 */
        body > #dkfile-platform-footer-in-buttons,
        html > body > #dkfile-platform-footer-in-buttons,
        body:last-child > #dkfile-platform-footer-in-buttons,
        .content-wrapper ~ #dkfile-platform-footer-in-buttons,
        #dkfile-platform-footer-in-buttons {
            position: fixed !important;
            bottom: 10px !important;
            right: 20px !important;
            left: auto !important;
            top: auto !important;
            z-index: 10000 !important;
            display: flex !important;
            justify-content: flex-end !important;
            align-items: center !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            margin: 0 !important;
            padding: 6px 12px !important;
            width: auto !important;
            box-sizing: border-box !important;
            transform: none !important;
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(10px) !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            font-size: 11px !important;
            color: #666 !important;
            line-height: 1.4 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }
        
        #dkfile-platform-footer-in-buttons a {
            color: #28a745 !important;
            text-decoration: none !important;
            margin: 0 2px !important;
            transition: color 0.2s ease !important;
        }
        
        #dkfile-platform-footer-in-buttons a:hover {
            color: #218838 !important;
            text-decoration: underline !important;
        }
        
        @media (max-width: 768px) {
            /* 手机端隐藏平台标识，避免遮挡用户内容 - 使用 display: none 确保 SEO 友好（内容保留在 HTML 中） */
            /* 使用最高优先级选择器，确保覆盖内联样式 */
            html body #dkfile-platform-footer-in-buttons,
            html > body > #dkfile-platform-footer-in-buttons,
            body > #dkfile-platform-footer-in-buttons,
            body:last-child > #dkfile-platform-footer-in-buttons,
            .content-wrapper ~ #dkfile-platform-footer-in-buttons,
            #dkfile-platform-footer-in-buttons {
                display: none !important;
            }
        }
        
        /* 浮动按钮 - 使用ID选择器确保最高优先级，防止用户覆盖 */
        #dkfile-floating-buttons > .floating-btn,
        #dkfile-floating-buttons .floating-btn,
        body > #dkfile-floating-buttons > .floating-btn,
        html > body > #dkfile-floating-buttons > .floating-btn,
        body > .floating-action-buttons > .floating-btn,
        html > body > .floating-action-buttons > .floating-btn,
        .floating-action-buttons .floating-btn {
            width: 40px !important;
            height: 40px !important;
            min-width: 40px !important;
            min-height: 40px !important;
            max-width: 40px !important;
            max-height: 40px !important;
            border-radius: 10px !important;
            border: none !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px !important;
            color: white !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            position: relative !important;
            backdrop-filter: blur(10px) !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box !important;
            transform: none !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            overflow: visible !important;
        }
        
        /* 按钮标签样式 - 手机端展开时显示 */
        .floating-btn::after {
            content: attr(data-label);
            position: absolute;
            right: calc(100% + 12px);
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 10001;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            line-height: 1.4;
        }
        
        /* 手机端展开状态时显示标签 */
        @media (max-width: 768px) {
            .floating-action-buttons.expanded .floating-btn:not(.floating-menu-btn)::after,
            #dkfile-floating-buttons.expanded .floating-btn:not(.floating-menu-btn)::after {
                opacity: 1 !important;
                visibility: visible !important;
                pointer-events: auto !important;
            }
            
            /* 确保按钮容器在展开时有足够空间显示标签 */
            .floating-action-buttons.expanded,
            #dkfile-floating-buttons.expanded {
                align-items: center !important; /* 保持垂直居中对齐 */
                gap: 8px !important; /* 展开时恢复间距 */
            }
        }
        
        .floating-btn:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        }
        
        .floating-btn:active,
        .floating-btn:focus {
            transform: translateY(0) !important;
            outline: none !important;
            -webkit-tap-highlight-color: transparent !important;
        }
        
        .floating-btn.like-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }
        
        /* 已点赞状态 - 红色选中效果（行业通用：红色背景+白色实心图标） */
        #dkfile-floating-buttons .floating-btn.like-btn.liked,
        .floating-action-buttons .floating-btn.like-btn.liked,
        .floating-btn.like-btn.liked {
            background: #ff4757 !important;
            color: white !important;
        }
        
        #dkfile-floating-buttons .floating-btn.like-btn.liked i,
        .floating-action-buttons .floating-btn.like-btn.liked i,
        .floating-btn.like-btn.liked i {
            color: white !important;
        }
        
        .floating-btn.favorite-btn {
            background: linear-gradient(135deg, #20c997 0%, #28a745 100%) !important;
        }
        
        /* 已收藏状态 - 红色选中效果（行业通用：红色背景+白色实心图标） */
        #dkfile-floating-buttons .floating-btn.favorite-btn.favorited,
        .floating-action-buttons .floating-btn.favorite-btn.favorited,
        .floating-btn.favorite-btn.favorited {
            background: #ff4757 !important;
            color: white !important;
        }
        
        #dkfile-floating-buttons .floating-btn.favorite-btn.favorited i,
        .floating-action-buttons .floating-btn.favorite-btn.favorited i,
        .floating-btn.favorite-btn.favorited i {
            color: white !important;
        }
        
        .floating-btn.feedback-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }
        
        .floating-btn.share-btn {
            background: linear-gradient(135deg, #20c997 0%, #28a745 100%) !important;
        }
        
        .floating-btn.my-tools-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }
        
        /* 已登录状态 - 红色选中效果（类似已收藏） */
        #dkfile-floating-buttons .floating-btn.my-tools-btn.logged-in,
        .floating-action-buttons .floating-btn.my-tools-btn.logged-in,
        .floating-btn.my-tools-btn.logged-in {
            background: #ff4757 !important;
            color: white !important;
        }
        
        #dkfile-floating-buttons .floating-btn.my-tools-btn.logged-in i,
        .floating-action-buttons .floating-btn.my-tools-btn.logged-in i,
        .floating-btn.my-tools-btn.logged-in i {
            color: white !important;
        }
        
        /* 浮层弹窗样式 - 使用最高优先级确保不被用户内容覆盖 */
        #shareOverlay,
        #feedbackOverlay,
        .floating-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            backdrop-filter: blur(4px) !important;
            z-index: 2147483646 !important; /* 仅次于平台标识，确保最高优先级 */
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 20px !important;
            animation: fadeIn 0.3s ease !important;
            margin: 0 !important;
            pointer-events: auto !important;
        }
        
        /* 分享弹窗特殊保护 - 确保最高优先级 */
        #shareOverlay {
            z-index: 2147483646 !important;
        }
        
        #shareOverlay.floating-overlay {
            z-index: 2147483646 !important;
        }
        
        /* 确保分享弹窗面板也有最高优先级 */
        #shareOverlay .floating-panel,
        #shareOverlay .share-menu {
            position: relative !important;
            z-index: 2147483647 !important;
        }
        
        /* 二维码区域样式 */
        .qr-code-section {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 16px 0;
        }
        
        .qr-code-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100px;
            margin-bottom: 16px;
        }
        
        .qr-loading {
            color: #666;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .qr-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .qr-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .qr-action-btn.download-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        
        .qr-action-btn.download-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        .qr-action-btn.copy-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
        }
        
        .qr-action-btn.copy-btn:hover {
            background: linear-gradient(135deg, #5a6268 0%, #343a40 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }
        
        .qr-code-image {
            text-align: center;
        }
        
        .qr-code-text {
            margin-top: 8px;
            font-size: 0.8rem;
            color: #666;
        }
        
        .qr-error {
            color: #dc3545;
            font-size: 0.9rem;
        }
        
        /* 浮层面板样式 - 使用ID选择器确保最高优先级 */
        #shareOverlay .floating-panel,
        #feedbackOverlay .floating-panel,
        .floating-panel {
            background: white !important;
            border-radius: 20px !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            max-width: 500px !important;
            width: 100% !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
            animation: slideUp 0.3s ease !important;
            margin: 0 auto !important;
            position: relative !important;
            z-index: 2147483647 !important;
        }
        
        .floating-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 20px 10px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .floating-title {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .floating-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        
        .floating-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .floating-body {
            padding: 16px 20px;
            max-height: calc(90vh - 140px);
            overflow-y: auto;
            color: #333 !important; /* 确保文字颜色不被用户内容影响 */
        }
        
        /* 增强反馈弹窗样式隔离，防止用户内容影响 */
        #feedbackOverlay .floating-body,
        #feedbackOverlay .floating-body * {
            color: #333 !important;
        }
        
        #feedbackOverlay .floating-body label,
        #feedbackOverlay .floating-body .feedback-label,
        #feedbackOverlay .floating-body .feedback-section,
        #feedbackOverlay .floating-body .feedback-tool-info {
            color: #333 !important;
        }
        
        #feedbackOverlay .floating-body strong {
            color: #333 !important;
        }
        
        #feedbackOverlay .floating-body .text-muted {
            color: #6c757d !important;
        }
        
        .floating-footer {
            padding: 12px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #f0f0f0;
        }
        
        .floating-btn-action {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        
        .floating-btn-secondary {
            background: #f8f9fa;
            color: #666;
        }
        
        .floating-btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .floating-btn-primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .floating-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        /* 反馈表单样式 */
        .feedback-tool-info {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%);
            border: 1px solid rgba(40, 167, 69, 0.2);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 14px;
            font-size: 13px;
            color: #333;
            line-height: 1.4;
        }
        
        .feedback-section {
            margin-bottom: 14px;
        }
        
        .feedback-label {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
            display: block;
            color: #333;
        }
        
        .feedback-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 6px;
        }
        
        .feedback-type-item {
            position: relative;
        }
        
        .feedback-type-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .feedback-type-btn {
            display: block;
            width: 100%;
            padding: 6px 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            color: #666;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 500;
        }
        
        .feedback-type-input:checked + .feedback-type-btn {
            border-color: #28a745;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .feedback-type-btn:hover {
            border-color: #28a745;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }
        
        .feedback-textarea-wrapper {
            position: relative;
        }
        
        .feedback-textarea {
            width: 100%;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            line-height: 1.4;
            resize: none;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }
        
        .feedback-textarea:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }
        
        .feedback-char-count {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 12px;
            color: #999;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .feedback-hint {
            margin-top: 6px;
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }
        
        .feedback-notice {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }
        
        .feedback-link {
            color: #28a745;
            text-decoration: none;
            font-weight: 500;
        }
        
        .feedback-link:hover {
            text-decoration: underline;
        }
        
        /* 分享菜单样式 */
        .share-menu {
            background: white;
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15);
        }
        
        .share-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1a1a1a;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .share-subtitle {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 32px;
            font-weight: 400;
        }
        
        /* 分享渠道标题样式 */
        .share-channels-header {
            text-align: center;
            margin: 24px 0 16px 0;
        }
        
        .share-channels-title {
            color: #2c3e50;
            font-weight: 600;
            font-size: 1rem;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .share-channels-title i {
            color: #28a745;
            font-size: 1.1rem;
        }
        
        .share-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .share-buttons .share-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
            min-height: 36px;
        }
        
        .share-buttons .share-btn i {
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .share-buttons .share-btn span {
            white-space: nowrap;
        }
        

        
        .share-btn.x-twitter {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .share-btn.x-twitter:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        

        
        /* X 图标样式 */
        .x-icon-container {
            background: #000000;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            min-width: 18px;
            min-height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0;
            flex-shrink: 0;
        }
        
        .x-icon {
            color: white;
            width: 12px;
            height: 12px;
        }
        
        .share-btn.weibo {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .share-btn.weibo:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        

        
        
        /* GitHub 分享按钮 */
        .share-btn.github {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .share-btn.github:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        /* Reddit 分享按钮 */
        .share-btn.reddit {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .share-btn.reddit:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        /* LinkedIn 分享按钮 */
        .share-btn.linkedin {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .share-btn.linkedin:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        

        
        /* WhatsApp 分享按钮 */
        .share-btn.whatsapp {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .share-btn.whatsapp:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        /* Telegram 分享按钮 */
        .share-btn.telegram {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .share-btn.telegram:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        /* 微信分享按钮 */
        .share-btn.wechat {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .share-btn.wechat:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        /* QQ分享按钮 */
        .share-btn.qq {
            background: linear-gradient(135deg, #12B7F5 0%, #0084FF 100%);
            box-shadow: 0 4px 15px rgba(18, 183, 245, 0.3);
        }
        
        .share-btn.qq:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(18, 183, 245, 0.4);
        }
        
        .share-btn i {
            font-size: 12px;
        }
        
        .share-divider {
            margin: 16px 0 8px 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #e9ecef, transparent);
        }
        
        .share-close-section {
            text-align: center;
            padding: 4px 0;
        }
        
        .share-info {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.05) 0%, rgba(32, 201, 151, 0.05) 100%);
            border: 1px solid rgba(40, 167, 69, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: left;
        }
        
        .share-info-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .share-info-content {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
        }
        

        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        
        /* 响应式优化 */
        @media (max-width: 768px) {
            /* 浮动按钮样式已在上面统一定义，这里不再重复 */
            
            .share-channels-header {
                margin: 20px 0 12px 0;
            }
            
            .share-channels-title {
                font-size: 0.9rem;
            }
            
            .share-buttons {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
                padding: 12px;
            }
            
            .share-buttons .share-btn {
                padding: 6px 8px;
                font-size: 9px;
                gap: 4px;
                min-height: 32px;
            }
            
            .share-buttons .share-btn i {
                font-size: 10px;
            }
            
            .share-buttons .share-btn .x-icon-container {
                width: 14px;
                height: 14px;
                min-width: 14px;
                min-height: 14px;
            }
            
            .share-buttons .share-btn .x-icon {
                width: 10px;
                height: 10px;
            }
            
            .floating-overlay {
                padding: 10px;
            }
            
            .floating-panel {
                max-height: 95vh;
            }
            
            .floating-header {
                padding: 16px 20px 12px;
            }
            
            .floating-body {
                padding: 20px;
            }
            
            .floating-footer {
                padding: 16px 20px 20px;
            }
            
            .feedback-type-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .share-menu {
                padding: 24px;
                max-width: 90vw;
            }
            
            .share-title {
                font-size: 1.25rem;
            }
            
            .share-subtitle {
                font-size: 0.9rem;
                margin-bottom: 24px;
            }
            
            
            .share-info {
                padding: 12px;
                margin-bottom: 20px;
            }
            
            .share-close-section {
                padding: 2px 0;
            }
            
            .floating-btn-action {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
    </style>
    
    <!-- 性能优化 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="referrer" content="origin-when-cross-origin">
    
    <!-- DNS 预解析优化 -->
    <!-- <link rel="dns-prefetch" href="//www.googletagmanager.com"> -->
    <!-- <link rel="dns-prefetch" href="//pagead2.googlesyndication.com"> -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    
    <!-- 资源预连接 -->
    <!-- <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin> -->
    <!-- <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin> -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://deepseek.idoxu.com/xiaochu1235/mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian.html">
    <meta property="og:title" content="蒙西电力市场交易规则闯关游戏">
    <meta property="og:description" content="一步步上手：中长期 现货 滚动撮合 阻塞盈余 分摊返还 风险防范 辅助服务等（含案例与计算器）。">
    
    <meta property="og:image" content="http://deepseek.idoxu.com/static/dkfile-logo.png">
    
    <meta property="og:site_name" content="DKFile - 免费HTML网页托管平台 | Free HTML Website Hosting">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:updated_time" content="2026-01-12T15:35:00.833796">
    <meta property="article:author" content="xiaochu1235">
    <meta property="article:published_time" content="2026-01-12T15:35:00.833796">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="http://deepseek.idoxu.com/xiaochu1235/mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian.html">
    <meta property="twitter:title" content="蒙西电力市场交易规则闯关游戏">
    <meta property="twitter:description" content="一步步上手：中长期 现货 滚动撮合 阻塞盈余 分摊返还 风险防范 辅助服务等（含案例与计算器）。">
    
    <meta property="twitter:image" content="http://deepseek.idoxu.com/static/dkfile-logo.png">
    <meta property="twitter:image:alt" content="DKFile - 免费HTML网页托管平台 | Free HTML Website Hosting Logo">
    
    <meta property="twitter:creator" content="@xiaochu1235">
    <meta property="twitter:site" content="@DKFile">
    
    <!-- 结构化数据 -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "蒙西电力市场交易规则闯关游戏",
        "description": "一步步上手：中长期 现货 滚动撮合 阻塞盈余 分摊返还 风险防范 辅助服务等（含案例与计算器）。",
        "url": "http://deepseek.idoxu.com/xiaochu1235/mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian.html",
        "headline": "蒙西电力市场交易规则闯关游戏",
        "wordCount": 277,
        "author": {
            "@type": "Person",
            "name": "xiaochu1235",
            "url": "http://deepseek.idoxu.com/#user-xiaochu1235"
        },
        "publisher": {
            "@type": "Organization",
            "name": "DKFile - 免费HTML网页托管平台 | Free HTML Website Hosting",
            "url": "http://deepseek.idoxu.com/",
            "logo": {
                "@type": "ImageObject",
                "url": "http://deepseek.idoxu.com/static/dkfile-logo.png",
                "width": 200,
                "height": 200
            }
        },
        "datePublished": "2026-01-12T15:35:00.833796",
        "dateModified": "2026-01-12T15:35:00.833796",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http://deepseek.idoxu.com/xiaochu1235/mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian.html"
        },
        "isPartOf": {
            "@type": "WebSite",
            "name": "DKFile - 免费HTML网页托管平台 | Free HTML Website Hosting",
            "url": "http://deepseek.idoxu.com/",
            "description": "DKFile是专业的免费HTML网页托管平台，支持AI编程和DeepSeek代码生成。无需域名和服务器，手机上随时随地编程，一键上传HTML文件即可获得公网访问链接。DKFile为开发者、学生和设计师提供零门槛的网页发布服务，集成AI编程助手，让您的项目瞬间展示给全世界。"
        },
        "inLanguage": "zh-CN",
        "potentialAction": {
            "@type": "ReadAction",
            "target": "http://deepseek.idoxu.com/xiaochu1235/mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian.html"
        }
    }
    </script>
    
    <!-- 面包屑导航结构化数据 -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "DKFile - 免费HTML网页托管平台 | Free HTML Website Hosting",
                "item": "http://deepseek.idoxu.com/"
            },
            {
                "@type": "ListItem",
                "position": 2,
                "name": "xiaochu1235",
                "item": "http://deepseek.idoxu.com/#user-xiaochu1235"
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": "蒙西电力市场交易规则闯关游戏",
                "item": "http://deepseek.idoxu.com/xiaochu1235/mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian.html"
            }
        ]
    }
    </script>
    
    <!-- 网站图标 -->
    <link rel="icon" href="/static/dkfile-logo.png" type="image/png">
    <link rel="apple-touch-icon" href="/static/dkfile-logo.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/static/dkfile-logo.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/static/dkfile-logo.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/static/dkfile-logo.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/static/dkfile-logo.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/static/dkfile-logo.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/static/dkfile-logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/dkfile-logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/dkfile-logo.png">
    <link rel="shortcut icon" href="/static/dkfile-logo.png" type="image/png">
    
    <!-- 规范链接 -->
    <link rel="canonical" href="http://deepseek.idoxu.com/xiaochu1235/mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian.html">
    
    <!-- 平台链接 -->
    <link rel="alternate" type="text/html" href="http://deepseek.idoxu.com/" title="DKFile - 免费HTML网页托管平台 | Free HTML Website Hosting">
    
    <!-- 预加载关键资源 -->
    <link rel="preconnect" href="http://deepseek.idoxu.com/">
    
    <style>
        /* 平台标识内部样式 - 保留用于向后兼容（如果存在旧的平台标识元素） */
        #dkfile-platform-footer,
        .platform-footer {
            position: relative !important;
            bottom: auto !important;
            right: auto !important;
            left: auto !important;
            top: auto !important;
            padding: 8px 12px !important;
            background: transparent !important;
            display: flex !important;
            justify-content: flex-end !important;
            align-items: center !important;
            gap: 0 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            text-align: right !important;
            z-index: 2147483645 !important; /* 使用非常高的z-index，仅次于弹窗，确保不被用户内容遮挡 */
            margin: 0 !important; /* 移除margin，让容器控制对齐 */
            width: auto !important;
            max-width: none !important;
            min-width: auto !important;
            height: auto !important;
            min-height: auto !important;
            max-height: none !important;
            font-size: 12px !important;
            color: #999 !important;
            line-height: 1.5 !important;
            transform: none !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            overflow: visible !important;
            box-sizing: border-box !important;
            clear: both !important;
            float: none !important;
            flex-shrink: 0 !important; /* 防止被压缩 */
        }
        
        /* 防止用户内容覆盖平台标识样式 - 使用最高优先级 */
        .content-wrapper .platform-footer,
        .content-wrapper #dkfile-platform-footer,
        #dkfile-platform-footer,
        body > #dkfile-platform-footer,
        html > body > #dkfile-platform-footer,
        body > .platform-footer,
        html > body > .platform-footer,
        body:last-child > .platform-footer,
        body body ~ .platform-footer,
        .content-wrapper ~ .platform-footer,
        .content-wrapper ~ #dkfile-platform-footer,
        div.platform-footer,
        .platform-footer[class="platform-footer"] {
            position: relative !important;
            bottom: auto !important;
            right: auto !important;
            left: auto !important;
            top: auto !important;
            z-index: 2147483645 !important; /* 使用非常高的z-index，仅次于弹窗，确保不被用户内容遮挡 */
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            transform: none !important;
            margin: 20px 0 10px 0 !important;
            padding: 8px 12px !important;
            width: auto !important;
            max-width: none !important;
            justify-content: flex-end !important;
            text-align: right !important;
            align-items: center !important;
        }
        
        /* 平台标识文字样式 - 使用高优先级选择器防止用户覆盖 */
        #dkfile-platform-footer span,
        .content-wrapper #dkfile-platform-footer span,
        .platform-footer[id*="dkfile-platform-footer"] span {
            color: #999 !important;
            font-size: 12px !important;
            font-weight: 400 !important;
        }
        
        #dkfile-platform-footer a,
        .content-wrapper #dkfile-platform-footer a,
        .platform-footer[id*="dkfile-platform-footer"] a {
            color: #999 !important;
            text-decoration: none !important;
            font-weight: 400 !important;
            font-size: 12px !important;
            transition: color 0.2s ease !important;
            margin: 0 2px !important;
        }
        
        #dkfile-platform-footer a:hover,
        .content-wrapper #dkfile-platform-footer a:hover,
        .platform-footer[id*="dkfile-platform-footer"] a:hover {
            color: #666 !important;
        }
        
        #dkfile-platform-footer a:active,
        .content-wrapper #dkfile-platform-footer a:active,
        .platform-footer[id*="dkfile-platform-footer"] a:active {
            color: #999 !important;
        }
        
        /* 技术支持链接 - 智能配色：根据背景自动调整 */
        /* 采用现代UI设计规范，确保对比度和可访问性 */
        .platform-footer a.tech-support-link {
            /* 默认绿色，但会被JavaScript动态覆盖 */
            color: #28a745 !important;
            transition: color 0.3s ease !important;
        }
        
        .platform-footer a.tech-support-link:hover {
            /* hover颜色会在JavaScript中动态计算 */
            transition: color 0.3s ease !important;
        }
        
        .platform-footer a.tech-support-link:active {
            color: inherit !important;
        }
        
        /* 浅色背景模式 - 深色文字（专业配色方案） */
        /* 符合WCAG AA级对比度标准，确保良好的可读性 */
        .platform-footer.adaptive-light {
            color: #333 !important; /* 深灰色，在浅色背景上清晰易读 */
        }
        
        .platform-footer.adaptive-light span {
            color: #666 !important; /* 中等灰色，营造视觉层次 */
        }
        
        .platform-footer.adaptive-light a {
            color: #28a745 !important; /* 品牌绿色，保持一致性 */
        }
        
        .platform-footer.adaptive-light a.tech-support-link {
            color: #28a745 !important; /* 标准绿色，与品牌色一致 */
        }
        
        .platform-footer.adaptive-light a.tech-support-link:hover {
            color: #218838 !important; /* 深绿色hover状态，提供清晰反馈 */
        }
        
        /* 深色背景模式 - 浅色文字（专业配色方案） */
        .platform-footer.adaptive-dark {
            /* 使用柔和的白色，避免过强对比 */
            color: rgba(255, 255, 255, 0.85) !important;
        }
        
        .platform-footer.adaptive-dark span {
            /* 次要文字使用稍低的透明度，营造层次感 */
            color: rgba(255, 255, 255, 0.75) !important;
        }
        
        .platform-footer.adaptive-dark a {
            /* 链接文字保持较高的可读性 */
            color: rgba(255, 255, 255, 0.9) !important;
        }
        
        .platform-footer.adaptive-dark a.tech-support-link {
            /* 在深色背景上使用亮绿色，既醒目又与背景色调和谐 */
            color: #6ee7b7 !important; /* 柔和的亮绿色，符合现代UI设计规范 */
        }
        
        .platform-footer.adaptive-dark a.tech-support-link:hover {
            /* hover时使用更亮的绿色，提供清晰的交互反馈 */
            color: #a7f3d0 !important; /* 更亮的绿色，确保可访问性 */
        }
        
        /* 保留原有样式以兼容其他可能的引用 */
        .footer-brand a {
            color: #999;
            text-decoration: none;
            font-weight: 400;
            font-size: 13px;
            letter-spacing: 0.2px;
            transition: color 0.2s ease;
        }
        
        .footer-brand a:hover {
            color: #666;
        }
        
        .footer-divider {
            width: 1px;
            height: 14px;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .footer-support {
            position: relative;
        }
        
        .footer-support a {
            color: #999;
            text-decoration: none;
            font-size: 12px;
            font-weight: 400;
            padding: 0;
            background: transparent;
            border: none;
            transition: color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .footer-support a::before {
            content: "🛠️";
            font-size: 11px;
            opacity: 0.6;
        }
        
        .footer-support a:hover {
            color: #666;
        }
        
        .footer-support a:active {
            color: #999;
        }
        
        /* 我的收藏链接样式 */
        .footer-favorites a {
            color: #999;
            text-decoration: none;
            font-size: 12px;
            font-weight: 400;
            padding: 0;
            background: transparent;
            border: none;
            transition: color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .footer-favorites a::before {
            content: "❤️";
            font-size: 11px;
            opacity: 0.6;
        }
        
        .footer-favorites a:hover {
            color: #666;
        }
        
        .footer-favorites a:active {
            color: #999;
        }
        
        /* 覆盖base.html中的padding-bottom设置 */
        /* 注意：body的position不能是fixed或absolute，否则会影响子元素的fixed定位 */
        body {
            padding-bottom: 0 !important;
            overflow-x: visible !important;
            overflow-y: visible !important;
            /* 移除position: relative，避免影响fixed定位 */
            /* position: relative !important; */
        }
        
        /* 确保html标签不会阻止fixed定位 */
        html {
            overflow-x: visible !important;
            overflow-y: visible !important;
        }
        
        /* 样式隔离：确保平台标识在content-wrapper内部，固定在内容底部右下角 */
        /* 使用最高优先级选择器，防止用户代码覆盖 */
        .content-wrapper > #dkfile-platform-footer,
        .content-wrapper > .platform-footer,
        html > body > .content-wrapper > #dkfile-platform-footer,
        html > body > .content-wrapper > .platform-footer,
        body > .content-wrapper > #dkfile-platform-footer,
        body > .content-wrapper > .platform-footer {
            position: relative !important;
            bottom: auto !important;
            right: auto !important;
            left: auto !important;
            top: auto !important;
            z-index: 2147483645 !important; /* 使用非常高的z-index，仅次于弹窗，确保不被用户内容遮挡 */
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            transform: none !important;
            margin: 20px 0 10px 0 !important;
            padding: 8px 12px !important;
            width: auto !important;
            max-width: none !important;
            justify-content: flex-end !important;
            text-align: right !important;
            align-items: center !important;
        }
        
        /* 响应式设计 - 手机端 */
        @media (max-width: 768px) {
            .content-wrapper {
                padding-bottom: 50px;
            }
            
            /* 手机端浮动按钮容器 - 默认收起状态 */
            body > .floating-action-buttons,
            html > body > .floating-action-buttons,
            body:last-child > .floating-action-buttons,
            .content-wrapper ~ .floating-action-buttons,
            #dkfile-floating-buttons {
                bottom: 70px !important;
                right: 10px !important;
                left: auto !important;
                top: auto !important;
                gap: 0 !important; /* 收起时无间距 */
                flex-direction: column-reverse !important; /* 主菜单按钮在底部，展开时功能按钮在上方 */
                align-items: center !important; /* 确保所有按钮垂直居中对齐 */
                justify-content: flex-start !important;
            }
            
            /* 手机端主菜单按钮 - 显示（使用更高优先级选择器确保覆盖全局隐藏规则） */
            html body #floatingMenuBtn,
            html body #dkfile-floating-buttons > #floatingMenuBtn,
            html body body > #dkfile-floating-buttons > #floatingMenuBtn,
            html body html > body > #dkfile-floating-buttons > #floatingMenuBtn,
            html body .floating-menu-btn,
            #floatingMenuBtn,
            #dkfile-floating-buttons > #floatingMenuBtn,
            body > #dkfile-floating-buttons > #floatingMenuBtn,
            html > body > #dkfile-floating-buttons > #floatingMenuBtn,
            .floating-menu-btn {
                display: flex !important;
                width: 40px !important;
                height: 40px !important;
                min-width: 40px !important;
                min-height: 40px !important;
                max-width: 40px !important;
                max-height: 40px !important;
                aspect-ratio: 1 !important;
                border-radius: 50% !important;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
                border: none !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 18px !important;
                color: white !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4) !important;
                position: relative !important;
                z-index: 10001 !important;
                margin: 0 !important;
                padding: 0 !important;
                box-sizing: border-box !important;
                outline: none !important;
                -webkit-tap-highlight-color: transparent !important;
            }
            
            #floatingMenuBtn:hover,
            .floating-menu-btn:hover {
                transform: translateY(-1px) scale(1.05) !important;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.5) !important;
            }
            
            #floatingMenuBtn:active,
            #floatingMenuBtn:focus,
            .floating-menu-btn:active,
            .floating-menu-btn:focus {
                transform: translateY(0) rotate(45deg) !important;
                box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4) !important;
                outline: none !important;
                -webkit-tap-highlight-color: transparent !important;
            }
            
            #floatingMenuBtn.active,
            .floating-menu-btn.active {
                transform: rotate(45deg) !important;
                background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%) !important;
                box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4) !important;
            }
            
            /* 手机端功能按钮 - 默认隐藏 */
            #dkfile-floating-buttons > .floating-btn:not(.floating-menu-btn),
            #dkfile-floating-buttons .floating-btn:not(.floating-menu-btn),
            body > #dkfile-floating-buttons > .floating-btn:not(.floating-menu-btn),
            html > body > #dkfile-floating-buttons > .floating-btn:not(.floating-menu-btn),
            body > .floating-action-buttons > .floating-btn:not(.floating-menu-btn),
            html > body > .floating-action-buttons > .floating-btn:not(.floating-menu-btn),
            .floating-action-buttons .floating-btn:not(.floating-menu-btn) {
                width: 40px !important;
                height: 40px !important;
                min-width: 40px !important;
                min-height: 40px !important;
                max-width: 40px !important;
                max-height: 40px !important;
                font-size: 14px !important;
                opacity: 0 !important;
                visibility: hidden !important;
                transform: translateY(20px) scale(0.5) !important;
                pointer-events: none !important;
                transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
            }
            
            /* 手机端功能按钮 - 展开状态 */
            .floating-action-buttons.expanded > .floating-btn:not(.floating-menu-btn),
            #dkfile-floating-buttons.expanded > .floating-btn:not(.floating-menu-btn) {
                opacity: 1 !important;
                visibility: visible !important;
                transform: translateY(0) scale(1) !important;
                pointer-events: auto !important;
            }
            
            /* 展开时按钮间距 */
            .floating-action-buttons.expanded,
            #dkfile-floating-buttons.expanded {
                gap: 8px !important;
                align-items: flex-end !important;
            }
            
            /* 按钮展开动画延迟 */
            .floating-action-buttons.expanded > .floating-btn:nth-child(2),
            #dkfile-floating-buttons.expanded > .floating-btn:nth-child(2) {
                transition-delay: 0.05s !important;
            }
            
            .floating-action-buttons.expanded > .floating-btn:nth-child(3),
            #dkfile-floating-buttons.expanded > .floating-btn:nth-child(3) {
                transition-delay: 0.1s !important;
            }
            
            .floating-action-buttons.expanded > .floating-btn:nth-child(4),
            #dkfile-floating-buttons.expanded > .floating-btn:nth-child(4) {
                transition-delay: 0.15s !important;
            }
            
            .floating-action-buttons.expanded > .floating-btn:nth-child(5),
            #dkfile-floating-buttons.expanded > .floating-btn:nth-child(5) {
                transition-delay: 0.2s !important;
            }
            
            .floating-action-buttons.expanded > .floating-btn:nth-child(6),
            #dkfile-floating-buttons.expanded > .floating-btn:nth-child(6) {
                transition-delay: 0.25s !important;
            }
        }
        
        /* PC端隐藏主菜单按钮 */
        @media (min-width: 769px) {
            #floatingMenuBtn,
            #dkfile-floating-buttons > #floatingMenuBtn,
            body > #dkfile-floating-buttons > #floatingMenuBtn,
            html > body > #dkfile-floating-buttons > #floatingMenuBtn,
            .floating-menu-btn {
                display: none !important;
            }
            
            /* PC端始终显示所有功能按钮 */
            #dkfile-floating-buttons > .floating-btn:not(.floating-menu-btn),
            #dkfile-floating-buttons .floating-btn:not(.floating-menu-btn) {
                opacity: 1 !important;
                visibility: visible !important;
                transform: scale(1) translateY(0) !important;
                pointer-events: auto !important;
            }
        }
        
        @media (max-width: 768px) {
            
            #dkfile-floating-buttons > .floating-btn,
            #dkfile-floating-buttons .floating-btn,
            body > #dkfile-floating-buttons > .floating-btn,
            html > body > #dkfile-floating-buttons > .floating-btn,
            body > .floating-action-buttons > .floating-btn,
            html > body > .floating-action-buttons > .floating-btn,
            .floating-action-buttons .floating-btn {
                width: 36px !important;
                height: 36px !important;
                min-width: 36px !important;
                min-height: 36px !important;
                max-width: 36px !important;
                max-height: 36px !important;
                font-size: 12px !important;
            }
            
            /* 手机端已点赞和已收藏状态 - 红色选中效果 */
            #dkfile-floating-buttons .floating-btn.like-btn.liked,
            .floating-action-buttons .floating-btn.like-btn.liked {
                background: #ff4757 !important;
                color: white !important;
            }
            
            #dkfile-floating-buttons .floating-btn.like-btn.liked i,
            .floating-action-buttons .floating-btn.like-btn.liked i {
                color: white !important;
            }
            
            #dkfile-floating-buttons .floating-btn.favorite-btn.favorited,
            .floating-action-buttons .floating-btn.favorite-btn.favorited {
                background: #ff4757 !important;
                color: white !important;
            }
            
            #dkfile-floating-buttons .floating-btn.favorite-btn.favorited i,
            .floating-action-buttons .floating-btn.favorite-btn.favorited i {
                color: white !important;
            }
            
            .platform-footer span {
                font-size: 11px;
            }
            
            .platform-footer a {
                font-size: 11px;
            }
            
            .footer-brand a {
                font-size: 12px;
            }
            
            .footer-support a {
                font-size: 11px;
                gap: 3px;
            }
            
            .footer-support a::before {
                font-size: 10px;
            }
            
            .footer-favorites a {
                font-size: 11px;
                gap: 3px;
            }
            
            .footer-favorites a::before {
                font-size: 10px;
            }
        }
        
        /* 功能按钮样式 */
        .action-buttons-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .action-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        .action-btn i {
            font-size: 16px;
            margin-bottom: 3px;
        }
        
        .action-btn .btn-text {
            font-size: 9px;
            font-weight: 600;
            line-height: 1;
        }
        
        .like-btn {
            color: #ff4757;
            background: rgba(255, 71, 87, 0.05);
        }
        
        .like-btn:hover {
            background: rgba(255, 71, 87, 0.1);
            color: #ff4757;
        }
        
        .like-btn.liked {
            background: #ff4757;
            color: white;
        }
        
        .favorite-btn {
            color: #ffa502;
            background: rgba(255, 165, 2, 0.05);
        }
        
        .favorite-btn:hover {
            background: rgba(255, 165, 2, 0.1);
            color: #ffa502;
        }
        
        .favorite-btn.favorited {
            background: #ffa502;
            color: white;
        }
        
        .share-buttons .share-btn {
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        
        .share-buttons .share-btn:hover {
            transform: translateY(-2px);
            background: rgba(40, 167, 69, 0.2);
        }
        
        .feedback-btn {
            color: #a55eea;
            background: rgba(165, 94, 234, 0.05);
        }
        
        .feedback-btn:hover {
            background: rgba(165, 94, 234, 0.1);
            color: #a55eea;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .action-buttons-container {
                bottom: 100px;
                right: 15px;
            }
            
            .action-btn {
                width: 38px;
                height: 38px;
            }
            
            .action-btn i {
                font-size: 14px;
            }
            
            .action-btn .btn-text {
                font-size: 8px;
            }
        }
        

        

    </style>
    
    <!-- 关键数据初始化 - 在用户内容加载前初始化，确保即使用户内容有错误也能正常工作 -->
    
    <script>
        // 在head中初始化pageData，确保即使用户内容有错误也能正常工作
        try {
            window.pageData = {"author": "xiaochu1235", "fileId": 18959, "fileName": "mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian.html", "projectName": "mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian"};
            window.currentUserAuthenticated = false;
        } catch (error) {
            window.pageData = window.pageData || {};
            window.currentUserAuthenticated = window.currentUserAuthenticated || false;
        }
    </script>
    
    <!-- 关键函数定义 - 在用户内容加载前定义，防止被覆盖 -->
    <!-- 使用独立的script标签和错误隔离，确保即使用户内容有错误，平台功能也能正常工作 -->
    <script>
        // 使用立即执行函数表达式（IIFE）和错误隔离，保护平台关键功能
        (function() {
            'use strict';
            
            // 定义基础工具函数（在用户内容加载前就可用）
            window.logClick = window.logClick || function(type) {
                try {
                    // 实际的日志记录会在页面加载完成后实现
                } catch (e) {
                    // 静默处理错误
                }
            };
            
            window.showToast = window.showToast || function(message) {
                try {
                    const toast = document.createElement('div');
                    toast.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.9); color: white; padding: 12px 24px; border-radius: 8px; z-index: 9999999999; font-size: 14px; font-weight: 500; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); pointer-events: auto;';
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                } catch (e) {
                    console.error('Toast显示失败:', e);
                    alert(message);
                }
            };
            
            // 定义关键函数的完整实现（在用户内容加载前就定义好）
            // 这样即使用户内容有语法错误，这些函数也能正常工作
            window.handleLike = function() {
                try {
                    logClick('like_click');
                    
                    // 检查是否登录（优先使用window上的变量）
                    const isAuthenticated = typeof window.currentUserAuthenticated !== 'undefined' 
                        ? window.currentUserAuthenticated 
                        : (typeof currentUserAuthenticated !== 'undefined' ? currentUserAuthenticated : false);
                    
                    if (!isAuthenticated) {
                        showToast('请先登录后再点赞');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 1500);
                        return;
                    }
                    
                    // 获取文件ID（优先使用head中初始化的pageData）
                    const getFileId = function() {
                        // 优先使用全局pageData（已在head中初始化）
                        if (typeof window.pageData !== 'undefined' && window.pageData && window.pageData.fileId) {
                            return window.pageData.fileId;
                        }
                        // 兼容旧版本（如果pageData不在window上）
                        if (typeof pageData !== 'undefined' && pageData && pageData.fileId) {
                            return pageData.fileId;
                        }
                        // 尝试使用getValidPageData函数（如果存在）
                        if (typeof getValidPageData === 'function') {
                            try {
                                const validData = getValidPageData();
                                if (validData && validData.fileId) {
                                    return validData.fileId;
                                }
                            } catch (e) {
                                // 静默处理错误
                            }
                        }
                        // 尝试从URL解析（作为最后手段）
                        try {
                            const pathParts = window.location.pathname.split('/').filter(p => p);
                            if (pathParts.length >= 2) {
                                // 格式: /username/filename.html
                                // 需要通过API获取文件ID，这里先返回null
                                return null;
                            }
                        } catch (e) {
                            // 静默处理错误
                        }
                        return null;
                    };
                    
                    const fileId = getFileId();
                    if (!fileId) {
                        showToast('文件信息异常，无法执行点赞操作');
                        return;
                    }
                    
                    fetch('/api/like', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_id: fileId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const likeBtn = document.querySelector('.floating-btn.like-btn');
                            if (likeBtn) {
                                if (data.action === 'liked') {
                                    likeBtn.classList.add('liked');
                                    likeBtn.innerHTML = '<i class="bi bi-heart-fill"></i>';
                                } else {
                                    likeBtn.classList.remove('liked');
                                    likeBtn.innerHTML = '<i class="bi bi-heart"></i>';
                                }
                            }
                            showToast(data.message);
                        } else {
                            showToast('操作失败：' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('点赞请求失败:', error);
                        showToast('操作失败，请稍后重试');
                    });
                } catch (error) {
                    console.error('handleLike执行错误:', error);
                    showToast('点赞功能暂时不可用，请刷新页面重试');
                }
            };
            
            window.handleFavorite = function() {
                try {
                    logClick('favorite_click');
                    
                    // 检查是否登录（优先使用window上的变量）
                    const isAuthenticated = typeof window.currentUserAuthenticated !== 'undefined' 
                        ? window.currentUserAuthenticated 
                        : (typeof currentUserAuthenticated !== 'undefined' ? currentUserAuthenticated : false);
                    
                    if (!isAuthenticated) {
                        showToast('请先登录后再收藏');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 1500);
                        return;
                    }
                    
                    const getFileId = function() {
                        // 优先使用全局pageData（已在head中初始化）
                        if (typeof window.pageData !== 'undefined' && window.pageData && window.pageData.fileId) {
                            return window.pageData.fileId;
                        }
                        // 兼容旧版本（如果pageData不在window上）
                        if (typeof pageData !== 'undefined' && pageData && pageData.fileId) {
                            return pageData.fileId;
                        }
                        // 尝试使用getValidPageData函数（如果存在）
                        if (typeof getValidPageData === 'function') {
                            try {
                                const validData = getValidPageData();
                                if (validData && validData.fileId) {
                                    return validData.fileId;
                                }
                            } catch (e) {
                                // 静默处理错误
                            }
                        }
                        return null;
                    };
                    
                    const fileId = getFileId();
                    if (!fileId) {
                        showToast('文件信息异常，无法执行收藏操作');
                        return;
                    }
                    
                    fetch('/api/favorite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_id: fileId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const favoriteBtn = document.querySelector('.floating-btn.favorite-btn');
                            if (favoriteBtn) {
                                if (data.action === 'favorited') {
                                    favoriteBtn.classList.add('favorited');
                                    favoriteBtn.innerHTML = '<i class="bi bi-bookmark-fill"></i>';
                                } else {
                                    favoriteBtn.classList.remove('favorited');
                                    favoriteBtn.innerHTML = '<i class="bi bi-bookmark"></i>';
                                }
                            }
                            showToast(data.message);
                        } else {
                            showToast('操作失败：' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('收藏请求失败:', error);
                        showToast('操作失败，请稍后重试');
                    });
                } catch (error) {
                    console.error('handleFavorite执行错误:', error);
                    showToast('收藏功能暂时不可用，请刷新页面重试');
                }
            };
            
            window.handleFeedback = function() {
                try {
                    logClick('feedback_click');
                    const feedbackBtn = document.querySelector('.floating-btn.feedback-btn');
                    if (feedbackBtn) {
                        feedbackBtn.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            feedbackBtn.style.transform = '';
                        }, 150);
                    }
                    const feedbackOverlay = document.getElementById('feedbackOverlay');
                    if (feedbackOverlay) {
                        // 强制设置最高优先级样式（与分享弹窗一致）
                        feedbackOverlay.style.setProperty('display', 'flex', 'important');
                        feedbackOverlay.style.setProperty('z-index', '2147483646', 'important');
                        feedbackOverlay.style.setProperty('position', 'fixed', 'important');
                        feedbackOverlay.style.setProperty('pointer-events', 'auto', 'important');
                        feedbackOverlay.style.setProperty('visibility', 'visible', 'important');
                        feedbackOverlay.style.setProperty('opacity', '1', 'important');
                        feedbackOverlay.style.setProperty('top', '0', 'important');
                        feedbackOverlay.style.setProperty('left', '0', 'important');
                        feedbackOverlay.style.setProperty('right', '0', 'important');
                        feedbackOverlay.style.setProperty('bottom', '0', 'important');
                        document.body.style.overflow = 'hidden';
                        
                        // 确保反馈弹窗内的面板也可见
                        const feedbackPanel = feedbackOverlay.querySelector('.floating-panel');
                        if (feedbackPanel) {
                            feedbackPanel.style.setProperty('display', 'block', 'important');
                            feedbackPanel.style.setProperty('z-index', '2147483647', 'important');
                            feedbackPanel.style.setProperty('position', 'relative', 'important');
                            feedbackPanel.style.setProperty('visibility', 'visible', 'important');
                            feedbackPanel.style.setProperty('opacity', '1', 'important');
                        }
                        
                    } else {
                        showToast('反馈功能暂时不可用，请刷新页面重试');
                    }
                } catch (error) {
                    console.error('handleFeedback执行错误:', error);
                    showToast('反馈功能暂时不可用，请刷新页面重试');
                }
            };
            
            // 关闭反馈浮层 - 在head中定义，确保即使用户内容有错误也能正常工作
            window.closeFeedback = function() {
                try {
                    const feedbackOverlay = document.getElementById('feedbackOverlay');
                    if (feedbackOverlay) {
                        feedbackOverlay.style.setProperty('display', 'none', 'important');
                        document.body.style.overflow = '';
                    } else {
                    }
                } catch (error) {
                    // 即使出错，也尝试恢复body的overflow
                    try {
                        document.body.style.overflow = '';
                    } catch (e) {
                    }
                }
            };
            
            window.handleShare = function() {
                try {
                    logClick('share_click');
                    
                    // 不修改用户内容，只显示平台分享弹窗
                    
                    const shareBtn = document.querySelector('.floating-btn.share-btn');
                    if (shareBtn) {
                        shareBtn.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            shareBtn.style.transform = '';
                        }, 150);
                    }
                    
                    const shareOverlay = document.getElementById('shareOverlay');
                    if (shareOverlay) {
                        // 强制设置最高优先级样式（立即执行）
                        shareOverlay.style.setProperty('display', 'flex', 'important');
                        shareOverlay.style.setProperty('z-index', '2147483646', 'important');
                        shareOverlay.style.setProperty('position', 'fixed', 'important');
                        shareOverlay.style.setProperty('pointer-events', 'auto', 'important');
                        shareOverlay.style.setProperty('visibility', 'visible', 'important');
                        shareOverlay.style.setProperty('opacity', '1', 'important');
                        shareOverlay.style.setProperty('top', '0', 'important');
                        shareOverlay.style.setProperty('left', '0', 'important');
                        shareOverlay.style.setProperty('right', '0', 'important');
                        shareOverlay.style.setProperty('bottom', '0', 'important');
                        document.body.style.overflow = 'hidden';
                        
                        // 确保分享弹窗内的所有元素也可见
                        const sharePanel = shareOverlay.querySelector('.floating-panel');
                        if (sharePanel) {
                            sharePanel.style.setProperty('display', 'block', 'important');
                            sharePanel.style.setProperty('z-index', '2147483647', 'important');
                            sharePanel.style.setProperty('position', 'relative', 'important');
                            sharePanel.style.setProperty('visibility', 'visible', 'important');
                            sharePanel.style.setProperty('opacity', '1', 'important');
                        }
                        
                        const shareMenu = shareOverlay.querySelector('.share-menu');
                        if (shareMenu) {
                            shareMenu.style.setProperty('display', 'block', 'important');
                            shareMenu.style.setProperty('z-index', '2147483647', 'important');
                        }
                        
                        // 验证弹窗是否真的可见
                        setTimeout(() => {
                            const computedStyle = window.getComputedStyle(shareOverlay);

                            if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {

                                shareOverlay.style.setProperty('display', 'flex', 'important');
                                shareOverlay.style.setProperty('visibility', 'visible', 'important');
                            }
                        }, 100);

                        // 生成二维码（如果函数存在）
                        if (typeof window.generateShareQRCode === 'function') {
                            window.generateShareQRCode();
                        }
                    } else {

                        showToast('分享功能暂时不可用，请刷新页面重试');
                    }
                } catch (error) {
                    console.error('handleShare执行错误:', error);
                    showToast('分享功能暂时不可用，请刷新页面重试');
                }
            };
            
            // 关闭分享浮层 - 在head中定义
            window.closeShare = function() {
                try {

                    const shareOverlay = document.getElementById('shareOverlay');
                    if (shareOverlay) {
                        shareOverlay.style.setProperty('display', 'none', 'important');
                        document.body.style.overflow = '';
                    }
                    
                    // 不修改用户内容，只关闭平台分享弹窗
                } catch (error) {

                    try {
                        document.body.style.overflow = '';
                    } catch (e) {
                        // 忽略
                    }
                }
            };
            
            // 生成分享二维码 - 在head中定义
            window.generateShareQRCode = function() {
                try {

                    const qrContainer = document.getElementById('shareQrCode');
                    if (!qrContainer) {

                        return;
                    }
                    
                    const currentUrl = window.location.href;
                    
                    // 获取微信域名配置并替换URL
                    fetch('/api/wechat-domain')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`获取微信域名配置失败: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            let qrUrl = currentUrl;
                            
                            // 如果配置了微信域名，则替换当前URL的域名部分
                            if (data.success && data.domain && data.domain.trim()) {
                                try {
                                    const wechatDomain = data.domain.trim();
                                    // 确保域名以 https:// 开头
                                    const domain = wechatDomain.startsWith('http') ? wechatDomain : `https://${wechatDomain}`;
                                    // 移除末尾的斜杠
                                    const cleanDomain = domain.replace(/\/$/, '');
                                    
                                    // 获取当前URL的路径部分（包括查询参数和哈希）
                                    const currentUrlObj = new URL(currentUrl);
                                    const pathWithQuery = currentUrlObj.pathname + currentUrlObj.search + currentUrlObj.hash;
                                    
                                    // 构建微信域名URL
                                    qrUrl = cleanDomain + pathWithQuery;
                                } catch (e) {
                                    console.error('替换微信域名失败:', e);
                                    // 如果替换失败，使用原始URL
                                    qrUrl = currentUrl;
                                }
                            }
                            
                            const apiUrl = `/api/qrcode?content=${encodeURIComponent(qrUrl)}&type=url&size=200&margin=2`;
                            
                            return fetch(apiUrl);
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`网络请求失败: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                qrContainer.innerHTML = `
                                    <div class="qr-code-image">
                                        <img src="${data.data}" alt="分享二维码" id="qrCodeImage" style="width: 120px; height: 120px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                    </div>
                                `;
                            } else {
                                throw new Error(data.error || '二维码生成失败');
                            }
                        })
                        .catch(error => {
                            console.error('获取微信域名配置或生成二维码失败，使用原始URL重试:', error);
                            // 如果获取配置失败，使用原始URL生成二维码
                            const apiUrl = `/api/qrcode?content=${encodeURIComponent(currentUrl)}&type=url&size=200&margin=2`;
                            return fetch(apiUrl)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`网络请求失败: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (data.success) {
                                        qrContainer.innerHTML = `
                                            <div class="qr-code-image">
                                                <img src="${data.data}" alt="分享二维码" id="qrCodeImage" style="width: 120px; height: 120px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                            </div>
                                        `;
                                    } else {
                                        throw new Error(data.error || '二维码生成失败');
                                    }
                                })
                                .catch(secondError => {
                                    console.error('二维码生成失败:', secondError);
                                    qrContainer.innerHTML = `
                                        <div class="qr-error text-center text-muted">
                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                            <small>二维码生成失败</small>
                                        </div>
                                    `;
                                });
                        });
                } catch (error) {
                    console.error('生成分享二维码失败:', error);
                }
            };
            
            // 分享到微博 - 在head中定义
            window.shareToWeibo = function() {
                try {
                    const url = window.location.href;
                    const title = document.title;
                    const weiboUrl = `https://service.weibo.com/share/share.php?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
                    window.open(weiboUrl, '_blank', 'width=600,height=400');
                    if (typeof window.closeShare === 'function') {
                        window.closeShare();
                    }
                } catch (error) {

                }
            };
            
            // 分享到GitHub - 在head中定义
            window.shareToGithub = function() {
                try {
                    const url = window.location.href;
                    const title = document.title;
                    const projectName = (window.pageData && window.pageData.projectName) || '工具';
                    const shareText = `Check out this awesome tool: ${projectName} - ${title}`;
                    const githubUrl = `https://github.com/new?description=${encodeURIComponent(shareText)}&filename=${encodeURIComponent(projectName)}.md`;
                    window.open(githubUrl, '_blank', 'width=800,height=600');
                    if (typeof window.closeShare === 'function') {
                        window.closeShare();
                    }
                } catch (error) {

                }
            };
            
            // 分享到Reddit - 在head中定义
            window.shareToReddit = function() {
                try {
                    const url = window.location.href;
                    const title = document.title;
                    const redditUrl = `https://reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
                    window.open(redditUrl, '_blank', 'width=600,height=500');
                    if (typeof window.closeShare === 'function') {
                        window.closeShare();
                    }
                } catch (error) {

                }
            };
            
            // 分享到LinkedIn - 在head中定义
            window.shareToLinkedIn = function() {
                try {
                    const url = window.location.href;
                    const title = document.title;
                    const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
                    window.open(linkedinUrl, '_blank', 'width=600,height=500');
                    if (typeof window.closeShare === 'function') {
                        window.closeShare();
                    }
                } catch (error) {

                }
            };
            
            // 分享到WhatsApp - 在head中定义
            window.shareToWhatsApp = function() {
                try {
                    const url = window.location.href;
                    const title = document.title;
                    const projectName = (window.pageData && window.pageData.projectName) || '工具';
                    const shareText = `${projectName} - ${title}\n\n${url}`;
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
                    window.open(whatsappUrl, '_blank', 'width=400,height=600');
                    if (typeof window.closeShare === 'function') {
                        window.closeShare();
                    }
                } catch (error) {

                }
            };
            
            // 分享到Telegram - 在head中定义
            window.shareToTelegram = function() {
                try {
                    const url = window.location.href;
                    const title = document.title;
                    const projectName = (window.pageData && window.pageData.projectName) || '工具';
                    const shareText = `${projectName} - ${title}\n\n${url}`;
                    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(shareText)}`;
                    window.open(telegramUrl, '_blank', 'width=400,height=600');
                    if (typeof window.closeShare === 'function') {
                        window.closeShare();
                    }
                } catch (error) {

                }
            };
            
            // 分享到微信 - 在head中定义
            window.shareToWeChat = function() {
                try {
                    const currentUrl = window.location.href;
                    const title = document.title;
                    const projectName = (window.pageData && window.pageData.projectName) || '工具';
                    
                    // 获取微信域名配置
                    fetch('/api/wechat-domain')
                        .then(response => response.json())
                        .then(data => {
                            let shareUrl = currentUrl;
                            
                            // 如果配置了微信域名，则替换当前URL的域名部分
                            if (data.success && data.domain && data.domain.trim()) {
                                try {
                                    const wechatDomain = data.domain.trim();
                                    // 确保域名以 https:// 开头
                                    const domain = wechatDomain.startsWith('http') ? wechatDomain : `https://${wechatDomain}`;
                                    // 移除末尾的斜杠
                                    const cleanDomain = domain.replace(/\/$/, '');
                                    
                                    // 获取当前URL的路径部分（包括查询参数和哈希）
                                    const currentUrlObj = new URL(currentUrl);
                                    const pathWithQuery = currentUrlObj.pathname + currentUrlObj.search + currentUrlObj.hash;
                                    
                                    // 构建微信域名URL
                                    shareUrl = cleanDomain + pathWithQuery;
                                } catch (e) {
                                    console.error('替换微信域名失败:', e);
                                    // 如果替换失败，使用原始URL
                                    shareUrl = currentUrl;
                                }
                            }
                            
                            const shareText = `${projectName} - ${title}\n\n${shareUrl}`;
                            
                            // 微信分享需要特殊处理，这里提供复制链接的方式
                            if (navigator.clipboard && window.isSecureContext) {
                                navigator.clipboard.writeText(shareText).then(() => {
                                    showToast('内容已复制到剪贴板，请打开微信粘贴分享');
                                    if (typeof window.closeShare === 'function') {
                                        window.closeShare();
                                    }
                                }).catch(() => {
                                    if (typeof window.fallbackCopyTextToClipboard === 'function') {
                                        window.fallbackCopyTextToClipboard(shareText);
                                    }
                                });
                            } else {
                                if (typeof window.fallbackCopyTextToClipboard === 'function') {
                                    window.fallbackCopyTextToClipboard(shareText);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('获取微信域名配置失败:', error);
                            // 如果获取配置失败，使用原始URL
                            const shareText = `${projectName} - ${title}\n\n${currentUrl}`;
                            if (typeof window.fallbackCopyTextToClipboard === 'function') {
                                window.fallbackCopyTextToClipboard(shareText);
                            }
                        });
                } catch (error) {
                    console.error('分享到微信失败:', error);
                }
            };
            
            // 分享到QQ - 在head中定义
            window.shareToQQ = function() {
                try {
                    const url = window.location.href;
                    const title = document.title;
                    const projectName = (window.pageData && window.pageData.projectName) || '工具';
                    const shareText = `${projectName} - ${title}`;
                    const qqUrl = `https://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(url)}&title=${encodeURIComponent(shareText)}&summary=${encodeURIComponent(shareText)}`;
                    window.open(qqUrl, '_blank', 'width=600,height=500');
                    if (typeof window.closeShare === 'function') {
                        window.closeShare();
                    }
                } catch (error) {

                }
            };
            
            // 分享到Twitter/X - 在head中定义
            window.shareToTwitter = function() {
                try {
                    const url = window.location.href;
                    const title = document.title;
                    const projectName = (window.pageData && window.pageData.projectName) || '工具';
                    const shareText = `${projectName} - ${title}`;
                    const xUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(url)}&via=IdoXu401`;
                    window.open(xUrl, '_blank', 'width=600,height=500,scrollbars=yes,resizable=yes');
                    logClick('x_twitter_share');
                    if (typeof window.closeShare === 'function') {
                        window.closeShare();
                    }
                } catch (error) {

                }
            };
            
            // 我的工具 - 在head中定义
            window.handleMyTools = function() {
                try {

                    logClick('my_tools_click');
                    
                    // 检查是否登录（优先使用window上的变量）
                    const isAuthenticated = typeof window.currentUserAuthenticated !== 'undefined' 
                        ? window.currentUserAuthenticated 
                        : (typeof currentUserAuthenticated !== 'undefined' ? currentUserAuthenticated : false);
                    
                    if (!isAuthenticated) {

                        showToast('请先登录后再访问用户中心');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 1500);
                        return;
                    }
                    
                    // 跳转到用户中心
                    window.location.href = '/dashboard';
                } catch (error) {

                    showToast('跳转失败，请刷新页面重试');
                }
            };
            
            // 下载二维码 - 在head中定义，使用统一的公共服务
            window.downloadQRCode = function() {
                try {
                    const qrImage = document.getElementById('qrCodeImage');
                    if (!qrImage) {
                        showToast('二维码未生成');
                        return;
                    }
                    
                    // 使用统一的下载函数
                    if (typeof downloadQRImage === 'function') {
                        const fileName = (window.pageData && window.pageData.projectName) || '工具';
                        downloadQRImage(qrImage, `DKFile-${fileName}`, {
                            showToast: true,
                            successMessage: '二维码下载成功'
                        });
                        return;
                    }
                    
                    // Fallback：处理图片下载的函数
                    const processDownload = function() {
                        try {
                            // 创建一个临时的canvas来下载图片
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // 使用图片的实际尺寸，如果没有则使用显示尺寸
                            const imgWidth = qrImage.naturalWidth || qrImage.width || 200;
                            const imgHeight = qrImage.naturalHeight || qrImage.height || 200;
                            
                            canvas.width = imgWidth;
                            canvas.height = imgHeight;
                            
                            // 绘制白色背景
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            
                            // 绘制二维码图片
                            ctx.drawImage(qrImage, 0, 0, imgWidth, imgHeight);
                            
                            // 创建下载链接
                            canvas.toBlob(function(blob) {
                                if (!blob) {
                                    showToast('下载失败，无法生成图片');
                                    return;
                                }
                                
                                try {
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    const fileName = (window.pageData && window.pageData.projectName) || '工具';
                                    // 清理文件名，移除特殊字符
                                    const cleanFileName = fileName.replace(/[^\w\u4e00-\u9fa5]/g, '_');
                                    a.download = `DKFile-${cleanFileName}.png`;
                                    document.body.appendChild(a);
                                    a.click();
                                    
                                    // 延迟清理，确保下载开始
                                    setTimeout(function() {
                                        document.body.removeChild(a);
                                        URL.revokeObjectURL(url);
                                    }, 100);
                                    
                                    showToast('二维码下载成功');
                                } catch (e) {
                                    console.error('创建下载链接失败:', e);
                                    showToast('下载失败，请重试');
                                }
                            }, 'image/png');
                        } catch (e) {
                            console.error('处理下载失败:', e);
                            showToast('下载失败，请重试');
                        }
                    };
                    
                    // base64 data URI图片处理：创建新Image对象确保加载完成
                    const imgSrc = qrImage.src;
                    if (imgSrc && imgSrc.startsWith('data:image')) {
                        // base64 data URI：创建新Image对象重新加载
                        const newImg = new Image();
                        newImg.onload = function() {
                            // 确保新图片有有效尺寸
                            if (newImg.width === 0 || newImg.height === 0) {
                                // 延迟重试，给浏览器更多时间计算尺寸
                                setTimeout(function() {
                                    if (newImg.width > 0 && newImg.height > 0) {
                                        // 使用新加载的图片进行下载
                                        const canvas = document.createElement('canvas');
                                        const ctx = canvas.getContext('2d');
                                        canvas.width = newImg.width;
                                        canvas.height = newImg.height;
                                        ctx.fillStyle = '#ffffff';
                                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                                        ctx.drawImage(newImg, 0, 0);
                                        
                                        canvas.toBlob(function(blob) {
                                            if (!blob) {
                                                showToast('下载失败，无法生成图片');
                                                return;
                                            }
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            const fileName = (window.pageData && window.pageData.projectName) || '工具';
                                            const cleanFileName = fileName.replace(/[^\w\u4e00-\u9fa5]/g, '_');
                                            a.download = `DKFile-${cleanFileName}.png`;
                                            document.body.appendChild(a);
                                            a.click();
                                            setTimeout(function() {
                                                document.body.removeChild(a);
                                                URL.revokeObjectURL(url);
                                            }, 100);
                                            showToast('二维码下载成功');
                                        }, 'image/png');
                                    } else {
                                        showToast('下载失败：图片未完全加载或尺寸无效');
                                        console.error('下载失败: 图片尺寸无效', newImg.width, newImg.height);
                                    }
                                }, 100);
                                return;
                            }
                            
                            // 使用新加载的图片进行下载
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = newImg.width;
                            canvas.height = newImg.height;
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(newImg, 0, 0);
                            
                            canvas.toBlob(function(blob) {
                                if (!blob) {
                                    showToast('下载失败，无法生成图片');
                                    return;
                                }
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                const fileName = (window.pageData && window.pageData.projectName) || '工具';
                                const cleanFileName = fileName.replace(/[^\w\u4e00-\u9fa5]/g, '_');
                                a.download = `DKFile-${cleanFileName}.png`;
                                document.body.appendChild(a);
                                a.click();
                                setTimeout(function() {
                                    document.body.removeChild(a);
                                    URL.revokeObjectURL(url);
                                }, 100);
                                showToast('二维码下载成功');
                            }, 'image/png');
                        };
                        newImg.onerror = function() {
                            showToast('下载失败：图片加载异常');
                        };
                        newImg.src = imgSrc;
                    } else {
                        // 普通图片URL：使用原有逻辑
                        if (qrImage.complete && qrImage.naturalWidth > 0 && qrImage.naturalHeight > 0) {
                            processDownload();
                        } else {
                            const originalOnload = qrImage.onload;
                            qrImage.onload = function() {
                                if (originalOnload) originalOnload();
                                if (qrImage.naturalWidth > 0 && qrImage.naturalHeight > 0) {
                                    processDownload();
                                } else {
                                    setTimeout(function() {
                                        if (qrImage.naturalWidth > 0 && qrImage.naturalHeight > 0) {
                                            processDownload();
                                        } else {
                                            showToast('下载失败：图片未完全加载');
                                        }
                                    }, 100);
                                }
                            };
                            if (qrImage.complete) {
                                qrImage.onload();
                            }
                        }
                    }
                } catch (error) {
                    console.error('下载二维码失败:', error);
                    showToast('下载失败，请重试');
                }
            };
            
            // 复制链接 - 在head中定义
            window.copyLink = function() {
                try {
                    const currentUrl = window.location.href;
                    const title = document.title;
                    const projectName = (window.pageData && window.pageData.projectName) || '工具';
                    
                    // 获取微信域名配置并替换
                    fetch('/api/wechat-domain')
                        .then(response => response.json())
                        .then(data => {
                            let url = currentUrl.replace('http://', 'https://');
                            
                            // 如果配置了微信域名，则替换当前URL的域名部分
                            if (data.success && data.domain && data.domain.trim()) {
                                try {
                                    const wechatDomain = data.domain.trim();
                                    // 确保域名以 https:// 开头
                                    const domain = wechatDomain.startsWith('http') ? wechatDomain : `https://${wechatDomain}`;
                                    // 移除末尾的斜杠
                                    const cleanDomain = domain.replace(/\/$/, '');
                                    
                                    // 获取当前URL的路径部分（包括查询参数和哈希）
                                    const currentUrlObj = new URL(currentUrl);
                                    const pathWithQuery = currentUrlObj.pathname + currentUrlObj.search + currentUrlObj.hash;
                                    
                                    // 构建微信域名URL
                                    url = cleanDomain + pathWithQuery;
                                } catch (e) {
                                    console.error('替换微信域名失败:', e);
                                    // 如果替换失败，使用原始URL
                                    url = currentUrl.replace('http://', 'https://');
                                }
                            }
                            
                            const textToCopy = `${projectName} - ${title}\n${url}`;
                            
                            if (navigator.clipboard && window.isSecureContext) {
                                navigator.clipboard.writeText(textToCopy).then(() => {
                                    showToast('链接已复制到剪贴板');
                                    if (typeof window.closeShare === 'function') {
                                        window.closeShare();
                                    }
                                }).catch(() => {
                                    if (typeof window.fallbackCopyTextToClipboard === 'function') {
                                        window.fallbackCopyTextToClipboard(textToCopy);
                                    }
                                });
                            } else {
                                if (typeof window.fallbackCopyTextToClipboard === 'function') {
                                    window.fallbackCopyTextToClipboard(textToCopy);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('获取微信域名配置失败:', error);
                            // 如果获取配置失败，使用原始URL
                            let url = currentUrl.replace('http://', 'https://');
                            const textToCopy = `${projectName} - ${title}\n${url}`;
                            if (navigator.clipboard && window.isSecureContext) {
                                navigator.clipboard.writeText(textToCopy).then(() => {
                                    showToast('链接已复制到剪贴板');
                                    if (typeof window.closeShare === 'function') {
                                        window.closeShare();
                                    }
                                }).catch(() => {
                                    if (typeof window.fallbackCopyTextToClipboard === 'function') {
                                        window.fallbackCopyTextToClipboard(textToCopy);
                                    }
                                });
                            } else {
                                if (typeof window.fallbackCopyTextToClipboard === 'function') {
                                    window.fallbackCopyTextToClipboard(textToCopy);
                                }
                            }
                        });
                } catch (error) {
                    console.error('复制链接失败:', error);
                    showToast('复制失败，请手动复制链接');
                }
            };
            
            // 备用复制方法 - 在head中定义
            window.fallbackCopyTextToClipboard = function(text) {
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        showToast('链接已复制到剪贴板');
                        if (typeof window.closeShare === 'function') {
                            window.closeShare();
                        }
                    } catch (err) {
                        showToast('复制失败，请手动复制链接');
                    }
                    
                    document.body.removeChild(textArea);
                } catch (error) {

                }
            };
            
            // 检查并修复可能影响fixed定位的父元素样式（在head中定义）
            window.fixFixedPositioningAncestors = function(element) {
                if (!element || !element.parentElement) return false;
                
                let current = element.parentElement;
                const problematicProps = ['transform', 'perspective', 'filter', 'will-change'];
                
                while (current && current !== document.body && current !== document.documentElement) {
                    const computedStyle = window.getComputedStyle(current);
                    
                    // 检查是否有影响fixed定位的属性
                    for (const prop of problematicProps) {
                        const value = computedStyle.getPropertyValue(prop);
                        if (value && value !== 'none' && value !== 'auto' && value !== 'initial') {
                            // 如果父元素有这些属性，需要将容器移到body下

                            return true; // 需要移动容器
                        }
                    }
                    
                    // 检查position是否为fixed或absolute（这些也可能影响）
                    const position = computedStyle.position;
                    if (position === 'fixed' || position === 'absolute') {
                        // 如果父元素是fixed或absolute，检查是否有transform等属性
                        const transform = computedStyle.transform;
                        if (transform && transform !== 'none') {

                            return true; // 需要移动容器
                        }
                    }
                    
                    current = current.parentElement;
                }
                
                return false; // 不需要移动
            };
            
            // 强制修复平台标识位置 - 已简化，只检查新的 #dkfile-platform-footer-in-buttons
            window.forceFixPlatformFooter = function() {
                // 新的平台标识已集成到浮动按钮组中，无需额外修复
                // 保留此函数用于向后兼容，但不执行任何操作
                return;
            };
            
            // 手机端浮动按钮展开/收起控制 - 在head中定义，确保在用户内容加载前可用
            window.toggleFloatingButtons = function() {
                try {
                    const isMobile = window.innerWidth <= 768;
                    if (!isMobile) {
                        return; // 非手机端不执行
                    }
                    
                    const buttonsContainer = document.getElementById('dkfile-floating-buttons');
                    const menuBtn = document.getElementById('floatingMenuBtn');
                    const menuBtnIcon = document.getElementById('menuBtnIcon');
                    const overlay = document.getElementById('floatingButtonsOverlay');
                    
                    if (!buttonsContainer || !menuBtn || !menuBtnIcon) {

                        return;
                    }
                    
                    const isExpanded = buttonsContainer.classList.contains('expanded');
                    
                    // 记录收缩/展开按钮点击日志
                    logClick(isExpanded ? 'menu_collapse' : 'menu_expand');
                    
                    if (isExpanded) {
                        // 收起
                        buttonsContainer.classList.remove('expanded');
                        menuBtn.classList.remove('active');
                        menuBtnIcon.className = 'bi bi-plus-lg';
                        if (overlay) {
                            overlay.classList.remove('active');
                        }
                        document.body.style.overflow = '';

                    } else {
                        // 展开
                        buttonsContainer.classList.add('expanded');
                        menuBtn.classList.add('active');
                        menuBtnIcon.className = 'bi bi-x-lg';
                        if (overlay) {
                            overlay.classList.add('active');
                        }
                        document.body.style.overflow = 'hidden';

                    }
                } catch (error) {

                }
            };
            
            
            // 强制修复浮动按钮样式 - 确保固定在右下角（在head中定义，确保在用户内容加载前可用）
            window.forceFixFloatingButtons = function() {
                // 优先使用ID选择器，更精确，避免被用户内容中的.floating-action-buttons影响
                const floatingButtons = document.getElementById('dkfile-floating-buttons') || document.querySelector('.floating-action-buttons');
                if (!floatingButtons) {

                    // 如果元素还没加载，延迟重试
                    setTimeout(function() {
                        if (typeof window.forceFixFloatingButtons === 'function') {
                            window.forceFixFloatingButtons();
                        }
                    }, 500);
                    return;
                }
                
                try {
                    const isMobile = window.innerWidth <= 768;
                    // 强制设置关键样式属性，确保固定在右下角
                    floatingButtons.style.setProperty('position', 'fixed', 'important');
                    floatingButtons.style.setProperty('bottom', isMobile ? '70px' : '80px', 'important');
                    floatingButtons.style.setProperty('right', isMobile ? '10px' : '20px', 'important');
                    floatingButtons.style.setProperty('left', 'auto', 'important');
                    floatingButtons.style.setProperty('top', 'auto', 'important');
                    floatingButtons.style.setProperty('z-index', '10000', 'important');
                    floatingButtons.style.setProperty('display', 'flex', 'important');
                    floatingButtons.style.setProperty('flex-direction', 'column', 'important');
                    floatingButtons.style.setProperty('gap', isMobile ? '6px' : '8px', 'important');
                    floatingButtons.style.setProperty('visibility', 'visible', 'important');
                    floatingButtons.style.setProperty('opacity', '1', 'important');
                    floatingButtons.style.setProperty('pointer-events', 'auto', 'important');
                    floatingButtons.style.setProperty('transform', 'none', 'important');
                    floatingButtons.style.setProperty('margin', '0', 'important');
                    floatingButtons.style.setProperty('padding', '0', 'important');
                    
                    // 修复每个按钮的样式
                    const buttons = floatingButtons.querySelectorAll('.floating-btn');
                    buttons.forEach(function(btn) {
                        const btnSize = isMobile ? '36px' : '40px';
                        btn.style.setProperty('width', btnSize, 'important');
                        btn.style.setProperty('height', btnSize, 'important');
                        btn.style.setProperty('min-width', btnSize, 'important');
                        btn.style.setProperty('min-height', btnSize, 'important');
                        btn.style.setProperty('max-width', btnSize, 'important');
                        btn.style.setProperty('max-height', btnSize, 'important');
                        btn.style.setProperty('display', 'flex', 'important');
                        btn.style.setProperty('visibility', 'visible', 'important');
                        btn.style.setProperty('opacity', '1', 'important');
                        btn.style.setProperty('pointer-events', 'auto', 'important');
                    });

                } catch (e) {

                }
            };
            
        })();
    </script>
    
    <!-- 错误隔离：在用户内容加载前设置全局错误处理 -->
    <script>
        (function() {
            'use strict';
            
            // 记录原始的错误处理
            const originalError = window.onerror;
            const originalUnhandledRejection = window.onunhandledrejection;
            
            // 全局错误处理 - 捕获并静默处理语法错误，避免影响用户体验
            window.onerror = function(message, source, lineno, colno, error) {
                // 检查是否是语法错误（SyntaxError）
                const isSyntaxError = message && (
                    message.includes('SyntaxError') ||
                    message.includes('Unexpected token') ||
                    message.includes('Unexpected end') ||
                    message.includes('Unexpected identifier') ||
                    (error && error.name === 'SyntaxError')
                );
                
                // 如果是语法错误，静默处理，不抛出到控制台
                if (isSyntaxError) {
                    // 静默处理语法错误，避免影响用户体验
                    return true; // 阻止错误传播到控制台
                }
                
                // 如果错误来自用户内容（content-wrapper），记录但不阻止执行
                if (source && (source.includes('content-wrapper') || !source.includes('view.html'))) {
                    // 错误来自用户内容，已隔离，不影响平台功能
                    if (typeof window.handleLike === 'undefined') {
                        // 平台关键函数可能被用户内容影响
                    }
                    return false; // 允许错误继续传播（用于调试）
                }
                
                // 如果是平台代码的错误，调用原始处理器
                if (originalError) {
                    return originalError.apply(this, arguments);
                }
                return false;
            };
            
            // 捕获未处理的Promise拒绝
            window.addEventListener('unhandledrejection', function(event) {
                // 不阻止默认行为
            });
            
        })();
    </script>
</head>
<body>
    
    <div class="content-wrapper">
        <!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>蒙西电力市场交易规则闯关游戏</title>
  <meta name="description" content="一步步上手：中长期、现货、滚动撮合、阻塞盈余、分摊返还、风险防范、辅助服务等（含案例与计算器）。" />
  <style>
/* 内蒙古电力交易规则·互动学习
   UI 语言全部中文；动画默认开启，尊重“减少动画”系统设置。 */

:root{
  --bg: #0b1020;
  --panel: rgba(255,255,255,.06);
  --panel2: rgba(255,255,255,.08);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.66);
  --muted2: rgba(255,255,255,.48);
  --stroke: rgba(255,255,255,.14);
  --stroke2: rgba(255,255,255,.10);
  --good: rgba(76, 217, 100, 1);
  --warn: rgba(255, 204, 0, 1);
  --bad: rgba(255, 59, 48, 1);
  --shadow: 0 18px 60px rgba(0,0,0,.35);
  --radius: 18px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  font-family: var(--sans);
  color: var(--text);
  background:
    radial-gradient(1200px 800px at 10% 10%, rgba(110, 231, 183, .18), transparent 55%),
    radial-gradient(900px 700px at 90% 30%, rgba(96, 165, 250, .18), transparent 55%),
    radial-gradient(900px 700px at 50% 95%, rgba(244, 114, 182, .12), transparent 60%),
    linear-gradient(180deg, #070a14, var(--bg));
  overflow:hidden;
}

.app{ display:flex; height:100%; }
.sidebar{
  width: 360px;
  min-width: 320px;
  border-right:1px solid var(--stroke2);
  padding: 18px 16px;
  overflow:auto;
  backdrop-filter: blur(10px);
  background: rgba(0,0,0,.12);
  transition: transform .25s ease;
}
.sidebar.collapsed{ transform: translateX(-100%); }

.brand{
  display:flex; gap:12px; align-items:center;
  padding: 10px 10px 16px 10px;
}
.logo{
  width:42px; height:42px; border-radius:14px;
  display:grid; place-items:center;
  background: linear-gradient(135deg, rgba(96,165,250,.35), rgba(110,231,183,.30));
  border:1px solid var(--stroke);
  box-shadow: 0 10px 40px rgba(0,0,0,.25);
  font-size:20px;
}
.brandTitle{ font-weight: 760; letter-spacing:.2px; }
.brandSub{ font-size:12px; color: var(--muted2); margin-top:2px; }

.profileCard{
  padding: 12px;
  border:1px solid var(--stroke2);
  border-radius: var(--radius);
  background: var(--panel);
  box-shadow: var(--shadow);
  margin: 6px 10px 14px 10px;
}
.row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.pill{
  font-size:12px;
  padding: 6px 10px;
  border-radius: 999px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.06);
}
.tiny{ font-size:12px; color: var(--muted2); margin-top:8px; line-height:1.4; }
.mono{ font-family: var(--mono); }

.moduleNav{ display:flex; flex-direction:column; gap:8px; padding: 0 10px 14px 10px; }
.modBtn{
  width:100%;
  text-align:left;
  padding: 12px 12px;
  border-radius: 16px;
  border:1px solid var(--stroke2);
  background: rgba(255,255,255,.04);
  color: var(--text);
  cursor:pointer;
  transition: transform .12s ease, background .12s ease, border-color .12s ease;
}
.modBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: var(--stroke); }
.modBtn.active{ background: rgba(96,165,250,.16); border-color: rgba(96,165,250,.45); }
.modTitle{ font-weight: 700; }
.modMeta{ font-size:12px; color: var(--muted2); margin-top:4px; display:flex; justify-content:space-between; }

.footer{ padding: 12px 10px 4px 10px; color: var(--muted2); }

.main{
  flex:1;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.topbar{
  display:flex; align-items:center; justify-content:space-between;
  padding: 14px 18px;
  border-bottom:1px solid var(--stroke2);
  background: rgba(0,0,0,.08);
  backdrop-filter: blur(10px);
}
.topbarLeft{ display:flex; gap:12px; align-items:center; }
.iconBtn{
  width:40px; height:40px;
  border-radius: 14px;
  border:1px solid var(--stroke2);
  background: rgba(255,255,255,.05);
  color: var(--text);
  cursor:pointer;
}
.crumbTitle{ font-weight: 760; }
.crumbSub{ color: var(--muted2); font-size:12px; margin-top:2px; }

.btn{
  padding: 10px 14px;
  border-radius: 14px;
  border:1px solid var(--stroke2);
  background: rgba(255,255,255,.06);
  color: var(--text);
  cursor:pointer;
}
.btn:hover{ border-color: var(--stroke); }
.btn.primary{
  background: linear-gradient(135deg, rgba(96,165,250,.32), rgba(110,231,183,.22));
  border-color: rgba(96,165,250,.45);
}

.ghost{
  padding: 8px 10px;
  border-radius: 12px;
  border:1px solid var(--stroke2);
  background: rgba(255,255,255,.03);
  color: var(--text);
  cursor:pointer;
  font-size:12px;
}
.ghost:hover{ border-color: var(--stroke); }

.content{
  flex:1;
  overflow:auto;
  padding: 18px;
}

.stepper{ max-width: 1040px; margin: 0 auto; }
.stepperTop{ display:flex; justify-content:space-between; gap:18px; align-items:flex-end; padding: 10px 6px 14px 6px; }
.stepKicker{ font-size:12px; color: var(--muted2); }
.stepTitle{ margin: 6px 0 0 0; font-size: 30px; letter-spacing: .2px; }
.stepMeta{ min-width: 260px; }
.bar{
  height:10px; border-radius: 999px; overflow:hidden;
  border:1px solid var(--stroke2);
  background: rgba(255,255,255,.04);
}
.barInner{
  height:100%;
  border-radius: 999px;
  background: linear-gradient(90deg, rgba(96,165,250,.8), rgba(110,231,183,.8));
  transition: width .3s ease;
}

.card{
  border:1px solid var(--stroke2);
  border-radius: var(--radius);
  background: rgba(255,255,255,.05);
  box-shadow: var(--shadow);
  overflow:hidden;
}
.card.muted{ background: rgba(255,255,255,.03); }
.cardBody{ padding: 16px 18px; }

.sectionTitle{ font-weight: 760; margin-bottom: 8px; }
.intro{
  padding: 12px 14px;
  border:1px solid var(--stroke2);
  border-radius: 16px;
  background: rgba(255,255,255,.04);
  margin-bottom: 14px;
  line-height: 1.6;
}
.explain{ line-height:1.7; color: var(--text); }
.explain h3{ margin: 14px 0 8px; }
.explain ul{ margin: 10px 0 14px 18px; color: var(--muted); }
.explain li{ margin: 6px 0; }
.explain .callout{
  margin: 12px 0;
  padding: 12px 14px;
  border-left: 3px solid rgba(110,231,183,.6);
  background: rgba(110,231,183,.08);
  border-radius: 14px;
}
.do{
  margin-top: 16px;
  padding-top: 16px;
  border-top:1px dashed rgba(255,255,255,.12);
}
.check{
  margin-top: 14px;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding: 12px 14px;
  border:1px solid var(--stroke2);
  border-radius: 16px;
  background: rgba(255,255,255,.03);
}
.badge{
  font-size:12px; padding: 6px 10px; border-radius: 999px;
  border:1px solid var(--stroke2);
  background: rgba(255,255,255,.04);
  color: var(--muted);
}
.badge.good{ border-color: rgba(76,217,100,.45); background: rgba(76,217,100,.10); color: rgba(255,255,255,.90); }
.badge.warn{ border-color: rgba(255,204,0,.45); background: rgba(255,204,0,.10); color: rgba(255,255,255,.92); }
.badge.bad{ border-color: rgba(255,59,48,.45); background: rgba(255,59,48,.10); color: rgba(255,255,255,.92); }

.hidden{ display:none; }

/* Widgets */
.widget{
  border:1px solid var(--stroke2);
  border-radius: 16px;
  background: rgba(0,0,0,.10);
  padding: 14px;
  margin-top: 12px;
}
.widget h4{ margin: 0 0 8px; }
.grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
.grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
.field{
  display:flex; flex-direction:column; gap:6px;
}
label{ font-size:12px; color: var(--muted2); }
input, select, textarea{
  width:100%;
  padding: 10px 10px;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color: var(--text);
  outline:none;
}
textarea{ min-height: 84px; resize: vertical; font-family: var(--mono); font-size: 12px; }
input:focus, select:focus, textarea:focus{ border-color: rgba(96,165,250,.55); }

.smallBtn{
  padding: 8px 10px;
  border-radius: 12px;
  border:1px solid var(--stroke2);
  background: rgba(255,255,255,.06);
  color: var(--text);
  cursor:pointer;
  font-size:12px;
}
.smallBtn:hover{ border-color: var(--stroke); }

.table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  overflow:hidden;
  border-radius: 14px;
  border:1px solid var(--stroke2);
}
.table th, .table td{
  padding: 10px 10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  font-size: 12px;
}
.table th{ text-align:left; color: var(--muted2); background: rgba(255,255,255,.04); }
.table tr:last-child td{ border-bottom:none; }

.kpi{
  display:flex; gap:10px; flex-wrap:wrap;
  margin-top: 10px;
}
.kpi .k{
  padding: 10px 12px;
  border:1px solid var(--stroke2);
  border-radius: 14px;
  background: rgba(255,255,255,.04);
  min-width: 160px;
}
.k .kLabel{ font-size:12px; color: var(--muted2); }
.k .kVal{ font-size:18px; font-weight: 760; margin-top:4px; }

.diagram{
  border:1px solid var(--stroke2);
  border-radius: 16px;
  background: rgba(255,255,255,.03);
  height: 220px;
  position: relative;
  overflow:hidden;
}
.node{
  position:absolute;
  width: 46px; height:46px;
  border-radius: 16px;
  display:grid; place-items:center;
  border:1px solid var(--stroke);
  background: rgba(96,165,250,.18);
  box-shadow: 0 12px 40px rgba(0,0,0,.18);
  font-weight: 800;
}
.line{
  position:absolute;
  height: 8px;
  border-radius: 999px;
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  transform-origin: left center;
}
.flow{
  position:absolute;
  height: 8px;
  border-radius: 999px;
  background: linear-gradient(90deg, rgba(110,231,183,.2), rgba(110,231,183,.85));
  transform-origin: left center;
  animation: pulse 1.2s ease-in-out infinite;
}
@keyframes pulse{
  0%,100%{ filter: brightness(1); opacity:.75; }
  50%{ filter: brightness(1.25); opacity:1; }
}

.confetti{
  position: fixed;
  left:0; top:0;
  width:100vw; height:100vh;
  pointer-events:none;
}

.cheat{
  margin-top: 10px;
  border-top: 1px dashed rgba(255,255,255,.12);
  padding-top: 10px;
  line-height: 1.7;
  color: var(--muted);
}
.cheat .mono{ font-size: 12px; }

@media (max-width: 980px){
  .sidebar{ position: fixed; z-index: 20; height: 100%; left:0; top:0; }
  .main{ margin-left:0; }
}

@media (prefers-reduced-motion: reduce){
  *{ transition:none !important; animation:none !important; scroll-behavior:auto !important; }
}



/* ===== Mobile polish ===== */
@media (max-width: 980px){
  .sidebar{
    width: min(88vw, 360px);
    min-width: unset;
    padding: 16px 14px;
    box-shadow: 0 30px 90px rgba(0,0,0,.55);
  }
  .content{ padding: 14px 12px; }
  .stepperTop{
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  .stepTitle{ font-size: 24px; line-height: 1.2; }
  .stepMeta{ width: 100%; min-width: unset; }
  .topbar{
    gap: 10px;
    align-items: flex-start;
  }
  .topbarRight{
    display:flex;
    gap:10px;
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  .btn{ padding: 10px 12px; }
  .grid2, .grid3{ grid-template-columns: 1fr !important; }
  .kpi .k{
    min-width: unset;
    flex: 1 1 160px;
  }
  textarea{ min-height: 110px; }
  .diagram{ height: 200px; }
}

/* Small phones */
@media (max-width: 420px){
  .brandTitle{ font-size: 14px; }
  .logo{ width: 38px; height: 38px; border-radius: 13px; }
  .iconBtn{ width: 38px; height: 38px; border-radius: 13px; }
  .btn{ border-radius: 13px; }
  .cardBody{ padding: 14px 14px; }
  .stepTitle{ font-size: 22px; }
  .profileCard{ margin: 6px 6px 12px 6px; }
}

/* Tables: allow horizontal scroll on narrow screens */
.table{
  display: block;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.table th, .table td{ white-space: nowrap; }

</style>
</head>
<body>
  <div id="app" class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true">⚡</div>
        <div>
          <div class="brandTitle">蒙西电力市场交易规则闯关游戏</div>
          <div class="brandSub">内蒙古华电售电公司开发制作</div>
        </div>
      </div>

      <div class="profileCard">
        <div class="row">
          <span class="pill" id="progressPill">进度 0%</span>
          <button class="ghost" id="btnReset" title="清空学习进度">重置</button>
        </div>
        <div class="tiny">提示：所有内容均为“教学化简化模型”，用于理解规则逻辑与计算步骤。</div>
      </div>

      <nav id="moduleNav" class="moduleNav" aria-label="学习模块"></nav>

      <div class="footer">
        <div class="tiny">
          支持离线运行。打开 <span class="mono">index.html</span> 即可。
        </div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topbarLeft">
          <button class="iconBtn" id="btnSidebar" aria-label="展开/收起侧边栏">☰</button>
          <div>
            <div id="crumbTitle" class="crumbTitle">欢迎</div>
            <div id="crumbSub" class="crumbSub">选择左侧模块开始学习</div>
          </div>
        </div>
        <div class="topbarRight">
          <button class="btn" id="btnPrev">上一步</button>
          <button class="btn primary" id="btnNext">下一步</button>
        </div>
      </header>

      <section class="content">
        <div class="stepper">
          <div class="stepperTop">
            <div class="stepTitleWrap">
              <div class="stepKicker" id="stepKicker">模块 0 / 0</div>
              <h1 class="stepTitle" id="stepTitle">内蒙古电力交易规则互动学习</h1>
            </div>
            <div class="stepMeta">
              <div class="bar">
                <div class="barInner" id="barInner" style="width:0%"></div>
              </div>
              <div class="tiny" id="stepMetaText">从左侧选择模块开始</div>
            </div>
          </div>

          <div class="card">
            <div class="cardBody">
              <div id="stepIntro" class="intro"></div>
              <div id="stepExplain" class="explain"></div>
              <div id="stepDo" class="do"></div>
              <div id="stepCheck" class="check"></div>
            </div>
          </div>

          <div class="card muted">
            <div class="cardBody">
              <div class="row">
                <div>
                  <div class="sectionTitle">小抄（随时可用）</div>
                  <div class="tiny">把“概念→规则→计算→风险点”拆开学，永远不迷路。</div>
                </div>
                <button class="ghost" id="btnCheat">展开/收起</button>
              </div>
              <div id="cheat" class="cheat hidden"></div>
            </div>
          </div>
        </div>

        <canvas id="confetti" class="confetti" width="10" height="10" aria-hidden="true"></canvas>
      </section>
    </main>
  </div>

<script>
// data.js
// 模块内容采用“教学化简化模型”，专注于规则理解与计算步骤上手。
// 你可以继续在 modules 里扩充更多案例（尤其是 96点/720点的批量案例）。

window.IM_TUTOR_DATA = {
  version: "1.0.0",
  cheat: `
  <div class="sectionTitle">学习路线（建议）</div>
  <ul>
    <li><b>先结构</b>：中长期→现货→结算（参考点、电价类型）→费用（阻塞/分摊/风险防范/考核）→辅助服务。</li>
    <li><b>再计算</b>：先用 1 个时段（1 点）跑通，再扩到 4 点，再扩到 24/96/720 点。</li>
    <li><b>再风险</b>：交易前（签约与曲线）+ 交易中（价格/阻塞）+ 交易后（结算查询与追补）。</li>
  </ul>
  <div class="sectionTitle">常用名词</div>
  <ul>
    <li><b>节点电价</b>：发电侧按机组/场站所在电气节点结算。</li>
    <li><b>区域结算参考点电价</b>：用户侧按所属分区的加权平均电价结算（规则中以呼包断面划分东西部）。</li>
    <li><b>全网统一结算参考点电价</b>：用户侧所有节点电价按实际下网电量加权平均得到。</li>
    <li><b>曲线合理度</b>：用“合约与计量”在各清分时段取小值之和 / 取均值之和（用于与风险防范、阻塞返还等联动）。</li>
  </ul>
  `,

  modules: [
    {
      id: "m0",
      title: "0. 总览：市场结构与学习地图",
      desc: "先把“有哪些交易 + 怎么结算”装进脑子",
      steps: [
        {
          id: "m0s0",
          title: "欢迎：把复杂规则变成“可操作”",
          intro: "你将用“讲解 + 动手算例”的方式，逐步掌握：中长期、滚动撮合、现货（实时/日内）、节点电价与阻塞、分摊返还、风险防范、辅助服务等。",
          explain: `
            <div class="callout">
              <b>使用方式：</b>每一步先读“讲解”，再在“动手区”点击/输入完成计算；系统会给出中间过程。
            </div>
            <h3>学习目标（到能干活）</h3>
            <ul>
              <li>看懂交易组织方式：集中撮合 vs 滚动撮合、挂牌/摘牌。</li>
              <li>把“价格形成”讲清楚：边际出清、节点电价（拥塞导致价差）。</li>
              <li>把“结算拆解”讲清楚：现货全电量 + 中长期差价合约 + 运行调整费用。</li>
              <li>遇到异常能定位：阻塞盈余、计量平衡、不平衡费用、风险防范补偿/回收。</li>
            </ul>
          `,
          do: { widget: "welcome" },
          check: { type: "none" }
        }
      ]
    },

    {
      id: "m1",
      title: "1. 中长期：年度/月度/月内与滚动撮合",
      desc: "先学交易“怎么成交”，再学“成交价怎么算”",
      steps: [
        {
          id: "m1s0",
          title: "滚动撮合：高低匹配 + 成交价（算术平均，向下保留 1 位）",
          intro: "滚动撮合的核心：按价格+时间优先级匹配，成交价=双方报价算术平均并“向下保留 1 位小数”。",
          explain: `
            <h3>你需要记住的 3 句话</h3>
            <ul>
              <li>买方“出价高”更优先，卖方“要价低”更优先。</li>
              <li>匹配成交后，<b>成交价=（买价+卖价）/2，并向下保留 1 位小数</b>。</li>
              <li>复杂的 96 点交易，先用 1 点跑通，再扩展。</li>
            </ul>
            <div class="callout">
              下面的模拟器就是把规则“缩小到一小时/一个点”，让你先把算法跑通。
            </div>

<div class="callout">
<b>2026规定要点（中长期撮合/滚动撮合）</b>
<ul>
  <li>年度撮合交易采用“集中撮合 + 滚动撮合”组织，标的物为<b>分月96点电力</b>（发电侧卖出、用电侧买入）。</li>
  <li>撮合成交的具体价格、优先级与技术细节以市场规则体系及交易系统为准，本关卡用于把算法“跑通”。</li>
</ul>
</div>

`,
          do: { widget: "rollingMatch" },
          check: { type: "quiz", prompt: "如果买价=0.343、卖价=0.298，成交价是多少（向下保留1位小数）？", answer: "0.3" }
        },
        {
          id: "m1s1",
          title: "96点是什么：把“电量”变成“电力曲线”",
          intro: "蒙西中长期常用“分月 96 点电力”作为标的：每 15 分钟一个点，组成一条曲线。",
          explain: `
            <h3>先把尺度感建立起来</h3>
            <ul>
              <li>1 天：96 点（15 分钟/点）。</li>
              <li>1 月：大约 2880 点（30天×96点）。</li>
              <li>实际交易常以“分月 96点电力 → 均分拆分到各日”等方式组织。</li>
            </ul>
            <div class="callout">
              动手区用 4 点示例模拟“曲线”，你可以把它当成 96 点的缩小版。
            </div>
          `,
          do: { widget: "curveBasics" },
          check: { type: "none" }
        },
        {
          id: "m1s2",
          title: "月内融合/合同置换：D+1…D+10/20/月底 的分段标的",
          intro: "月内交易常按“D+1~10、D+1~20、D+1~月底”分阶段组织；近端一般用“每日96点”，更远端可用“四小时直线”。",
          explain: `
            <h3>为什么要分段？</h3>
            <ul>
              <li><b>越临近运行日，越需要精细曲线</b>（所以用 96 点）。</li>
              <li>远期不确定性大，用“四小时直线”降低操作复杂度。</li>
            </ul>
            <div class="callout">动手区给你一个“选标的→生成曲线”的练习。</div>

<div class="callout">
<b>2026规定要点（月内发电侧合同置换，三阶段标的）</b>
<ul>
  <li>月内发电侧合同置换按工作日连续开展，分三阶段：<b>D+1~10、D+1~20、D+1~月底</b>。</li>
  <li>标的物分段设置：<b>D+1~D+4为每日96点电力</b>；<b>D+5至阶段末为每日四小时电量</b>。</li>
</ul>
</div>

`,
          do: { widget: "stagePicker" },
          check: { type: "none" }
        }
      ]
    },

    {
      id: "m2",
      title: "2. 现货：实时交易、日前预出清、日内（适时开展）",
      desc: "先懂结构，再懂出清与价格",
      steps: [
        {
          id: "m2s0",
          title: "现货市场结构：初期仅实时电能量交易",
          intro: "现货市场包含：可靠性机组组合及日前预出清、实时交易；初期仅开展实时电能量交易，暂不开展日前电能量交易，适时开展日内交易。",
          explain: `
            <h3>用一句话理解</h3>
            <ul>
              <li><b>“日前做计划（预出清），实时算钱（实时交易）”</b>。</li>
            </ul>
            <div class="callout">
              接下来我们会用一个“供需曲线”小模型，演示边际出清怎么决定价格。
            </div>

<div class="callout">
<b>2026规定要点（现货运行组织）</b>
<ul>
  <li>现货市场按规则体系运行：包含可靠性机组组合及日前预出清、实时交易；初期以实时电能量交易为主，日内按需要适时开展。</li>
</ul>
</div>

`,
          do: { widget: "spotStructure" },
          check: { type: "none" }
        },
        {
          id: "m2s1",
          title: "出清原理（简化版）：边际机组决定价格",
          intro: "把机组报价按成本从低到高排成“供给堆栈”，需求落在哪个台阶上，那个台阶的报价就是边际出清价格（简化讲法）。",
          explain: `
            <h3>你要能做的事</h3>
            <ul>
              <li>给一组机组（容量+报价）和一个负荷，算出边际机组与出清价格。</li>
              <li>理解：当网络拥塞时，不同节点价格会不同（下一步讲）。</li>
            </ul>
          `,
          do: { widget: "marginalClear" },
          check: { type: "quiz", prompt: "如果负荷刚好落在报价为 0.30 的机组上，出清价一般取多少（简化边际出清）？", answer: "0.30" }
        },
        {
          id: "m2s2",
          title: "节点电价与拥塞：为什么会出现“价差”？",
          intro: "发电侧按节点电价结算；当断面/线路受限，某些区域供需更紧，节点电价会更高，形成阻塞（拥塞）价差。",
          explain: `
            <h3>动手练习</h3>
            <ul>
              <li>你可以拖动“线路容量”滑块，观察：容量越小→越容易拥塞→价差越大。</li>
              <li>阻塞盈余（简化理解）：价差 × 受限通道上的功率。</li>
            </ul>
          `,
          do: { widget: "nodalCongestion" },
          check: { type: "none" }
        }
      ]
    },

    {
      id: "m3",
      title: "3. 结算：参考点、电能电费与“全电量现货+差价合约”",
      desc: "把账算清楚：发电侧、用户侧、储能的差异",
      steps: [
        {
          id: "m3s0",
          title: "三类电价：节点电价 / 区域结算参考点 / 全网统一结算参考点",
          intro: "用户侧结算参考点电价按用电量加权平均得到；发电侧按所在节点电价结算；代理购电与居民农业可按全网统一结算参考点结算。",
          explain: `
            <div class="callout">
              这一步不求背条文，只求你在计算时知道“该用哪个价”。
            </div>
            <h3>记忆口诀</h3>
            <ul>
              <li><b>发电侧：节点价</b></li>
              <li><b>市场化用户：区域结算参考点价</b></li>
              <li><b>代购/居民农业：全网统一结算参考点价</b></li>
            </ul>

<div class="callout">
<b>2026规定要点（结算口径提醒）</b>
<ul>
  <li>结算参考点与节点电价口径按现货市场结算规则执行：发电侧按节点电价结算，用户侧按结算参考点电价结算（本关卡用加权平均演示“怎么取价”）。</li>
</ul>
</div>

`,
          do: { widget: "refPrice" },
          check: { type: "none" }
        },
        {
          id: "m3s1",
          title: "电能量电费：现货全电量 + 中长期差价合约",
          intro: "发电侧电能量电费=上网电量×节点价；中长期差价合约电费=（合约价-参考点价）×合约电量。用户侧类似但现货价取区域参考点。",
          explain: `
            <h3>动手：算一个“发电机组 + 用户”的小时账单</h3>
            <ul>
              <li>输入：现货价、合约价、合约电量、实际电量。</li>
              <li>输出：现货电费、差价合约电费、合计。</li>
            </ul>
          `,
          do: { widget: "settlementCalc" },
          check: { type: "none" }
        }
      ]
    },

    {
      id: "m4",
      title: "4. 阻塞盈余与分摊返还",
      desc: "价差产生“阻塞盈余”，怎么返还？",
      steps: [
        {
          id: "m4s0",
          title: "阻塞盈余返还（教学化）：价差×电量×曲线合理度修正",
          intro: "阻塞盈余返还可考虑“全网统一结算参考点电价与节点价差”，并叠加主体曲线合理度；返还电量比例可按全月曲线合理度修正。",
          explain: `
            <h3>你会得到什么能力</h3>
            <ul>
              <li>会算：阻塞盈余总额=价差×受限通道功率（简化）。</li>
              <li>会分：按各主体电量占比，再乘“曲线合理度”修正。</li>
            </ul>

<div class="callout">
<b>2026规定要点（阻塞盈余返还与曲线合理度）</b>
<ul>
  <li>阻塞盈余返还可考虑<b>全网统一结算参考点电价与节点价差</b>，并叠加主体<b>曲线合理度</b>进行返还（本关卡用“电量占比×合理度”示意分配步骤）。</li>
</ul>
</div>

`,
          do: { widget: "congestionRefund" },
          check: { type: "none" }
        },
        {
          id: "m4s1",
          title: "不平衡费用：发用双方按电量比例分摊/返还（了解即可）",
          intro: "发电企业与电力用户总电费差额形成的不平衡费用，可由发用双方按上网/用电量比例分摊或返还（新型经营主体不参与）。",
          explain: `
            <div class="callout">
              这一步的重点是：你知道“还有这一类费用”，并能在结算单里定位它。
            </div>
          `,
          do: { widget: "imbalanceNote" },
          check: { type: "none" }
        }
      ]
    },

    {
      id: "m5",
      title: "5. 重点：风险防范与曲线合理度（2026系数）",
      desc: "市场初期的“护栏”，也是交易员的“紧箍咒”",
      steps: [
        {
          id: "m5s0",
          title: "曲线合理度：取小值之和 / 取均值之和",
          intro: "曲线合理度（M）=全月各日清分时段中长期合约与实际计量取小值之和 ÷ 取均值之和（教学示例）。",
          explain: `
            <h3>动手：用 6 个点算出 M</h3>
            <ul>
              <li>输入两串数字：合约序列、计量序列。</li>
              <li>系统自动计算：每点取小值、取均值，汇总得到 M。</li>
            </ul>

<div class="callout">
<b>2026规定要点（曲线合理度M）</b>
<ul>
  <li>曲线合理度：<b>全月各日清分时段</b>中长期合约与实际计量<b>取小值之和</b> ÷ <b>取均值之和</b>。</li>
</ul>
</div>

`,
          do: { widget: "curveReasonable" },
          check: { type: "none" }
        },
        {
          id: "m5s1",
          title: "用户侧风险防范（2026系数）：普通用户与战新用户",
          intro: "市场初期：参与结算的电力用户风险防范前均价若超出允许范围，超出部分作补偿或回收。2026年明确了普通用户与战新用户的区间。",
          explain: `
            <h3>动手：输入 M → 得到允许偏差区间</h3>
            <ul>
              <li>选择<b>用户类型</b>（普通用户 / 战新用户）。</li>
              <li>输入 M（0~100%），得到“下限/上限”。</li>
            </ul>

<div class="callout">
<b>2026规定要点（风险防范比例区间）</b>
<ul>
  <li>用户（战新）：<b>80%~120%</b>；用户（非战新）：<b>65%~135%</b>。</li>
  <li>新能源（补贴）：<b>50%~145%</b>，并可与曲线合理度联动调整（详见下一步“发电侧风险防范”）。</li>
</ul>
</div>

`,
          do: { widget: "riskGuardUser" },
          check: { type: "none" }
        }
        ,
        {
          id: "m5s2",
          title: "发电侧风险防范（2026系数）：风电/光伏与联动调整",
          intro: "发电侧风险防范重点看新能源（风电/光伏）在曲线合理度不足时的动态放宽区间。这里把2026的阈值与上下限做成可算的“闯关计算器”。",
          explain: `
            <h3>动手：输入 M → 得到发电侧允许区间</h3>
            <ul>
              <li>选择发电类型：风电 / 光伏。</li>
              <li>输入曲线合理度 M（0~100%）。</li>
              <li>系统给出 2026 口径的“下限/上限”。</li>
            </ul>
            <div class="callout">
              <b>2026规定要点（宣贯口径）</b>
              <ul>
                <li>风电：M≥60 → 50%~145%；M&lt;60 → 35%~160。</li>
                <li>光伏：M≥80 → 50%~145%；M&lt;80 → 25%~170。</li>
              </ul>
            </div>
          `,
          do: { widget: "riskGuardGen" },
          check: { type: "none" }
        }

      ]
    },

    {
      id: "m6",
      title: "6. 辅助服务与需求侧响应（入门）",
      desc: "不仅电能量：调频、备用、需求响应…",
      steps: [
        {
          id: "m6s0",
          title: "需求侧响应：申报→出清→补偿（简化）",
          intro: "日前需求侧响应按流程申报容量和价格，调度按现货出清原理计算出清并形成节点出清价格；补偿费用可按“实际响应电量×出清价格”计算。",
          explain: `
            <h3>动手：用“采购响应容量”的小模型做一次出清</h3>
            <ul>
              <li>系统需求：需要采购 X MW 响应容量。</li>
              <li>你作为用户提交报价：容量+价格。</li>
              <li>系统按价格从低到高中标，直到凑够需求。</li>
            </ul>

<div class="callout">
<b>2026规定要点（需求侧响应价格范围）</b>
<ul>
  <li>日前需求侧响应：需求响应用户申报的响应价格应在<b>1.5元/千瓦时~10元/千瓦时</b>范围内（本关卡用“采购容量出清”演示机制）。</li>
</ul>
</div>

`,
          do: { widget: "demandResponse" },
          check: { type: "none" }
        }
      ]
    },

    {
      id: "m7",
      title: "7. 综合演练：从签约到结算（小型沙盘）",
      desc: "把中长期+现货+费用串起来",
      steps: [
        {
          id: "m7s0",
          title: "沙盘：你来完成一张“可解释的结算单”",
          intro: "你会选择一个角色，完成：签约→滚动撮合成交→现货价格→阻塞返还修正→风险防范判断→生成结算摘要。",
          explain: `
            <div class="callout">
              这是“把知识变成工作能力”的一步：输出能给领导/同事讲清楚的账。
            </div>
          `,
          do: { widget: "capstone" },
          check: { type: "none" }
        }
      ]
    }
  ]
};

</script>
<script>
// widgets.js
// 每个 widget 是一个函数： (rootEl, stepState, appApi) => cleanupFn?
// 约定：widget 内部的任何按钮都应可重复点击；不依赖网络。

(function(){
  const fmt = (n, d=4) => {
    if (n === null || n === undefined || Number.isNaN(n)) return "—";
    const p = Math.pow(10, d);
    return (Math.round(n*p)/p).toFixed(d).replace(/0+$/,'').replace(/\.$/,'');
  };
  const floor1 = (x) => Math.floor(x*10)/10;

  function el(tag, attrs={}, html=""){
    const e = document.createElement(tag);
    for(const [k,v] of Object.entries(attrs||{})){
      if(k === "class") e.className = v;
      else if(k === "style") e.setAttribute("style", v);
      else if(k.startsWith("on") && typeof v === "function") e.addEventListener(k.slice(2), v);
      else e.setAttribute(k, v);
    }
    if(html) e.innerHTML = html;
    return e;
  }

  function parseList(s){
    // 允许逗号/空格/换行分隔
    const arr = (s||"").trim().split(/[\s,，]+/).filter(Boolean).map(Number);
    return arr.filter(v => Number.isFinite(v));
  }

  const W = {};

  W.welcome = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div", {class:"widget"}, `
      <h4>开始方式</h4>
      <div class="tiny">左侧选择模块 → 右上角“下一步”逐步推进。每一步都能动手算。</div>
      <div class="kpi">
        <div class="k"><div class="kLabel">建议顺序</div><div class="kVal">中长期 → 现货 → 结算</div></div>
        <div class="k"><div class="kLabel">学习时长（示例）</div><div class="kVal">60–120 分钟</div></div>
        <div class="k"><div class="kLabel">完成奖励</div><div class="kVal">🎉 结算沙盘</div></div>
      </div>
      <div style="margin-top:12px;">
        <button class="smallBtn" id="btnDemo">一键跑通演示（自动跳转）</button>
      </div>
    `);
    root.appendChild(w);
    w.querySelector("#btnDemo").addEventListener("click", ()=>{
      api.jump("m1", 0);
    });
  };

  W.rollingMatch = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div", {class:"widget"});
    w.appendChild(el("h4", {}, "滚动撮合模拟器（单个时段/单点）"));

    const form = el("div", {class:"grid2"});
    const left = el("div", {class:"field"});
    left.appendChild(el("label", {}, "卖方要约（每行：价格 电量；例如：0.30 50）"));
    const sell = el("textarea", {}, "0.28 40\n0.30 40\n0.33 30");
    left.appendChild(sell);

    const right = el("div", {class:"field"});
    right.appendChild(el("label", {}, "买方要约（每行：价格 电量；例如：0.31 60）"));
    const buy = el("textarea", {}, "0.35 30\n0.32 40\n0.30 50");
    right.appendChild(buy);

    form.appendChild(left);
    form.appendChild(right);
    w.appendChild(form);

    const btnRow = el("div", {style:"display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;"});
    const btn = el("button", {class:"smallBtn"}, "开始撮合");
    const btnReset = el("button", {class:"smallBtn"}, "载入示例");
    btnRow.appendChild(btn); btnRow.appendChild(btnReset);
    w.appendChild(btnRow);

    const out = el("div", {class:"kpi"});
    w.appendChild(out);

    const table = el("table", {class:"table"});
    table.innerHTML = "<thead><tr><th>序号</th><th>买价</th><th>卖价</th><th>成交价(向下保留1位)</th><th>成交量</th></tr></thead><tbody></tbody>";
    w.appendChild(table);

    const note = el("div", {class:"tiny"}, "算法说明：买方按“价格高→时间先”排序；卖方按“价格低→时间先”排序。匹配后成交价=双方报价算术平均并向下保留1位小数。");
    w.appendChild(note);

    function parseOrders(text){
      return (text||"").trim().split(/\n+/).map((line, idx)=>{
        const parts = line.trim().split(/[\s,，]+/).filter(Boolean);
        const p = Number(parts[0]); const q = Number(parts[1]);
        if(!Number.isFinite(p) || !Number.isFinite(q)) return null;
        return {p, q, t: idx};
      }).filter(Boolean);
    }

    function match(){
      const sells = parseOrders(sell.value).sort((a,b)=> a.p-b.p || a.t-b.t);
      const buys = parseOrders(buy.value).sort((a,b)=> b.p-a.p || a.t-b.t);

      let i=0, j=0, traded=0, deals=[];
      while(i<buys.length && j<sells.length){
        const B = buys[i], S = sells[j];
        if(B.p < S.p) break; // 价差不满足则不成交
        const q = Math.min(B.q, S.q);
        const dealP = floor1((B.p + S.p)/2);
        deals.push({buy: B.p, sell: S.p, price: dealP, qty: q});
        traded += q;
        B.q -= q; S.q -= q;
        if(B.q <= 1e-9) i++;
        if(S.q <= 1e-9) j++;
      }

      const avg = deals.length ? deals.reduce((s,d)=> s + d.price*d.qty, 0)/traded : 0;
      out.innerHTML = "";
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">成交笔数</div><div class="kVal">${deals.length}</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">总成交量</div><div class="kVal">${fmt(traded,0)} MW</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">加权平均成交价</div><div class="kVal">${deals.length?fmt(avg,4):"—"}</div>`));

      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";
      deals.forEach((d, idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${idx+1}</td><td>${fmt(d.buy,3)}</td><td>${fmt(d.sell,3)}</td><td><b>${fmt(d.price,1)}</b></td><td>${fmt(d.qty,0)}</td>`;
        tbody.appendChild(tr);
      });

      // 标记本步完成
      api.markDone(true);
    }

    btn.addEventListener("click", match);
    btnReset.addEventListener("click", ()=>{
      sell.value = "0.28 40\n0.30 40\n0.33 30";
      buy.value = "0.35 30\n0.32 40\n0.30 50";
    });

    root.appendChild(w);
  };

  W.curveBasics = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div", {class:"widget"}, `
      <h4>电力曲线小练习（4 点缩小版）</h4>
      <div class="tiny">把“电量”拆成“每点电力”，更容易与现货/结算衔接。</div>
    `);

    const grid = el("div", {class:"grid2"});
    const a = el("div", {class:"field"});
    a.appendChild(el("label", {}, "输入 4 点电力（MW），用空格/逗号分隔"));
    const inp = el("input", {value:"80 90 110 100"});
    a.appendChild(inp);

    const b = el("div", {class:"field"});
    b.appendChild(el("label", {}, "每点时长（分钟）"));
    const dur = el("input", {type:"number", value:"15", min:"1"});
    b.appendChild(dur);

    grid.appendChild(a); grid.appendChild(b);
    w.appendChild(grid);

    const btn = el("button", {class:"smallBtn", style:"margin-top:10px;"}, "生成电量与曲线摘要");
    w.appendChild(btn);

    const out = el("div", {class:"kpi"});
    w.appendChild(out);

    const pre = el("div", {class:"tiny", style:"margin-top:10px; white-space:pre-wrap;"});
    w.appendChild(pre);

    btn.addEventListener("click", ()=>{
      const pts = parseList(inp.value);
      const minutes = Number(dur.value);
      const hours = minutes/60;
      const energy = pts.reduce((s,p)=> s + p*hours, 0);
      const peak = Math.max(...pts);
      const valley = Math.min(...pts);
      const avg = pts.reduce((s,p)=> s+p,0)/pts.length;

      out.innerHTML = "";
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">总电量</div><div class="kVal">${fmt(energy,2)} MWh</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">峰/谷</div><div class="kVal">${fmt(peak,0)} / ${fmt(valley,0)} MW</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">平均电力</div><div class="kVal">${fmt(avg,1)} MW</div>`));

      pre.textContent = `点序号:  1   2   3   4\n电力MW: ${pts.map(p=>String(p).padStart(3,' ')).join(' ')}`;
      api.markDone(true);
    });

    root.appendChild(w);
  };

  W.stagePicker = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div", {class:"widget"}, `
      <h4>月内分段标的：选择阶段 → 生成示例曲线</h4>
      <div class="tiny">教学化：近端用“每日96点”，远端用“四小时直线”。</div>
    `);

    const g = el("div", {class:"grid2"});
    const f1 = el("div",{class:"field"});
    f1.appendChild(el("label",{},"阶段（以 D=今天）"));
    const sel = el("select",{});
    sel.innerHTML = `
      <option value="d1-10">D+1 ~ 10（更精细）</option>
      <option value="d1-20">D+1 ~ 20（中等精细）</option>
      <option value="d1-eom">D+1 ~ 月底（更粗粒度）</option>
    `;
    f1.appendChild(sel);

    const f2 = el("div",{class:"field"});
    f2.appendChild(el("label",{},"示例峰值电力（MW）"));
    const peak = el("input",{type:"number", value:"120", min:"1"});
    f2.appendChild(peak);
    g.appendChild(f1); g.appendChild(f2);
    w.appendChild(g);

    const btn = el("button", {class:"smallBtn", style:"margin-top:10px;"}, "生成示例");
    const out = el("div", {class:"tiny", style:"margin-top:10px; white-space:pre-wrap;"});
    w.appendChild(btn); w.appendChild(out);

    btn.addEventListener("click", ()=>{
      const p = Number(peak.value);
      const v = sel.value;
      if(v === "d1-10"){
        out.textContent = `标的：每日96点（示例仅显示 8 点）\n` +
          `04:00 ${Math.round(p*0.40)}  08:00 ${Math.round(p*0.70)}  10:00 ${Math.round(p*0.90)}  12:00 ${Math.round(p)}\n` +
          `14:00 ${Math.round(p*0.95)}  18:00 ${Math.round(p*0.75)}  20:00 ${Math.round(p*0.55)}  24:00 ${Math.round(p*0.35)}`;
      }else{
        out.textContent = `标的：四小时直线（示例）\n` +
          `00-04 ${Math.round(p*0.40)} MW\n04-08 ${Math.round(p*0.65)} MW\n08-12 ${Math.round(p*0.90)} MW\n12-16 ${Math.round(p)} MW\n16-20 ${Math.round(p*0.80)} MW\n20-24 ${Math.round(p*0.50)} MW`;
      }
      api.markDone(true);
    });

    root.appendChild(w);
  };

  W.spotStructure = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div", {class:"widget"}, `
      <h4>现货市场结构（卡片）</h4>
      <div class="kpi">
        <div class="k"><div class="kLabel">初期</div><div class="kVal">仅实时电能量交易</div></div>
        <div class="k"><div class="kLabel">日前</div><div class="kVal">可靠性机组组合 & 预出清</div></div>
        <div class="k"><div class="kLabel">日内</div><div class="kVal">适时开展</div></div>
      </div>
      <div class="tiny" style="margin-top:8px;">动手：点击按钮，看“计划→实时”的信息流。</div>
    `);
    const btn = el("button",{class:"smallBtn", style:"margin-top:10px;"}, "播放信息流");
    const box = el("div",{class:"diagram", style:"margin-top:10px; height:200px;"});
    w.appendChild(btn); w.appendChild(box);

    const nodes = [
      {id:"D-1", x:40, y:110},
      {id:"日前", x:170, y:45},
      {id:"实时", x:310, y:110},
      {id:"结算", x:450, y:45},
    ];
    function draw(flow=0){
      box.innerHTML="";
      nodes.forEach(n=>{
        const nd = el("div",{class:"node", style:`left:${n.x}px; top:${n.y}px;`}, n.id);
        box.appendChild(nd);
      });
      // lines
      const L1 = el("div",{class:"line", style:`left:70px; top:130px; width:130px; transform: rotate(-25deg);`});
      const L2 = el("div",{class:"line", style:`left:205px; top:110px; width:150px; transform: rotate(0deg);`});
      const L3 = el("div",{class:"line", style:`left:340px; top:95px; width:150px; transform: rotate(-25deg);`});
      box.appendChild(L1); box.appendChild(L2); box.appendChild(L3);

      if(flow>=1){
        box.appendChild(el("div",{class:"flow", style:`left:70px; top:130px; width:130px; transform: rotate(-25deg);`}));
      }
      if(flow>=2){
        box.appendChild(el("div",{class:"flow", style:`left:205px; top:110px; width:150px; transform: rotate(0deg);`}));
      }
      if(flow>=3){
        box.appendChild(el("div",{class:"flow", style:`left:340px; top:95px; width:150px; transform: rotate(-25deg);`}));
      }
    }
    draw(0);

    btn.addEventListener("click", async ()=>{
      draw(1); await new Promise(r=>setTimeout(r, 500));
      draw(2); await new Promise(r=>setTimeout(r, 500));
      draw(3);
      api.markDone(true);
    });

    root.appendChild(w);
  };

  W.marginalClear = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div", {class:"widget"});
    w.appendChild(el("h4",{}, "边际出清小算例"));

    const grid = el("div", {class:"grid2"});
    const f1 = el("div",{class:"field"});
    f1.appendChild(el("label",{}, "机组列表（每行：报价 容量；例如：0.20 100）"));
    const gen = el("textarea",{}, "0.18 50\n0.22 60\n0.30 80\n0.45 100");
    f1.appendChild(gen);

    const f2 = el("div",{class:"field"});
    f2.appendChild(el("label",{}, "系统负荷（MW）"));
    const load = el("input",{type:"number", value:"140", min:"0"});
    f2.appendChild(load);

    grid.appendChild(f1); grid.appendChild(f2);
    w.appendChild(grid);

    const btn = el("button",{class:"smallBtn", style:"margin-top:10px;"}, "计算出清");
    w.appendChild(btn);

    const out = el("div", {class:"kpi"});
    w.appendChild(out);

    const tbody = el("tbody");
    const table = el("table",{class:"table"});
    table.innerHTML = "<thead><tr><th>机组</th><th>报价</th><th>容量</th><th>出清量</th></tr></thead>";
    table.appendChild(tbody);
    w.appendChild(table);

    function parse(text){
      return (text||"").trim().split(/\n+/).map((line, idx)=>{
        const [p,q] = line.trim().split(/[\s,，]+/).map(Number);
        if(!Number.isFinite(p) || !Number.isFinite(q)) return null;
        return {id: idx+1, p, cap:q};
      }).filter(Boolean).sort((a,b)=> a.p-b.p || a.id-b.id);
    }

    btn.addEventListener("click", ()=>{
      const units = parse(gen.value);
      let L = Number(load.value);
      let price = null, marginal = null;
      tbody.innerHTML="";
      units.forEach(u=>{
        const take = Math.max(0, Math.min(u.cap, L));
        L -= take;
        if(take>0 && (price===null || u.p>=price)){
          price = u.p;
          marginal = u.id;
        }
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${u.id}</td><td>${fmt(u.p,3)}</td><td>${fmt(u.cap,0)}</td><td>${fmt(take,0)}</td>`;
        tbody.appendChild(tr);
      });

      out.innerHTML = "";
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">边际机组</div><div class="kVal">${marginal ?? "—"}</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">出清价格（简化）</div><div class="kVal">${price!==null?fmt(price,2):"—"}</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">是否供电不足</div><div class="kVal">${L>0?("缺口 "+fmt(L,0)+" MW"):"否"}</div>`));

      api.markDone(true);
    });

    root.appendChild(w);
  };

  W.nodalCongestion = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div", {class:"widget"});
    w.appendChild(el("h4",{}, "三节点拥塞演示（教学化 DC 简化）"));
    w.appendChild(el("div",{class:"tiny"}, "A 为富余电源区，C 为负荷区，中间线路容量越小越容易拥塞。"));

    const diag = el("div",{class:"diagram", style:"margin-top:10px;"});
    w.appendChild(diag);

    const controls = el("div",{class:"grid2", style:"margin-top:10px;"});
    const f1 = el("div",{class:"field"});
    f1.appendChild(el("label",{},"线路容量（A→C）MW"));
    const cap = el("input",{type:"range", min:"20", max:"140", value:"80"});
    f1.appendChild(cap);

    const f2 = el("div",{class:"field"});
    f2.appendChild(el("label",{},"C区负荷（MW）"));
    const load = el("input",{type:"number", min:"20", max:"200", value:"120"});
    f2.appendChild(load);

    controls.appendChild(f1); controls.appendChild(f2);
    w.appendChild(controls);

    const kpi = el("div",{class:"kpi"});
    w.appendChild(kpi);

    function render(){
      const CAP = Number(cap.value);
      const L = Number(load.value);

      // 教学化：A 区发电成本低 0.20，C 区本地补充电源成本高 0.40
      // 若线路容量不足，C 区要启用本地高成本电源，导致节点价升高。
      const importMW = Math.min(CAP, L);
      const localMW = Math.max(0, L - importMW);

      const priceA = 0.20;
      const priceC = localMW>0 ? 0.40 : 0.20;
      const priceB = (priceA + priceC)/2; // 只是示意

      const congestionAdder = Math.max(0, priceC - priceA);
      const congSurplus = congestionAdder * importMW; // 教学化：价差×流

      diag.innerHTML="";
      const A = el("div",{class:"node", style:"left:60px; top:120px;"}, "A");
      const B = el("div",{class:"node", style:"left:220px; top:50px;"}, "B");
      const C = el("div",{class:"node", style:"left:380px; top:120px;"}, "C");
      diag.appendChild(A); diag.appendChild(B); diag.appendChild(C);

      // lines A-B, B-C
      const lineAB = el("div",{class:"line", style:"left:98px; top:140px; width:180px; transform: rotate(-25deg);"});
      const lineBC = el("div",{class:"line", style:"left:258px; top:110px; width:180px; transform: rotate(25deg);"});
      diag.appendChild(lineAB); diag.appendChild(lineBC);

      // flow overlay indicates congestion level
      const fWidth = 180*(importMW/140);
      const flowAB = el("div",{class:"flow", style:`left:98px; top:140px; width:${Math.max(30,fWidth)}px; transform: rotate(-25deg);`});
      const flowBC = el("div",{class:"flow", style:`left:258px; top:110px; width:${Math.max(30,fWidth)}px; transform: rotate(25deg);`});
      diag.appendChild(flowAB); diag.appendChild(flowBC);

      const badge = localMW>0 ? "<span class='badge warn'>发生拥塞：C区启用本地高成本电源</span>" : "<span class='badge good'>未拥塞：A区电源可满足C区</span>";
      kpi.innerHTML = "";
      kpi.appendChild(el("div",{class:"k"}, `<div class="kLabel">节点价（示意）</div><div class="kVal">A ${fmt(priceA,2)} / B ${fmt(priceB,2)} / C ${fmt(priceC,2)}</div>`));
      kpi.appendChild(el("div",{class:"k"}, `<div class="kLabel">A→C 输送 / 本地补充</div><div class="kVal">${fmt(importMW,0)} / ${fmt(localMW,0)} MW</div>`));
      kpi.appendChild(el("div",{class:"k"}, `<div class="kLabel">阻塞盈余（价差×流，示意）</div><div class="kVal">${fmt(congSurplus,2)} （元/时）</div>`));
      kpi.appendChild(el("div",{class:"k"}, `<div class="kLabel">状态</div><div class="kVal">${badge}</div>`));

      api.markDone(true);
    }

    cap.addEventListener("input", render);
    load.addEventListener("input", render);
    render();

    root.appendChild(w);
  };

  W.refPrice = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div",{class:"widget"}, `
      <h4>参考点电价小练习（加权平均）</h4>
      <div class="tiny">教学化：把“用户侧各节点电价×下网电量”加权平均得到参考点电价。</div>
    `);

    const grid = el("div",{class:"grid3"});
    const n1 = el("div",{class:"field"});
    n1.appendChild(el("label",{},"节点1 电价 / 电量"));
    const p1 = el("input",{value:"0.28"}); const q1 = el("input",{value:"50"});
    n1.appendChild(el("div",{class:"grid2"}, ""));
    n1.lastChild.appendChild(p1); n1.lastChild.appendChild(q1);

    const n2 = el("div",{class:"field"});
    n2.appendChild(el("label",{},"节点2 电价 / 电量"));
    const p2 = el("input",{value:"0.31"}); const q2 = el("input",{value:"30"});
    n2.appendChild(el("div",{class:"grid2"}, ""));
    n2.lastChild.appendChild(p2); n2.lastChild.appendChild(q2);

    const n3 = el("div",{class:"field"});
    n3.appendChild(el("label",{},"节点3 电价 / 电量"));
    const p3 = el("input",{value:"0.26"}); const q3 = el("input",{value:"20"});
    n3.appendChild(el("div",{class:"grid2"}, ""));
    n3.lastChild.appendChild(p3); n3.lastChild.appendChild(q3);

    grid.appendChild(n1); grid.appendChild(n2); grid.appendChild(n3);
    w.appendChild(grid);

    const btn = el("button",{class:"smallBtn", style:"margin-top:10px;"}, "计算参考点电价");
    w.appendChild(btn);

    const out = el("div",{class:"kpi"});
    w.appendChild(out);

    btn.addEventListener("click", ()=>{
      const P = [Number(p1.value), Number(p2.value), Number(p3.value)];
      const Q = [Number(q1.value), Number(q2.value), Number(q3.value)];
      const sumQ = Q.reduce((s,x)=>s+x,0);
      const ref = sumQ>0 ? (P[0]*Q[0]+P[1]*Q[1]+P[2]*Q[2])/sumQ : 0;
      out.innerHTML="";
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">总电量</div><div class="kVal">${fmt(sumQ,0)} MWh（示例）</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">参考点电价</div><div class="kVal">${fmt(ref,4)}</div>`));
      api.markDone(true);
    });

    root.appendChild(w);
  };

  W.settlementCalc = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div",{class:"widget"});
    w.appendChild(el("h4",{}, "电能量电费计算器（单时段/单点）"));
    w.appendChild(el("div",{class:"tiny"}, "输入价格与电量，系统给出：现货电费、差价合约电费、合计。"));

    const g = el("div",{class:"grid2"});
    const left = el("div",{class:"field"});
    left.appendChild(el("label",{},"角色"));
    const role = el("select",{});
    role.innerHTML = `
      <option value="gen">发电侧（节点价）</option>
      <option value="user">用户侧（区域参考点价）</option>
      <option value="storageCharge">储能充电（节点价）</option>
    `;
    left.appendChild(role);

    const right = el("div",{class:"field"});
    right.appendChild(el("label",{},"现货结算电价（元/千瓦时）"));
    const spotP = el("input",{value:"0.30"});
    right.appendChild(spotP);

    g.appendChild(left); g.appendChild(right);
    w.appendChild(g);

    const g2 = el("div",{class:"grid3", style:"margin-top:10px;"});
    const f1 = el("div",{class:"field"}); f1.appendChild(el("label",{},"实际电量（MWh）")); const actualQ = el("input",{value:"100"}); f1.appendChild(actualQ);
    const f2 = el("div",{class:"field"}); f2.appendChild(el("label",{},"合约电量（MWh）")); const contractQ = el("input",{value:"80"}); f2.appendChild(contractQ);
    const f3 = el("div",{class:"field"}); f3.appendChild(el("label",{},"合约电价（元/千瓦时）")); const contractP = el("input",{value:"0.29"}); f3.appendChild(contractP);
    g2.appendChild(f1); g2.appendChild(f2); g2.appendChild(f3);
    w.appendChild(g2);

    const btn = el("button",{class:"smallBtn", style:"margin-top:10px;"}, "计算电费");
    w.appendChild(btn);

    const out = el("div",{class:"kpi"});
    w.appendChild(out);

    const formula = el("div",{class:"tiny", style:"margin-top:10px; white-space:pre-wrap;"});
    w.appendChild(formula);

    btn.addEventListener("click", ()=>{
      const Pspot = Number(spotP.value);
      const Qact = Number(actualQ.value);
      const Qc = Number(contractQ.value);
      const Pc = Number(contractP.value);

      const spotFee = Qact * Pspot;
      // 差价合约： (合约价 - 参考点价) × 合约电量
      // 教学化：这里把“参考点价”直接用输入的现货结算价代表
      const diffFee = (Pc - Pspot) * Qc;
      const total = spotFee + diffFee;

      out.innerHTML="";
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">现货全电量电费</div><div class="kVal">${fmt(spotFee,2)}</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">中长期差价合约电费</div><div class="kVal">${fmt(diffFee,2)}</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">合计</div><div class="kVal">${fmt(total,2)}</div>`));

      formula.textContent =
`计算：
1）现货全电量电费 = 实际电量 × 现货结算电价 = ${fmt(Qact,2)} × ${fmt(Pspot,4)} = ${fmt(spotFee,2)}
2）差价合约电费 = (合约价 - 参考点价) × 合约电量
   （教学化：这里用“现货结算价”代表参考点价）
   = (${fmt(Pc,4)} - ${fmt(Pspot,4)}) × ${fmt(Qc,2)} = ${fmt(diffFee,2)}
3）合计 = ${fmt(total,2)}
`;

      api.markDone(true);
    });

    root.appendChild(w);
  };

  W.congestionRefund = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div",{class:"widget"});
    w.appendChild(el("h4",{}, "阻塞盈余返还计算器（教学化）"));
    w.appendChild(el("div",{class:"tiny"}, "示意规则：按电量占比+曲线合理度修正分配（用于理解步骤）。"));

    const g = el("div",{class:"grid2"});
    const left = el("div",{class:"field"});
    left.appendChild(el("label",{},"阻塞盈余总额（元）"));
    const total = el("input",{value:"12000"});
    left.appendChild(total);

    const right = el("div",{class:"field"});
    right.appendChild(el("label",{},"分配对象数量（主体数）"));
    const n = el("input",{type:"number", value:"3", min:"2", max:"8"});
    right.appendChild(n);
    g.appendChild(left); g.appendChild(right);
    w.appendChild(g);

    const btn = el("button",{class:"smallBtn", style:"margin-top:10px;"}, "生成主体并计算");
    w.appendChild(btn);

    const area = el("div",{style:"margin-top:10px;"});
    w.appendChild(area);

    function build(k){
      area.innerHTML="";
      const table = el("table",{class:"table"});
      table.innerHTML = "<thead><tr><th>主体</th><th>电量（MWh）</th><th>曲线合理度 k（0~1）</th><th>修正权重=电量×k</th><th>返还额</th></tr></thead><tbody></tbody>";
      const tb = table.querySelector("tbody");

      const rows = [];
      for(let i=0;i<k;i++){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>主体${i+1}</td>
          <td><input data-q type="number" value="${(i===0?120:i===1?80:60)}" min="0" style="width:120px;"></td>
          <td><input data-k type="number" value="${(i===0?0.95:i===1?0.85:0.70)}" min="0" max="1" step="0.01" style="width:120px;"></td>
          <td data-w class="mono">—</td>
          <td data-r class="mono"><b>—</b></td>`;
        tb.appendChild(tr);
        rows.push(tr);
      }

      const kpi = el("div",{class:"kpi"});
      area.appendChild(table);
      area.appendChild(kpi);

      function recalc(){
        const T = Number(total.value);
        const ws = rows.map(tr=>{
          const q = Number(tr.querySelector("[data-q]").value);
          const kk = Number(tr.querySelector("[data-k]").value);
          const w = q*kk;
          tr.querySelector("[data-w]").textContent = fmt(w,2);
          return w;
        });
        const sumW = ws.reduce((s,x)=>s+x,0);

        rows.forEach((tr, idx)=>{
          const wv = ws[idx];
          const r = sumW>0 ? T*(wv/sumW) : 0;
          tr.querySelector("[data-r]").innerHTML = `<b>${fmt(r,2)}</b>`;
        });

        kpi.innerHTML="";
        kpi.appendChild(el("div",{class:"k"}, `<div class="kLabel">总修正权重</div><div class="kVal">${fmt(sumW,2)}</div>`));
        kpi.appendChild(el("div",{class:"k"}, `<div class="kLabel">提示</div><div class="kVal">k 越高、返还越多</div>`));
        api.markDone(true);
      }

      rows.forEach(tr=>{
        tr.querySelector("[data-q]").addEventListener("input", recalc);
        tr.querySelector("[data-k]").addEventListener("input", recalc);
      });
      total.addEventListener("input", recalc);
      recalc();
    }

    btn.addEventListener("click", ()=> build(Number(n.value)));
    build(3);

    root.appendChild(w);
  };

  W.imbalanceNote = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div",{class:"widget"}, `
      <h4>不平衡费用（定位练习）</h4>
      <div class="tiny">在结算结果里看到“不平衡费用”时，先问 3 个问题：</div>
      <ul>
        <li>这是“发用总电费差额”形成的吗？</li>
        <li>是否按上网/用电量比例分摊或返还？</li>
        <li>是否有主体不参与（如新型经营主体）？</li>
      </ul>
      <div class="callout">建议做法：把结算单按“电能量电费→成本补偿→市场平衡→市场调节”分层看。</div>
    `);
    root.appendChild(w);
    api.markDone(true);
  };

  W.curveReasonable = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div",{class:"widget"});
    w.appendChild(el("h4",{}, "曲线合理度（M）计算器（教学版：6点缩小）"));
    w.appendChild(el("div",{class:"tiny"}, "输入合约序列与计量序列：M = Σmin(合约,计量) / Σavg(合约,计量)。"));

    const grid = el("div",{class:"grid2"});
    const a = el("div",{class:"field"});
    a.appendChild(el("label",{},"合约序列（6个数）"));
    const c = el("input",{value:"10 20 24 12 18 16"});
    a.appendChild(c);

    const b = el("div",{class:"field"});
    b.appendChild(el("label",{},"计量序列（6个数）"));
    const m = el("input",{value:"8 30 20 8 22 14"});
    b.appendChild(m);

    grid.appendChild(a); grid.appendChild(b);
    w.appendChild(grid);

    const btn = el("button",{class:"smallBtn", style:"margin-top:10px;"}, "计算 M");
    w.appendChild(btn);

    const out = el("div",{class:"kpi"});
    w.appendChild(out);

    const detail = el("div",{class:"tiny", style:"margin-top:10px; white-space:pre-wrap;"});
    w.appendChild(detail);

    btn.addEventListener("click", ()=>{
      const C = parseList(c.value);
      const M = parseList(m.value);
      const n = Math.min(C.length, M.length);
      if(n===0){
        out.innerHTML="";
        detail.textContent="请输入数据。";
        return;
      }
      let sumMin=0, sumAvg=0;
      let lines=[];
      for(let i=0;i<n;i++){
        const mi = Math.min(C[i], M[i]);
        const av = (C[i]+M[i])/2;
        sumMin += mi; sumAvg += av;
        lines.push(`${i+1}: 合约${C[i]} 计量${M[i]} 取小${fmt(mi,2)} 取均${fmt(av,2)}`);
      }
      const ratio = sumAvg>0 ? sumMin/sumAvg : 0;
      out.innerHTML="";
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">Σ取小值</div><div class="kVal">${fmt(sumMin,2)}</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">Σ取均值</div><div class="kVal">${fmt(sumAvg,2)}</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">曲线合理度 M</div><div class="kVal">${fmt(ratio*100,2)}%</div>`));
      detail.textContent = lines.join("\n");
      api.markDone(true);
    });

    root.appendChild(w);
  };

  W.riskGuardUser = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div",{class:"widget"});
    w.appendChild(el("h4",{}, "用户侧风险防范区间（2026系数）"));
    w.appendChild(el("div",{class:"tiny"}, "按2026宣贯口径：普通用户 65%~135%，战新用户 80%~120%。当普通用户曲线合理度 M 未达标（M<70）时，区间一次性放宽为 47.5%~152.5%。"));

    const grid = el("div",{class:"grid2"});
    const f1 = el("div",{class:"field"}); f1.appendChild(el("label",{},"用户类型"));
    const type = el("select",{});
    type.innerHTML = `
      <option value="normal">普通用户</option>
      <option value="zx">战新用户</option>
    `;
    f1.appendChild(type);

    const f2 = el("div",{class:"field"}); f2.appendChild(el("label",{},"曲线合理度 M（%）"));
    const M = el("input",{type:"number", value:"85", min:"0", max:"100"});
    f2.appendChild(M);

    grid.appendChild(f1); grid.appendChild(f2);
    w.appendChild(grid);

    const btn = el("button",{class:"smallBtn", style:"margin-top:10px;"}, "计算允许区间");
    w.appendChild(btn);

    const out = el("div",{class:"kpi"});
    w.appendChild(out);

    function calc(){
      const t = type.value;
      const m = Number(M.value);
      let thr = 70;
      let lo, hi, lo2, hi2, note;

      if(t === "zx"){
        // 战新区间在宣贯材料中以括号给出：80%~120%
        lo = 80; hi = 120;
        lo2 = lo; hi2 = hi;
        note = "战新用户区间：80%~120%（以宣贯口径为准）";
      }else{
        lo = 65; hi = 135;
        if(m >= thr){
          lo2 = lo; hi2 = hi;
          note = "M 达标（≥70%）：按 65%~135%";
        }else{
          // 宣贯示例：放宽幅度 (65-30)/2 = 17.5 → 47.5%~152.5%
          lo2 = 47.5; hi2 = 152.5;
          note = "M 未达标（<70%）：区间放宽为 47.5%~152.5%（宣贯示例）";
        }
      }

      out.innerHTML="";
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">曲线合理度阈值</div><div class="kVal">${thr}%（普通用户）</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">允许下限</div><div class="kVal">${fmt(lo2,2)}%</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">允许上限</div><div class="kVal">${fmt(hi2,2)}%</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">说明</div><div class="kVal">${note}</div>`));
      api.markDone(true);
    }

    btn.addEventListener("click", calc);
    type.addEventListener("change", calc);
    calc();

    root.appendChild(w);
  };

  W.riskGuardGen = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div",{class:"widget"});
    w.appendChild(el("h4",{}, "发电侧风险防范区间（2026系数：风电/光伏）"));
    w.appendChild(el("div",{class:"tiny"}, "按2026宣贯口径：风电 M≥60 → 50%~145，M<60 → 35%~160；光伏 M≥80 → 50%~145，M<80 → 25%~170。"));

    const grid = el("div",{class:"grid2"});
    const f1 = el("div",{class:"field"}); f1.appendChild(el("label",{},"发电类型"));
    const type = el("select",{});
    type.innerHTML = `
      <option value="wind">风电</option>
      <option value="pv">光伏</option>
    `;
    f1.appendChild(type);

    const f2 = el("div",{class:"field"}); f2.appendChild(el("label",{},"曲线合理度 M（%）"));
    const M = el("input",{type:"number", value:"75", min:"0", max:"100"});
    f2.appendChild(M);

    grid.appendChild(f1); grid.appendChild(f2);
    w.appendChild(grid);

    const btn = el("button",{class:"smallBtn", style:"margin-top:10px;"}, "计算允许区间");
    w.appendChild(btn);

    const out = el("div",{class:"kpi"});
    w.appendChild(out);

    function calc(){
      const t = type.value;
      const m = Number(M.value);

      let thr, lo, hi, lo2, hi2, note;
      if(t==="wind"){
        thr = 60; lo = 50; hi = 145;
        if(m >= thr){ lo2=lo; hi2=hi; note="M 达标（≥60%）：50%~145%"; }
        else { lo2=35; hi2=160; note="M 未达标（<60%）：区间放宽为 35%~160%（宣贯示例）"; }
      }else{
        thr = 80; lo = 50; hi = 145;
        if(m >= thr){ lo2=lo; hi2=hi; note="M 达标（≥80%）：50%~145%"; }
        else { lo2=25; hi2=170; note="M 未达标（<80%）：区间放宽为 25%~170%（宣贯示例）"; }
      }

      out.innerHTML="";
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">阈值 M</div><div class="kVal">${thr}%</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">允许下限</div><div class="kVal">${fmt(lo2,2)}%</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">允许上限</div><div class="kVal">${fmt(hi2,2)}%</div>`));
      out.appendChild(el("div",{class:"k"}, `<div class="kLabel">说明</div><div class="kVal">${note}</div>`));
      api.markDone(true);
    }

    btn.addEventListener("click", calc);
    type.addEventListener("change", calc);
    calc();

    root.appendChild(w);
  };

  W.demandResponse = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div",{class:"widget"});
    w.appendChild(el("h4",{}, "需求侧响应出清（采购容量简化模型）"));
    w.appendChild(el("div",{class:"tiny"}, "输入系统需求（MW），添加多个报价（容量+价格），按价格从低到高中标直到满足需求。"));

    const g = el("div",{class:"grid2"});
    const f1 = el("div",{class:"field"}); f1.appendChild(el("label",{},"系统需求（MW）"));
    const need = el("input",{type:"number", value:"60", min:"1"}); f1.appendChild(need);

    const f2 = el("div",{class:"field"}); f2.appendChild(el("label",{},"你的报价（容量MW / 价格元/MWh）"));
    const cap = el("input",{type:"number", value:"20", min:"1"});
    const price = el("input",{type:"number", value:"200", min:"100", max:"1500"});
    const wrap = el("div",{class:"grid2"});
    wrap.appendChild(cap); wrap.appendChild(price);
    f2.appendChild(wrap);

    g.appendChild(f1); g.appendChild(f2);
    w.appendChild(g);

    const btnRow = el("div",{style:"display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;"});
    const btnAdd = el("button",{class:"smallBtn"}, "添加一条报价");
    const btnRun = el("button",{class:"smallBtn"}, "出清");
    const btnDemo = el("button",{class:"smallBtn"}, "载入示例");
    btnRow.appendChild(btnAdd); btnRow.appendChild(btnRun); btnRow.appendChild(btnDemo);
    w.appendChild(btnRow);

    const bids = [];
    const table = el("table",{class:"table"});
    table.innerHTML = "<thead><tr><th>#</th><th>容量(MW)</th><th>价格(元/MWh)</th><th>是否中标</th></tr></thead><tbody></tbody>";
    const tbody = table.querySelector("tbody");
    w.appendChild(table);

    const kpi = el("div",{class:"kpi"});
    w.appendChild(kpi);

    function render(){
      tbody.innerHTML="";
      bids.forEach((b, idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${idx+1}</td><td>${fmt(b.cap,0)}</td><td>${fmt(b.price,0)}</td><td>${b.win? "<span class='badge good'>中标</span>":"<span class='badge'>未中标</span>"}</td>`;
        tbody.appendChild(tr);
      });
    }

    btnAdd.addEventListener("click", ()=>{
      const c = Number(cap.value), p = Number(price.value);
      if(!Number.isFinite(c)||!Number.isFinite(p)) return;
      bids.push({cap:c, price:p, win:false});
      render();
    });

    btnDemo.addEventListener("click", ()=>{
      bids.length=0;
      bids.push({cap:20, price:180, win:false});
      bids.push({cap:25, price:240, win:false});
      bids.push({cap:30, price:320, win:false});
      bids.push({cap:15, price:260, win:false});
      render();
    });
    btnDemo.click();

    btnRun.addEventListener("click", ()=>{
      bids.forEach(b=>b.win=false);
      const N = Number(need.value);
      let left = N;
      // 价格从低到高
      const sorted = bids.map((b,idx)=>({b,idx})).sort((x,y)=> x.b.price-y.b.price || x.idx-y.idx);
      for(const it of sorted){
        if(left<=0) break;
        it.b.win = true;
        left -= it.b.cap;
      }
      render();

      const won = bids.filter(b=>b.win);
      const got = won.reduce((s,b)=>s+b.cap,0);
      const clePrice = won.length ? Math.max(...won.map(b=>b.price)) : 0; // 简化：边际中标价
      const pay = won.reduce((s,b)=> s + b.cap*clePrice, 0); // 教学化：统一结算价
      kpi.innerHTML="";
      kpi.appendChild(el("div",{class:"k"}, `<div class="kLabel">需求/中标</div><div class="kVal">${fmt(N,0)} / ${fmt(got,0)} MW</div>`));
      kpi.appendChild(el("div",{class:"k"}, `<div class="kLabel">简化出清价</div><div class="kVal">${fmt(clePrice,0)} 元/MWh</div>`));
      kpi.appendChild(el("div",{class:"k"}, `<div class="kLabel">补偿金额（示意）</div><div class="kVal">${fmt(pay,0)}</div>`));
      api.markDone(true);
    });

    root.appendChild(w);
  };

  W.capstone = (root, st, api) => {
    root.innerHTML = "";
    const w = el("div",{class:"widget"});
    w.appendChild(el("h4",{}, "综合沙盘：生成你的结算摘要（教学化）"));
    w.appendChild(el("div",{class:"tiny"}, "这是一张“能解释”的小结算单，不追求完全复刻系统，只追求把逻辑串起来。"));

    const grid = el("div",{class:"grid2"});
    const f1 = el("div",{class:"field"}); f1.appendChild(el("label",{},"选择角色"));
    const role = el("select",{});
    role.innerHTML = `
      <option value="gen">发电企业（机组/场站）</option>
      <option value="retail">售电公司（代理用户）</option>
      <option value="user">电力用户</option>
      <option value="storage">独立储能</option>
    `;
    f1.appendChild(role);

    const f2 = el("div",{class:"field"}); f2.appendChild(el("label",{},"本次演练时段数（点数）"));
    const points = el("input",{type:"number", value:"4", min:"1", max:"24"});
    f2.appendChild(points);
    grid.appendChild(f1); grid.appendChild(f2);
    w.appendChild(grid);

    const btn = el("button",{class:"smallBtn", style:"margin-top:10px;"}, "生成并计算");
    w.appendChild(btn);

    const summary = el("div",{class:"widget", style:"margin-top:12px;"});
    summary.innerHTML = "<h4>结算摘要</h4><div class='tiny'>点击“生成并计算”后出现。</div>";
    w.appendChild(summary);

    btn.addEventListener("click", ()=>{
      const r = role.value;
      const k = Math.max(1, Math.min(24, Number(points.value)));
      // 教学化生成数据：合约/现货/实际
      const contractP = 0.29;
      const spotPrices = Array.from({length:k}, (_,i)=> 0.25 + 0.10*Math.sin((i+1)/k*Math.PI)); // 0.15~0.35
      const contractQ = Array.from({length:k}, ()=> 20); // 每点合约电量 20 MWh
      const actualQ = Array.from({length:k}, ()=> 18 + Math.round(Math.random()*6)); // 18~24

      const spotFee = actualQ.reduce((s,q,i)=> s + q*spotPrices[i], 0);
      const diffFee = contractQ.reduce((s,q,i)=> s + (contractP - spotPrices[i])*q, 0);
      const base = spotFee + diffFee;

      // 简化阻塞返还：总额随机，按电量×k 分配只取“自己”一份
      const congTotal = 2000 + Math.random()*3000;
      const curveK = 0.70 + Math.random()*0.25;
      const congShare = congTotal * curveK * 0.18; // 只是示意

      // 简化风险防范：若均价偏离超过区间则补偿/回收，这里只展示判断
      const spotAvg = spotPrices.reduce((s,p)=>s+p,0)/k;
      const ratio = spotAvg/contractP*100;
      const lo=65, hi=135;
      let guard = "在允许范围内";
      if(ratio>hi) guard = "触发：用户侧风险防范补偿/回收（示意）";
      if(ratio<lo) guard = "触发：用户侧风险防范补偿/回收（示意）";

      summary.innerHTML = `
        <h4>结算摘要（教学化）</h4>
        <div class="kpi">
          <div class="k"><div class="kLabel">角色</div><div class="kVal">${role.options[role.selectedIndex].text}</div></div>
          <div class="k"><div class="kLabel">现货均价</div><div class="kVal">${fmt(spotAvg,4)}</div></div>
          <div class="k"><div class="kLabel">合约价</div><div class="kVal">${fmt(contractP,4)}</div></div>
          <div class="k"><div class="kLabel">电能量电费合计</div><div class="kVal">${fmt(base,2)}</div></div>
          <div class="k"><div class="kLabel">阻塞返还（示意）</div><div class="kVal">${fmt(congShare,2)}</div></div>
          <div class="k"><div class="kLabel">风险防范判断</div><div class="kVal">${guard}</div></div>
        </div>
        <div class="tiny" style="margin-top:10px; white-space:pre-wrap;">
点数=${k}
现货价序列=${spotPrices.map(p=>fmt(p,3)).join(", ")}
实际电量=${actualQ.join(", ")}
合约电量=${contractQ.join(", ")}
注：此沙盘用于“串逻辑”，并非交易系统的正式清算结果。
        </div>
        <div style="margin-top:12px;">
          <button class="smallBtn" id="btnFinish">我学完了！</button>
        </div>
      `;

      summary.querySelector("#btnFinish").addEventListener("click", ()=>{
        api.celebrate();
        api.markDone(true);
      });

      api.markDone(true);
    });

    root.appendChild(w);
  };

  window.IM_TUTOR_WIDGETS = W;
})();

</script>
<script>
// app.js
(function(){
  const data = window.IM_TUTOR_DATA;
  const widgets = window.IM_TUTOR_WIDGETS;

  const $ = (q)=>document.querySelector(q);
  const nav = $("#moduleNav");
  const crumbTitle = $("#crumbTitle");
  const crumbSub = $("#crumbSub");
  const stepKicker = $("#stepKicker");
  const stepTitle = $("#stepTitle");
  const stepIntro = $("#stepIntro");
  const stepExplain = $("#stepExplain");
  const stepDo = $("#stepDo");
  const stepCheck = $("#stepCheck");
  const barInner = $("#barInner");
  const stepMetaText = $("#stepMetaText");
  const progressPill = $("#progressPill");
  const cheat = $("#cheat");

  const btnPrev = $("#btnPrev");
  const btnNext = $("#btnNext");
  const btnCheat = $("#btnCheat");
  const btnReset = $("#btnReset");
  const btnSidebar = $("#btnSidebar");
  const sidebar = document.querySelector(".sidebar");

  const confetti = $("#confetti");
  const ctx = confetti.getContext("2d");

  const KEY = "im_tutor_progress_v1";
  const state = loadState();

  let current = {
    modIndex: 0,
    stepIndex: 0,
    cleanup: null
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return { done: {}, last: { moduleId: null, stepId: null } };
  }
  function save(){
    localStorage.setItem(KEY, JSON.stringify(state));
    updateProgressPill();
  }

  function allSteps(){
    const steps = [];
    data.modules.forEach(m=> m.steps.forEach(s=> steps.push({m, s})));
    return steps;
  }
  function computeProgress(){
    const steps = allSteps();
    const doneCount = steps.filter(x=> state.done[x.s.id]).length;
    const total = steps.length || 1;
    const pct = Math.round(doneCount/total*100);
    return {doneCount, total, pct};
  }

  function updateProgressPill(){
    const {pct, doneCount, total} = computeProgress();
    progressPill.textContent = `进度 ${pct}%（${doneCount}/${total}）`;
  }

  function renderNav(){
    nav.innerHTML = "";
    data.modules.forEach((m, idx)=>{
      const btn = document.createElement("button");
      btn.className = "modBtn";
      btn.setAttribute("data-mid", m.id);
      btn.innerHTML = `
        <div class="modTitle">${m.title}</div>
        <div class="modMeta">
          <span>${m.desc || ""}</span>
          <span class="mono">${m.steps.length}步</span>
        </div>
      `;
      btn.addEventListener("click", ()=> jump(m.id, 0));
      nav.appendChild(btn);
    });
  }

  function setActiveNav(moduleId){
    [...nav.querySelectorAll(".modBtn")].forEach(b=>{
      b.classList.toggle("active", b.getAttribute("data-mid")===moduleId);
    });
  }

  function getModuleIndexById(id){
    return data.modules.findIndex(m=> m.id===id);
  }

  function getStep(modIndex, stepIndex){
    const m = data.modules[modIndex];
    if(!m) return null;
    const s = m.steps[stepIndex];
    if(!s) return null;
    return {m, s};
  }

  function renderStep(){
    const {m, s} = getStep(current.modIndex, current.stepIndex) || {};
    if(!m || !s){
      stepTitle.textContent = "请选择左侧模块开始学习";
      stepIntro.textContent = "";
      stepExplain.innerHTML = "";
      stepDo.innerHTML = "";
      stepCheck.innerHTML = "";
      crumbTitle.textContent = "欢迎";
      crumbSub.textContent = "选择左侧模块开始学习";
      stepKicker.textContent = "模块 0 / 0";
      barInner.style.width = "0%";
      stepMetaText.textContent = "—";
      btnPrev.disabled = true;
      btnNext.disabled = true;
      return;
    }

    // cleanup old widget
    if(typeof current.cleanup === "function"){
      try{ current.cleanup(); }catch(e){}
      current.cleanup = null;
    }

    const totalSteps = m.steps.length;
    const stepNo = current.stepIndex + 1;
    const pctInModule = Math.round(stepNo/totalSteps*100);

    stepKicker.textContent = `${m.title} · 第 ${stepNo}/${totalSteps} 步`;
    stepTitle.textContent = s.title;
    crumbTitle.textContent = m.title;
    crumbSub.textContent = s.title;
    barInner.style.width = `${pctInModule}%`;

    stepIntro.textContent = s.intro || "";
    stepExplain.innerHTML = s.explain || "";
    stepDo.innerHTML = "";
    stepCheck.innerHTML = "";

    // widget mount
    const api = {
      markDone: (yes=true)=>{
        if(yes){
          state.done[s.id] = true;
          state.last = { moduleId: m.id, stepId: s.id };
          save();
          renderCheck(); // update badge
        }
      },
      jump: (moduleId, stepIndex=0)=> jump(moduleId, stepIndex),
      celebrate: ()=> confettiBurst()
    };
    if(s.do && s.do.widget){
      const fn = widgets[s.do.widget];
      if(fn){
        current.cleanup = fn(stepDo, state, api) || null;
      }else{
        stepDo.innerHTML = `<div class="widget"><h4>未找到组件：${s.do.widget}</h4><div class="tiny">请检查 widgets.js。</div></div>`;
      }
    }

    renderCheck();

    // nav buttons state
    btnPrev.disabled = !(current.stepIndex>0 || current.modIndex>0);
    btnNext.disabled = false;

    setActiveNav(m.id);
  }

  function renderCheck(){
    const {m, s} = getStep(current.modIndex, current.stepIndex) || {};
    if(!m || !s) return;

    const done = !!state.done[s.id];
    if(s.check?.type === "quiz"){
      stepCheck.innerHTML = `
        <div>
          <div class="sectionTitle">小测：一题就够</div>
          <div class="tiny">${s.check.prompt}</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="quizAns" placeholder="输入答案" style="width:220px;">
          <button class="smallBtn" id="quizBtn">提交</button>
          <span id="quizBadge" class="badge ${done?"good":""}">${done?"已通过":"未通过"}</span>
        </div>
      `;
      const btn = $("#quizBtn");
      const ans = $("#quizAns");
      const badge = $("#quizBadge");
      btn.addEventListener("click", ()=>{
        const a = (ans.value||"").trim();
        if(a === String(s.check.answer)){
          state.done[s.id] = true;
          save();
          badge.textContent = "通过";
          badge.className = "badge good";
          confettiBurst(16);
        }else{
          badge.textContent = "再想想";
          badge.className = "badge warn";
        }
      });
      return;
    }

    // default badge
    stepCheck.innerHTML = `
      <div>
        <div class="sectionTitle">完成状态</div>
        <div class="tiny">完成本步任意一次“动手计算/操作”即可标记为已完成。</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <span class="badge ${done?"good":"warn"}">${done?"已完成":"未完成"}</span>
        <button class="smallBtn" id="btnMark">手动标记完成</button>
      </div>
    `;
    $("#btnMark").addEventListener("click", ()=>{
      state.done[s.id] = true;
      save();
      renderCheck();
      confettiBurst(12);
    });
  }

  function next(){
    const {m} = getStep(current.modIndex, current.stepIndex) || {};
    if(!m) return;
    if(current.stepIndex < m.steps.length - 1){
      current.stepIndex += 1;
renderStep();
      return;
    }
    // next module
    if(current.modIndex < data.modules.length - 1){
      current.modIndex += 1;
      current.stepIndex = 0;
      renderStep();
    }
  }

  function prev(){
    const {m} = getStep(current.modIndex, current.stepIndex) || {};
    if(!m) return;
    if(current.stepIndex > 0){
      current.stepIndex -= 1;
      renderStep();
      return;
    }
    if(current.modIndex > 0){
      current.modIndex -= 1;
      const m2 = data.modules[current.modIndex];
      current.stepIndex = Math.max(0, m2.steps.length - 1);
      renderStep();
    }
  }

  function jump(moduleId, stepIndex=0){
    const mi = getModuleIndexById(moduleId);
    if(mi < 0) return;
    current.modIndex = mi;
    current.stepIndex = Math.max(0, Math.min(stepIndex, data.modules[mi].steps.length - 1));
    renderStep();
    // on mobile, collapse sidebar after pick
    if(window.innerWidth <= 980){
      sidebar.classList.add("collapsed");
    }
  }

  function resetAll(){
    state.done = {};
    state.last = {moduleId:null, stepId:null};
    save();
    renderStep();
  }

  // confetti
  let particles = [];
  function resizeCanvas(){
    confetti.width = window.innerWidth * devicePixelRatio;
    confetti.height = window.innerHeight * devicePixelRatio;
    confetti.style.width = window.innerWidth + "px";
    confetti.style.height = window.innerHeight + "px";
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function confettiBurst(n=32){
    const w = window.innerWidth, h = window.innerHeight;
    const cx = w*0.66, cy = 80;
    for(let i=0;i<n;i++){
      particles.push({
        x: cx + (Math.random()*40-20),
        y: cy + (Math.random()*20-10),
        vx: (Math.random()*2-1)*4,
        vy: Math.random()*-6 - 3,
        g: 0.18 + Math.random()*0.08,
        r: 2 + Math.random()*4,
        a: 1,
        rot: Math.random()*Math.PI,
        vr: (Math.random()*2-1)*0.12
      });
    }
    if(!animating) animate();
  }
  let animating = false;
  function animate(){
    animating = true;
    ctx.clearRect(0,0,confetti.width, confetti.height);
    particles.forEach(p=>{
      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      p.a *= 0.985;

      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = "rgba(255,255,255,.9)";
      ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
      ctx.restore();
    });
    particles = particles.filter(p=> p.a>0.05 && p.y < window.innerHeight + 40);
    if(particles.length){
      requestAnimationFrame(animate);
    }else{
      animating = false;
      ctx.clearRect(0,0,confetti.width, confetti.height);
    }
  }

  // cheat sheet
  function renderCheat(){
    cheat.innerHTML = data.cheat || "";
  }

  // wiring
  btnPrev.addEventListener("click", prev);
  btnNext.addEventListener("click", next);
  btnCheat.addEventListener("click", ()=> cheat.classList.toggle("hidden"));
  btnReset.addEventListener("click", resetAll);
  btnSidebar.addEventListener("click", ()=> sidebar.classList.toggle("collapsed"));

  // init
  renderNav();
  renderCheat();
  updateProgressPill();

  // collapse sidebar on init (mobile)
  if(window.innerWidth <= 980){
    sidebar.classList.add("collapsed");
  }

  // restore last location if exists
  if(state.last?.moduleId){
    const mi = getModuleIndexById(state.last.moduleId);
    if(mi >= 0){
      current.modIndex = mi;
      // find step index by stepId
      const m = data.modules[mi];
      const si = m.steps.findIndex(s=> s.id === state.last.stepId);
      current.stepIndex = Math.max(0, si>=0?si:0);
    }
  }
  renderStep();

  // expose for debugging
  window.IM_TUTOR = { jump };
})();

</script>

</body>
</html>

    </div>
    
    <!-- 保护性script标签：确保用户内容中的未闭合script标签不会影响后续代码 -->
    <!-- 必须紧跟在用户内容之后，在浮动按钮HTML之前，确保正确闭合用户内容中可能存在的未闭合script标签 -->
    <script type="text/javascript"></script>
    
    <!-- 用户内容加载后记录 -->
    <script>
        // 如果函数被覆盖或丢失，尝试恢复
        if (typeof window.handleLike !== 'function') {
            // 函数丢失，已在head中定义，不应该丢失
        }
    </script>
    
    <style>
        /* 内容容器 - 最小化样式，不影响用户内容 */
        .content-wrapper {
            position: relative !important;
            overflow-x: hidden !important;
        }
    </style>
    
    <!-- 手机端展开遮罩层 -->
    <div class="floating-buttons-overlay" id="floatingButtonsOverlay" onclick="if(typeof window.toggleFloatingButtons === 'function') { window.toggleFloatingButtons(); } else if(typeof toggleFloatingButtons === 'function') { toggleFloatingButtons(); }"></div>
    
    <!-- 右下角固定浮层按钮组 - 使用ID和内联样式确保样式不被用户内容覆盖 -->
    <div class="floating-action-buttons" id="dkfile-floating-buttons" style="position: fixed !important; bottom: 80px !important; right: 20px !important; left: auto !important; top: auto !important; z-index: 10000 !important; display: flex !important; flex-direction: column-reverse !important; gap: 8px !important; margin: 0 !important; padding: 0 !important; width: auto !important; height: auto !important; transform: none !important; opacity: 1 !important; visibility: visible !important; pointer-events: auto !important;">
        <!-- 手机端主菜单按钮（默认在底部，展开时在最上方） -->
        <button class="floating-btn floating-menu-btn" id="floatingMenuBtn" onclick="if(typeof window.toggleFloatingButtons === 'function') { window.toggleFloatingButtons(); } else if(typeof toggleFloatingButtons === 'function') { toggleFloatingButtons(); }" title="展开/收起功能按钮">
            <i class="bi bi-plus-lg" id="menuBtnIcon"></i>
        </button>
        
        <!-- 我的工具按钮 -->
        <button class="floating-btn my-tools-btn" id="myToolsBtn" data-label="我的工具" onclick="if(typeof window.handleMyTools === 'function') { window.handleMyTools(); } else { alert('我的工具功能暂时不可用'); }" title="我的工具">
            <i class="bi bi-person-circle"></i>
        </button>
        
        <!-- 分享按钮 -->
        <button class="floating-btn share-btn" data-label="分享" onclick="if(typeof window.handleShare === 'function') { window.handleShare(); } else { alert('分享功能暂时不可用'); }" title="分享到推特、微博">
            <i class="bi bi-share"></i>
        </button>
        
        <!-- 反馈按钮 -->
        <button class="floating-btn feedback-btn" data-label="反馈" onclick="if(typeof window.handleFeedback === 'function') { window.handleFeedback(); } else { alert('反馈功能暂时不可用'); }" title="反馈问题或建议">
<i class="bi bi-chat-dots"></i>
        </button>
        
        <!-- 收藏按钮 -->
        <button class="floating-btn favorite-btn" data-label="收藏" onclick="if(typeof window.handleFavorite === 'function') { window.handleFavorite(); } else { alert('收藏功能暂时不可用'); }" title="在用户中心会展示，帮你更快速访问这些工具">
            <i class="bi bi-bookmark"></i>
        </button>
        
        <!-- 点赞按钮 -->
        <button class="floating-btn like-btn" data-label="点赞" onclick="if(typeof window.handleLike === 'function') { window.handleLike(); } else { alert('点赞功能暂时不可用'); }" title="你的点赞会把这个工具在工具库优先推荐给更多人">
            <i class="bi bi-heart"></i>
        </button>
    </div>
    
    <!-- 平台标识 - 集成到浮动按钮组下方，使用相同的fixed定位机制 -->
    <!-- VIP用户不显示平台标识，非VIP用户显示平台标识 -->
    <!-- PC端显示，手机端隐藏（避免遮挡用户内容） -->
    
    <div id="dkfile-platform-footer-in-buttons" style="position: fixed !important; bottom: 10px !important; right: 20px !important; left: auto !important; top: auto !important; z-index: 10000 !important; display: flex !important; justify-content: flex-end !important; align-items: center !important; visibility: visible !important; opacity: 1 !important; pointer-events: auto !important; margin: 0 !important; padding: 6px 12px !important; width: auto !important; box-sizing: border-box !important; transform: none !important; background: rgba(255, 255, 255, 0.9) !important; backdrop-filter: blur(10px) !important; border-radius: 8px !important; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important; font-size: 11px !important; color: #666 !important; line-height: 1.4 !important;">
        <span style="margin-right: 4px;">由作者发布在</span>
        <a href="/" style="color: #28a745 !important; text-decoration: none !important; margin: 0 2px !important;" title="DKFile - 免费HTML网页托管平台 | Free HTML Website Hosting - 免费HTML网页托管平台" onclick="if(typeof logClick === 'function') { logClick('dkfile_link'); }" rel="nofollow">DKFile</a>
        <span style="margin: 0 4px;">平台，</span>
        <a href="/blog/idolaoxuzuixinbanjieshao" target="_blank" rel="noopener nofollow" style="color: #28a745 !important; text-decoration: none !important; margin: 0 2px !important;" title="技术支持，有任何问题，可以找我" onclick="if(typeof logClick === 'function') { logClick('tech_support'); }">技术支持 IDO老徐</a>
    </div>
    

    
    <script>
        // 在body中再次初始化pageData（如果head中的初始化失败，这里作为备用）
        // 同时确保兼容性（定义局部变量）

        try {
            // 如果head中的初始化失败，这里重新初始化
            if (typeof window.pageData === 'undefined' || !window.pageData || !window.pageData.fileId) {
                
                window.pageData = {"author": "xiaochu1235", "fileId": 18959, "fileName": "mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian.html", "projectName": "mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian"};
                window.currentUserAuthenticated = false;
            }
            
            // 为了兼容性，也定义局部变量（但优先使用window上的）
            const pageData = window.pageData;
            const currentUserAuthenticated = window.currentUserAuthenticated;
        
        // 调试信息

        } catch (error) {

            // 确保至少有一个空对象
            window.pageData = window.pageData || {};
            window.currentUserAuthenticated = window.currentUserAuthenticated || false;
        }
        
        // HTML文件完整性检测
        function validateHtmlFile() {
            const issues = [];
            
            // 检测是否有多个 DOCTYPE html
            const doctypeCount = document.querySelectorAll('html').length;
            if (doctypeCount > 1) {
                issues.push(`检测到 ${doctypeCount} 个HTML文档结构，文件可能包含重复内容`);
            }
            
            // 检测是否有多个 title 标签
            const titleCount = document.querySelectorAll('title').length;
            if (titleCount > 1) {
                issues.push(`检测到 ${titleCount} 个title标签，文件结构异常`);
            }
            
            // 检测是否有多个 body 标签
            const bodyCount = document.querySelectorAll('body').length;
            if (bodyCount > 1) {
                issues.push(`检测到 ${bodyCount} 个body标签，文件结构异常`);
            }
            
            // 检测是否有多个 pageData 对象（通过脚本内容检测）
            const scripts = document.querySelectorAll('script');
            let pageDataCount = 0;
            scripts.forEach(script => {
                if (script.textContent && script.textContent.includes('pageData')) {
                    pageDataCount++;
                }
            });
            if (pageDataCount > 1) {
                issues.push(`检测到 ${pageDataCount} 个pageData对象，可能导致功能异常`);
            }
            
            return issues;
        }
        
        // 智能 pageData 选择
        function getValidPageData() {
            // 如果当前 pageData 有效，直接使用
            if (pageData && pageData.fileId && pageData.fileId !== 'null' && pageData.fileId !== null) {
                return pageData;
            }
            
            // 尝试从页面中查找其他 pageData 对象
            const scripts = document.querySelectorAll('script');
            let foundPageData = null;
            
            for (let script of scripts) {
                if (script.textContent && script.textContent.includes('pageData')) {
                    try {
                        // 尝试提取 pageData 对象
                        const match = script.textContent.match(/const\s+pageData\s*=\s*({[^}]+})/);
                        if (match) {
                            const dataStr = match[1];
                            // 简单的对象解析
                            const fileIdMatch = dataStr.match(/fileId:\s*(\d+)/);
                            if (fileIdMatch) {
                                foundPageData = {
                                    fileId: parseInt(fileIdMatch[1]),
                                    fileName: 'auto-detected',
                                    projectName: 'auto-detected',
                                    author: 'auto-detected'
                                };
                                break;
                            }
                        }
                    } catch (e) {
                        // 静默处理错误
                    }
                }
            }
            
            return foundPageData || pageData;
        }
        
        // 页面加载完成后进行完整性检查
        document.addEventListener('DOMContentLoaded', function() {
            validateHtmlFile();
        });
        
        // 全局错误处理 - 增强版，静默处理语法错误
        window.addEventListener('error', function(event) {
            // 检查是否是语法错误
            const isSyntaxError = event.message && (
                event.message.includes('SyntaxError') ||
                event.message.includes('Unexpected token') ||
                event.message.includes('Unexpected end') ||
                event.message.includes('Unexpected identifier') ||
                (event.error && event.error.name === 'SyntaxError')
            );
            
            // 如果是语法错误，静默处理
            if (isSyntaxError) {
                event.preventDefault(); // 阻止默认错误处理
                return;
            }
            
            // 其他错误正常记录（保留错误日志用于调试）
            console.error('全局错误:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
        });
        
        // 未处理的Promise拒绝处理
        window.addEventListener('unhandledrejection', function(event) {
            // 检查是否是语法错误相关的Promise拒绝
            const reason = event.reason;
            const isSyntaxError = reason && (
                (typeof reason === 'string' && reason.includes('SyntaxError')) ||
                (reason instanceof Error && reason.name === 'SyntaxError')
            );
            
            if (isSyntaxError) {
                event.preventDefault(); // 阻止默认错误处理
                return;
            }
            
            // 保留错误日志用于调试
            console.error('未处理的Promise拒绝:', {
                reason: event.reason,
                promise: event.promise
            });
        });
        
        // 点击记录函数
        function logClick(action) {
            try {
                // 使用智能 pageData 选择
                const validPageData = getValidPageData();
                const fileId = validPageData && validPageData.fileId ? validPageData.fileId : null;
                
                // 即使没有file_id也记录日志（用于菜单展开/收起等操作）
                const logData = {
                    log_type: 'footer_click',
                    action: action,
                    extra_data: JSON.stringify({
                        page_url: window.location.href,
                        page_title: document.title,
                        timestamp: new Date().toISOString(),
                        file_name: validPageData ? validPageData.fileName : null,
                        project_name: validPageData ? validPageData.projectName : null,
                        author: validPageData ? validPageData.author : null
                    })
                };
                
                // 如果有file_id，添加到日志数据中
                if (fileId) {
                    logData.file_id = fileId;
                }
                
                // 发送点击记录请求
                fetch('/api/log_click', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(logData)
                }).then(response => {
                    // 静默处理响应
                }).catch(error => {
                    // 静默处理错误，不影响用户体验
                });
            } catch (error) {
                // 静默处理错误
            }
        }
        
        // 检测浮动按钮样式是否正常
        function checkFloatingButtonsStyle() {
            // 优先使用ID选择器，更精确
            const floatingButtons = document.getElementById('dkfile-floating-buttons') || document.querySelector('.floating-action-buttons');
            if (!floatingButtons) return false;
            
            try {
                const computedStyle = window.getComputedStyle(floatingButtons);
                const rect = floatingButtons.getBoundingClientRect();
                const isMobile = window.innerWidth <= 768;
                
                // 检查基本可见性
                if (computedStyle.display === 'none' || 
                    computedStyle.visibility === 'hidden' ||
                    parseFloat(computedStyle.opacity) < 0.1 ||
                    floatingButtons.offsetParent === null) {
                    return false;
                }
                
                // 检查位置：应该在右下角
                const expectedRight = isMobile ? 10 : 20;
                const expectedBottom = isMobile ? 70 : 80;
                const actualRight = window.innerWidth - rect.right;
                const actualBottom = window.innerHeight - rect.bottom;
                
                // 允许10px的误差
                if (Math.abs(actualRight - expectedRight) > 50 || 
                    Math.abs(actualBottom - expectedBottom) > 50) {
                    return false;
                }
                
                // 检查position
                if (computedStyle.position !== 'fixed') {
                    return false;
                }
                
                // 检查按钮数量（应该有4个）
                const buttons = floatingButtons.querySelectorAll('.floating-btn');
                if (buttons.length < 3) {
                    return false;
                }
                
                // 检查按钮样式是否正常
                let validButtons = 0;
                buttons.forEach(btn => {
                    const btnStyle = window.getComputedStyle(btn);
                    const btnRect = btn.getBoundingClientRect();
                    const expectedSize = isMobile ? 36 : 40;
                    
                    // 检查尺寸
                    if (Math.abs(btnRect.width - expectedSize) < 10 && 
                        Math.abs(btnRect.height - expectedSize) < 10 &&
                        btnStyle.display !== 'none' &&
                        btnStyle.visibility !== 'hidden') {
                        validButtons++;
                    }
                });
                
                // 至少要有3个按钮正常
                return validButtons >= 3;
            } catch (error) {

                return false;
            }
        }
        
        // 检查并修复可能影响fixed定位的父元素样式（使用全局函数如果存在）
        function fixFixedPositioningAncestors(element) {
            // 优先使用head中定义的全局函数
            if (typeof window.fixFixedPositioningAncestors === 'function') {
                return window.fixFixedPositioningAncestors(element);
            }
            
            // 降级方案：本地实现
            if (!element || !element.parentElement) return false;
            
            let current = element.parentElement;
            const problematicProps = ['transform', 'perspective', 'filter', 'will-change'];
            
            while (current && current !== document.body && current !== document.documentElement) {
                const computedStyle = window.getComputedStyle(current);
                
                // 检查是否有影响fixed定位的属性
                for (const prop of problematicProps) {
                    const value = computedStyle.getPropertyValue(prop);
                    if (value && value !== 'none' && value !== 'auto' && value !== 'initial') {
                        // 如果父元素有这些属性，需要将容器移到body下

                        return true; // 需要移动容器
                    }
                }
                
                // 检查position是否为fixed或absolute（这些也可能影响）
                const position = computedStyle.position;
                if (position === 'fixed' || position === 'absolute') {
                    // 如果父元素是fixed或absolute，检查是否有transform等属性
                    const transform = computedStyle.transform;
                    if (transform && transform !== 'none') {

                        return true; // 需要移动容器
                    }
                }
                
                current = current.parentElement;
            }
            
            return false; // 不需要移动
        }
        
        // 强制修复平台标识位置 - 已简化，只检查新的 #dkfile-platform-footer-in-buttons
        function forceFixPlatformFooter() {
            // 新的平台标识已集成到浮动按钮组中，无需额外修复
            // 保留此函数用于向后兼容，但不执行任何操作
            return;
        }
        
        // 兜底方案：如果样式异常，隐藏平台元素
        function applyFallbackStyle() {
            const floatingButtons = document.getElementById('dkfile-floating-buttons') || document.querySelector('.floating-action-buttons');
            const buttonsStyleOk = checkFloatingButtonsStyle();
            
            if (!buttonsStyleOk && floatingButtons) {
                floatingButtons.style.setProperty('display', 'none', 'important');
            } else if (floatingButtons) {
                floatingButtons.style.setProperty('display', 'flex', 'important');
            }
        }
        
        // 启动样式检测和保护机制
        function startStyleProtection() {
            // 初始检测
            applyFallbackStyle();
        }
        
        // 智能配色系统 - 根据页面背景自动调整平台标识文字颜色
        function applyAdaptiveColorScheme() {
            try {

                const platformFooter = document.getElementById('dkfile-platform-footer') || document.querySelector('.platform-footer');
                if (!platformFooter) {

                    return;
                }
                
                // 获取content-wrapper元素（用户内容区域）
                const contentWrapper = document.querySelector('.content-wrapper');
                if (!contentWrapper) {

                    return;
                }
                
                // 获取content-wrapper的计算样式（包括继承的背景色）
                const computedStyle = window.getComputedStyle(contentWrapper);
                let backgroundColor = computedStyle.backgroundColor;
                
                // 如果背景色是透明或rgba，尝试向上查找父元素的背景色
                if (!backgroundColor || backgroundColor === 'rgba(0, 0, 0, 0)' || backgroundColor === 'transparent') {
                    // 检查body的背景色
                    const bodyStyle = window.getComputedStyle(document.body);
                    backgroundColor = bodyStyle.backgroundColor;
                    
                    // 如果body也是透明，检查html
                    if (!backgroundColor || backgroundColor === 'rgba(0, 0, 0, 0)' || backgroundColor === 'transparent') {
                        const htmlStyle = window.getComputedStyle(document.documentElement);
                        backgroundColor = htmlStyle.backgroundColor;
                    }
                }

                // 如果仍然没有检测到有效的背景色，使用默认浅色模式
                if (!backgroundColor || backgroundColor === 'rgba(0, 0, 0, 0)' || backgroundColor === 'transparent') {

                    platformFooter.classList.remove('adaptive-dark');
                    platformFooter.classList.add('adaptive-light');
                    return;
                }
                
                // 解析RGB颜色值
                function parseRGB(rgbString) {
                    // 匹配 rgb(r, g, b) 或 rgba(r, g, b, a) 格式
                    const match = rgbString.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);
                    if (match) {
                        return {
                            r: parseInt(match[1]),
                            g: parseInt(match[2]),
                            b: parseInt(match[3])
                        };
                    }
                    return null;
                }
                
                // 计算颜色的相对亮度（WCAG标准）
                function getLuminance(rgb) {
                    // 转换为0-1范围
                    const [r, g, b] = [rgb.r / 255, rgb.g / 255, rgb.b / 255];
                    
                    // 应用gamma校正
                    const adjust = (val) => {
                        return val <= 0.03928 ? val / 12.92 : Math.pow((val + 0.055) / 1.055, 2.4);
                    };
                    
                    // 计算相对亮度
                    return 0.2126 * adjust(r) + 0.7152 * adjust(g) + 0.0722 * adjust(b);
                }
                
                // 计算亮度（简单的亮度计算，0-255）
                function getBrightness(rgb) {
                    // 使用加权平均值计算亮度
                    return (rgb.r * 0.299 + rgb.g * 0.587 + rgb.b * 0.114);
                }
                
                const rgb = parseRGB(backgroundColor);
                if (!rgb) {

                    platformFooter.classList.remove('adaptive-dark');
                    platformFooter.classList.add('adaptive-light');
                    return;
                }
                
                // 计算亮度和对比度
                const brightness = getBrightness(rgb);
                const luminance = getLuminance(rgb);

                // 判断是浅色还是深色背景
                // 使用两个标准：亮度阈值和相对亮度阈值
                // 如果亮度 < 128 或相对亮度 < 0.5，认为是深色背景
                const isDarkBackground = brightness < 128 || luminance < 0.5;

                // 应用对应的配色方案
                if (isDarkBackground) {
                    platformFooter.classList.remove('adaptive-light');
                    platformFooter.classList.add('adaptive-dark');
                } else {
                    platformFooter.classList.remove('adaptive-dark');
                    platformFooter.classList.add('adaptive-light');
                }
                
            } catch (error) {
                // 出错时使用默认浅色模式
                const platformFooter = document.getElementById('dkfile-platform-footer') || document.querySelector('.platform-footer');
                if (platformFooter) {
                    platformFooter.classList.remove('adaptive-dark');
                    platformFooter.classList.add('adaptive-light');
                }
            }
        }
        
        // 初始化手机端按钮合并功能
        function initMobileButtonMerge() {
            try {
                const floatingButtons = document.getElementById('dkfile-floating-buttons');
                if (!floatingButtons) {
                    return;
                }
                
                const isMobile = window.innerWidth <= 768;
                const menuBtn = document.getElementById('floatingMenuBtn');
                
                if (isMobile) {
                    // 手机端：默认收起状态
                    floatingButtons.classList.remove('expanded');
                    if (menuBtn) {
                        // 强制显示菜单按钮（使用多种方式确保生效）
                        menuBtn.style.setProperty('display', 'flex', 'important');
                        menuBtn.style.display = 'flex';
                        menuBtn.style.visibility = 'visible';
                        menuBtn.style.opacity = '1';
                    }
                    
                    // 点击其他按钮时，如果是手机端且已展开，自动收起
                    const actionButtons = floatingButtons.querySelectorAll('.floating-btn:not(.floating-menu-btn)');
                    actionButtons.forEach(btn => {
                        // 移除旧的事件监听器（如果存在）
                        const newBtn = btn.cloneNode(true);
                        btn.parentNode.replaceChild(newBtn, btn);
                        
                        // 添加新的事件监听器
                        newBtn.addEventListener('click', function() {
                            // 延迟一下再收起，让用户看到点击效果
                            setTimeout(function() {
                                if (typeof window.toggleFloatingButtons === 'function') {
                                    window.toggleFloatingButtons();
                                }
                            }, 300);
                        });
                    });

                } else {
                    // PC端：始终展开
                    floatingButtons.classList.add('expanded');
                    if (menuBtn) {
                        menuBtn.style.display = 'none';
                    }
                }
            } catch (error) {
                // 静默处理错误
            }
        }
        
        // 页面加载完成后启动样式检测
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化手机端按钮合并功能
            initMobileButtonMerge();
            
            // 检查登录状态并设置"我的工具"按钮样式
            const isAuthenticated = typeof window.currentUserAuthenticated !== 'undefined' 
                ? window.currentUserAuthenticated 
                : (typeof currentUserAuthenticated !== 'undefined' ? currentUserAuthenticated : false);
            const myToolsBtn = document.getElementById('myToolsBtn');
            if (myToolsBtn && isAuthenticated) {
                myToolsBtn.classList.add('logged-in');
            }
            
            // 监听窗口大小变化，重新初始化
            window.addEventListener('resize', function() {
                initMobileButtonMerge();
            });
            
            // 立即启动样式保护机制
            startStyleProtection();
            
            // 延迟检测，等待用户内容加载完成
            setTimeout(function() {
                // 应用智能配色（延迟执行，确保用户内容已完全加载）
                applyAdaptiveColorScheme();
            }, 100);
            
            // 记录页面访问
            logClick('page_view');
        });
        
        // window.onload时也启动检测
        window.addEventListener('load', function() {
            // 初始化手机端按钮合并功能
            initMobileButtonMerge();
            
            // 立即启动样式保护
            startStyleProtection();
            
            // 延迟执行，确保DOM完全加载
            setTimeout(function() {
                // 应用智能配色（确保在完全加载后）
                applyAdaptiveColorScheme();
            }, 100);
        });
        
        // 监听页面内容变化，如果背景色改变，重新应用配色
        // 使用MutationObserver监听content-wrapper的变化
        if (typeof MutationObserver !== 'undefined') {
            const colorObserver = new MutationObserver(function(mutations) {
                let shouldRecalculate = false;
                mutations.forEach(function(mutation) {
                    // 如果样式属性改变，重新计算配色
                    if (mutation.type === 'attributes' && 
                        (mutation.attributeName === 'style' || mutation.attributeName === 'class')) {
                        const target = mutation.target;
                        // 检查是否是content-wrapper或其子元素
                        if (target.closest && target.closest('.content-wrapper')) {
                            shouldRecalculate = true;
                        }
                    }
                    // 如果子元素添加或移除，也可能影响背景
                    if (mutation.type === 'childList') {
                        const target = mutation.target;
                        if (target.classList && target.classList.contains('content-wrapper')) {
                            shouldRecalculate = true;
                        }
                    }
                });
                
                if (shouldRecalculate) {
                    // 防抖处理，避免频繁重新计算
                    clearTimeout(window.colorRecalculateTimer);
                    window.colorRecalculateTimer = setTimeout(function() {
                        applyAdaptiveColorScheme();
                    }, 300);
                }
            });
            
            // 等待DOM加载完成后开始观察
            document.addEventListener('DOMContentLoaded', function() {
                const contentWrapper = document.querySelector('.content-wrapper');
                if (contentWrapper) {
                    colorObserver.observe(contentWrapper, {
                        attributes: true,
                        attributeFilter: ['style', 'class'],
                        childList: true,
                        subtree: true
                    });
                }
            });
        }
        
        // 防止用户通过Object.defineProperty修改style对象
        (function() {
            const platformFooter = document.querySelector('.platform-footer');
            if (platformFooter && platformFooter.style) {
                try {
                    // 尝试锁定style对象的某些属性（如果可能）
                    const originalSetProperty = platformFooter.style.setProperty;
                    platformFooter.style.setProperty = function(property, value, priority) {
                        // 如果是关键属性，强制使用important
                        const criticalProps = ['position', 'bottom', 'right', 'left', 'top', 'z-index', 'display', 'visibility', 'opacity'];
                        if (criticalProps.includes(property.toLowerCase())) {
                            return originalSetProperty.call(this, property, value, 'important');
                        }
                        return originalSetProperty.call(this, property, value, priority);
                    };
                } catch (e) {
                    // 如果无法修改，忽略错误
                }
            }
        })();
        
        // 检查用户登录状态和收藏点赞状态
            if (typeof currentUserAuthenticated !== 'undefined' && currentUserAuthenticated) {
                // 设置"我的工具"按钮为已登录状态（红色效果）
                const myToolsBtn = document.getElementById('myToolsBtn');
                if (myToolsBtn) {
                    myToolsBtn.classList.add('logged-in');
                }
                
                // 使用智能 pageData 选择
                const validPageData = getValidPageData();
                
                if (validPageData && validPageData.fileId) {
                    // 检查收藏状态
                    fetch('/api/check_favorite/' + validPageData.fileId)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.is_favorited) {
                                const favoriteBtn = document.querySelector('.floating-btn.favorite-btn');
                                if (favoriteBtn) {
                                    favoriteBtn.classList.add('favorited');
                                    favoriteBtn.innerHTML = '<i class="bi bi-bookmark-fill"></i>';
                                }
                            }
                        })
                        .catch(error => {
                            // 静默处理错误
                        });
                    
                    // 检查点赞状态
                    fetch('/api/check_like/' + validPageData.fileId)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.is_liked) {
                                const likeBtn = document.querySelector('.floating-btn.like-btn');
                                if (likeBtn) {
                                    likeBtn.classList.add('liked');
                                    likeBtn.innerHTML = '<i class="bi bi-heart-fill"></i>';
                                }
                            }
                        })
                        .catch(error => {
                            // 静默处理错误
                        });
                }
            }
        });
    </script>

    <!-- 反馈浮层弹窗 -->
    <div id="feedbackOverlay" class="floating-overlay" onclick="if(event.target === this) closeFeedback()">
        <div class="floating-panel">
            <div class="floating-header">
                <h5 class="floating-title">
                    <i class="bi bi-chat-dots me-2"></i>问题反馈
                </h5>
                <button type="button" class="floating-close" onclick="closeFeedback()" aria-label="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <form id="feedbackForm" enctype="multipart/form-data">
                <div class="floating-body">
                    <!-- 工具信息 -->
                    <div class="feedback-tool-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>反馈来源：</strong>mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian
                        <br><small class="text-muted">工具链接：http://deepseek.idoxu.com/xiaochu1235/mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian.html</small>
                    </div>
                    
                    <!-- 反馈类型 -->
                    <div class="feedback-section">
                        <label class="feedback-label">反馈类型</label>
                        <div class="feedback-type-grid">
                            <div class="feedback-type-item">
                                <input type="radio" class="feedback-type-input" name="feedback_type" id="feedback_bug" value="bug">
                                <label class="feedback-type-btn" for="feedback_bug">
                                    问题反馈
                                </label>
                            </div>
                            <div class="feedback-type-item">
                                <input type="radio" class="feedback-type-input" name="feedback_type" id="feedback_feature" value="feature">
                                <label class="feedback-type-btn" for="feedback_feature">
                                    功能建议/需求
                                </label>
                            </div>
                            <div class="feedback-type-item">
                                <input type="radio" class="feedback-type-input" name="feedback_type" id="feedback_support" value="technical_support">
                                <label class="feedback-type-btn" for="feedback_support">
                                    技术支持
                                </label>
                            </div>
                            <div class="feedback-type-item">
                                <input type="radio" class="feedback-type-input" name="feedback_type" id="feedback_support" value="technical_support">
                                <label class="feedback-type-btn" for="feedback_support">
                                    技术支持
                                </label>
                            </div>
                            <div class="feedback-type-item">
                                <input type="radio" class="feedback-type-input" name="feedback_type" id="feedback_business" value="business_cooperation">
                                <label class="feedback-type-btn" for="feedback_business">
                                    商务合作
                                </label>
                            </div>
                            <div class="feedback-type-item">
                                <input type="radio" class="feedback-type-input" name="feedback_type" id="feedback_other" value="other" checked>
                                <label class="feedback-type-btn" for="feedback_other">
                                    其他
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 反馈内容 -->
                    <div class="feedback-section">
                        <label for="feedbackContent" class="feedback-label">反馈内容</label>
                        <div class="feedback-textarea-wrapper">
                            <textarea class="feedback-textarea" 
                                      id="feedbackContent" 
                                      name="description" 
                                      rows="4" 
                                      placeholder="请详细描述您的问题或建议..." 
                                      maxlength="1000" 
                                      required></textarea>
                            <div class="feedback-char-count" id="charCount">0/1000</div>
                        </div>
                        <div class="feedback-hint">
                            <i class="bi bi-info-circle me-1"></i>请尽可能详细地描述，这有助于我们更好地理解和解决问题
                        </div>
                        <div class="feedback-notice">
                            <i class="bi bi-envelope me-1"></i>
                            问题解决后，会通过你的帐号邮箱给你回复，也能在 
                            <a href="/my_feedbacks" class="feedback-link">我的反馈</a> 
                            查看问题处理进度。
                        </div>
                    </div>
                    
                    <!-- 图片上传区域 -->
                    <div class="feedback-section">
                        <label class="feedback-label">上传图片（可选，最多9张）</label>
                        <div class="border rounded p-2" style="background-color: #f8f9fa; min-height: 70px;">
                            <input type="file" id="feedback_images" name="images" multiple accept="image/*" style="display: none;" />
                            <div id="feedback_image_preview" class="d-flex flex-wrap gap-2 mb-2"></div>
                            <div class="mb-1">
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="document.getElementById('feedback_images').click();" style="font-size: 0.8rem; padding: 0.2rem 0.6rem;">
                                    <i class="bi bi-image me-1"></i>选择图片
                                </button>
                            </div>
                            <small class="d-block" style="font-size: 11px; color: #333;">
                                <i class="bi bi-info-circle me-1"></i>支持 jpg、png、gif、webp、bmp 格式，单张最大 5MB
                            </small>
                        </div>
                    </div>
                </div>
                <div class="floating-footer">
                    <button type="button" class="floating-btn-action floating-btn-secondary" onclick="closeFeedback()">
                        取消
                    </button>
                    <button type="submit" class="floating-btn-action floating-btn-primary" id="submitFeedback">
                        <i class="bi bi-send me-1"></i>提交反馈
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 分享浮层弹窗 - 使用内联样式确保最高优先级，防止被用户内容覆盖 -->
    <div id="shareOverlay" class="floating-overlay" onclick="if(event.target === this) closeShare()" style="position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 2147483646 !important; display: none !important; pointer-events: auto !important; visibility: visible !important; opacity: 1 !important;">
        <div class="floating-panel" style="position: relative !important; z-index: 2147483647 !important; display: block !important;">
            <div class="share-menu" style="position: relative !important; z-index: 2147483647 !important;">

                
                <!-- 工具信息 -->
                <div class="share-info">
                    <div class="share-info-title">
                        <i class="bi bi-info-circle me-1"></i>分享内容
                    </div>
                    <div class="share-info-content">
                        <strong>mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian</strong><br>
                        <small>来自 DKFile 免费HTML网页托管平台</small>
                    </div>
                </div>
                
                <!-- 二维码区域 -->
                <div class="qr-code-section mb-4">
                    <div id="shareQrCode" class="qr-code-container">
                        <div class="qr-loading">
                            <i class="bi bi-hourglass-split"></i> 生成二维码中...
                        </div>
                    </div>
                    
                    <!-- 分享操作按钮组 -->
                    <div class="qr-actions" style="position: relative !important; z-index: 2147483647 !important;">
                        <button class="qr-action-btn download-btn" onclick="if(typeof downloadQRCode === 'function') { downloadQRCode(); } else { void(0); }" style="position: relative !important; z-index: 2147483647 !important; pointer-events: auto !important;">
                            <i class="bi bi-download me-1"></i>
                            <span>下载二维码</span>
                        </button>
                        <button class="qr-action-btn copy-btn" onclick="if(typeof copyLink === 'function') { copyLink(); } else { void(0); }" style="position: relative !important; z-index: 2147483647 !important; pointer-events: auto !important;">
                            <i class="bi bi-link-45deg me-1"></i>
                            <span>复制链接</span>
                        </button>
                    </div>
                </div>
                
                <!-- 分享渠道标题 -->
                <div class="share-channels-header">
                    <h6 class="share-channels-title">
                        <i class="bi bi-share me-2"></i>一键分享到这些平台
                    </h6>
                </div>
                
                <div class="share-buttons">
                    <!-- 主要社交平台 -->
                    <button class="share-btn x-twitter" onclick="if(typeof shareToTwitter === 'function') { shareToTwitter(); } else { void(0); }">
                        <!-- X (Twitter) 图标 - 使用黑色背景 -->
                        <div class="x-icon-container">
                            <svg class="x-icon" viewBox="0 0 24 24" fill="white">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </div>
                        <span>X (Twitter)</span>
                    </button>
                    
                    <!-- 中文平台 -->
                    <button class="share-btn weibo" onclick="if(typeof shareToWeibo === 'function') { shareToWeibo(); } else { void(0); }">
                        <i class="bi bi-weibo"></i>
                        <span>微博</span>
                    </button>
                    
                    <!-- 全球开发者平台 -->
                    <button class="share-btn github" onclick="if(typeof shareToGithub === 'function') { shareToGithub(); } else { void(0); }">
                        <i class="bi bi-github"></i>
                        <span>GitHub</span>
                    </button>
                    
                    <button class="share-btn reddit" onclick="if(typeof shareToReddit === 'function') { shareToReddit(); } else { void(0); }">
                        <i class="bi bi-reddit"></i>
                        <span>Reddit</span>
                    </button>
                    
                    <!-- 专业平台 -->
                    <button class="share-btn linkedin" onclick="if(typeof shareToLinkedIn === 'function') { shareToLinkedIn(); } else { void(0); }">
                        <i class="bi bi-linkedin"></i>
                        <span>LinkedIn</span>
                    </button>
                    
                    <!-- 即时通讯 -->
                    <button class="share-btn whatsapp" onclick="if(typeof shareToWhatsApp === 'function') { shareToWhatsApp(); } else { void(0); }">
                        <i class="bi bi-whatsapp"></i>
                        <span>WhatsApp</span>
                    </button>
                    
                    <button class="share-btn telegram" onclick="if(typeof shareToTelegram === 'function') { shareToTelegram(); } else { void(0); }">
                        <i class="bi bi-telegram"></i>
                        <span>Telegram</span>
                    </button>
                    
                    <!-- 国内平台 -->
                    <button class="share-btn wechat" onclick="if(typeof shareToWeChat === 'function') { shareToWeChat(); } else { void(0); }">
                        <i class="bi bi-wechat"></i>
                        <span>微信</span>
                    </button>
                    
                    <button class="share-btn qq" onclick="if(typeof shareToQQ === 'function') { shareToQQ(); } else { void(0); }">
                        <i class="bi bi-qq"></i>
                        <span>QQ</span>
                    </button>
                </div>
                
                <div class="share-divider"></div>
                
                <div class="share-close-section" style="position: relative !important; z-index: 2147483647 !important;">
                    <button class="floating-btn-action floating-btn-secondary" onclick="if(typeof closeShare === 'function') { closeShare(); } else { void(0); }" style="position: relative !important; z-index: 2147483647 !important; pointer-events: auto !important;">
                        <i class="bi bi-x-lg me-1"></i>关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 统一的图片下载公共服务 -->
    <script src="/static/js/share-functions.js"></script>
    <!-- 统一图片压缩服务 -->
    <script src="/static/js/dkfile-image-compressor.js"></script>
    
    <!-- 移除重复的 Google 服务加载器，因为 base.html 已经包含 -->
    <!-- <script src="/static/js/google-services-loader.js"></script> -->

    <script>
        // 使用IIFE包装，防止用户内容中的语法错误影响此代码块
        // 图片上传和压缩相关变量
        var selectedFeedbackImages = [];
        var feedbackImageCompressor = null;
        try {
            if (typeof DKFileImageCompressor !== 'undefined') {
                feedbackImageCompressor = new DKFileImageCompressor({
                    maxDimension: 1600,
                    quality: 0.75,
                    minCompressSize: 300 * 1024
                });
            }
        } catch (error) {
            console.error('初始化反馈图片压缩器失败:', error);
            selectedFeedbackImages = [];
            feedbackImageCompressor = null;
        }
        
        // 字符计数功能
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('feedbackContent');
            const charCount = document.getElementById('charCount');
            
            if (textarea && charCount) {
                textarea.addEventListener('input', function() {
                    const length = this.value.length;
                    charCount.textContent = length + '/1000';
                    
                    if (length > 900) {
                        charCount.style.color = '#dc3545';
                    } else if (length > 800) {
                        charCount.style.color = '#ffc107';
                    } else {
                        charCount.style.color = '#999';
                    }
                });
            }
            
            // 初始化图片上传功能
            initializeFeedbackImageUpload();
        });
        
        // 初始化图片上传功能
        function initializeFeedbackImageUpload() {
            const feedbackImagesInput = document.getElementById('feedback_images');
            const feedbackImagePreview = document.getElementById('feedback_image_preview');
            
            if (!feedbackImagesInput || !feedbackImagePreview) return;
            
            // 文件选择事件
            feedbackImagesInput.addEventListener('change', async function(e) {
                const files = Array.from(e.target.files);
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/bmp'];
                const maxSize = 5 * 1024 * 1024; // 5MB
                const maxImages = 9;
                
                // 验证图片数量和总数量
                if (selectedFeedbackImages.length + files.length > maxImages) {
                    showToast('最多只能上传 ' + maxImages + ' 张图片', 'error');
                    return;
                }
                
                const invalidFile = files.find(file => {
                    if (!allowedTypes.includes(file.type)) {
                        showToast('图片 ' + file.name + ' 格式不支持，仅支持 jpg、png、gif、webp、bmp 格式', 'error');
                        return true;
                    }
                    if (file.size > maxSize) {
                        showToast('图片 ' + file.name + ' 过大，单张图片最大支持 5MB', 'error');
                        return true;
                    }
                    return false;
                });
                
                if (invalidFile) {
                    return;
                }
                
                showToast('图片压缩中，请稍候...', 'info');
                
                try {
                    // 检查压缩服务是否可用
                    if (!feedbackImageCompressor) {
                        console.warn('[View] 图片压缩服务未加载，使用原文件');
                        files.forEach(file => selectedFeedbackImages.push(file));
                    } else {
                        console.log('[View] 开始压缩 ' + files.length + ' 张图片...');
                        files.forEach((file, index) => {
                            console.log('[View] 原始文件 ' + (index + 1) + ': ' + file.name + ', 大小: ' + (file.size / 1024).toFixed(2) + ' KB');
                        });
                        
                        // 使用统一压缩服务的批量压缩方法
                        const compressedFiles = await feedbackImageCompressor.compressMultipleImages(files);
                        
                        console.log('[View] 压缩完成，共 ' + compressedFiles.length + ' 张图片');
                        compressedFiles.forEach((file, index) => {
                            console.log('[View] 压缩后文件 ' + (index + 1) + ': ' + file.name + ', 大小: ' + (file.size / 1024).toFixed(2) + ' KB');
                        });
                        
                        compressedFiles.forEach(file => selectedFeedbackImages.push(file));
                    }
                    
                    showToast('图片已压缩完成。', 'success');
                } catch (err) {
                    console.error('[View] 图片压缩失败:', err);
                    showToast('图片处理失败，请重试。', 'error');
                    return;
                }
                
                updateFeedbackImageInput();
                previewFeedbackImages();
            });
        }
        
        // 更新input中的文件
        function updateFeedbackImageInput() {
            const feedbackImagesInput = document.getElementById('feedback_images');
            if (!feedbackImagesInput) return;
            
            const dt = new DataTransfer();
            selectedFeedbackImages.forEach(file => dt.items.add(file));
            feedbackImagesInput.files = dt.files;
        }
        
        // 预览图片
        function previewFeedbackImages() {
            const feedbackImagePreview = document.getElementById('feedback_image_preview');
            if (!feedbackImagePreview) return;
            
            feedbackImagePreview.innerHTML = '';
            
            // 如果没有图片，清空预览区域（保持显示，但不占用额外空间）
            if (selectedFeedbackImages.length === 0) {
                return;
            }
            
            selectedFeedbackImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'position-relative';
                    imgContainer.style.cssText = 'width: 120px; height: 120px; margin-bottom: 10px;';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 8px;';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-sm btn-danger position-absolute';
                    removeBtn.style.cssText = 'top: -5px; right: -5px; width: 24px; height: 24px; padding: 0; border-radius: 50%; font-size: 12px; line-height: 1;';
                    removeBtn.innerHTML = '×';
                    removeBtn.onclick = function() {
                        selectedFeedbackImages.splice(index, 1);
                        updateFeedbackImageInput();
                        previewFeedbackImages();
                    };
                    
                    imgContainer.appendChild(img);
                    imgContainer.appendChild(removeBtn);
                    feedbackImagePreview.appendChild(imgContainer);
                };
                reader.readAsDataURL(file);
            });
        }

        // 反馈表单提交
        document.getElementById('feedbackForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitFeedback');
            const originalText = submitBtn.innerHTML;
            
            // 确保使用压缩后的图片（更新input中的文件）
            if (selectedFeedbackImages.length > 0) {
                updateFeedbackImageInput();
                console.log('[View] 已更新input中的压缩图片，数量:', selectedFeedbackImages.length);
            }
            
            const formData = new FormData(this);
            
            // 添加工具信息
            formData.append('tool_url', 'http://deepseek.idoxu.com/xiaochu1235/mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian.html');
            formData.append('tool_title', 'mengxidianlishichangjiaoyiguizechuangguanyouxi_shoujishipeixiufuban_danwenjian');
            formData.append('tool_id', '18959');
            
            // 调试：检查FormData中的文件
            if (selectedFeedbackImages.length > 0) {
                const formFiles = formData.getAll('images');
                console.log('[View] FormData中的文件数量:', formFiles.length);
                formFiles.forEach((file, index) => {
                    console.log('[View] 文件 ' + (index + 1) + ': ' + file.name + ', 大小: ' + (file.size / 1024).toFixed(2) + ' KB');
                });
            }
            
            // 显示提交中状态
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>提交中...';
            
            fetch('/submit_feedback', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('反馈提交成功！我们会尽快处理您的反馈。');
                    // 关闭浮层
                    if (typeof window.closeFeedback === 'function') {
                        window.closeFeedback();
                    } else if (typeof closeFeedback === 'function') {
                    closeFeedback();
                    }
                    // 重置表单
                    this.reset();
                    document.getElementById('charCount').textContent = '0/1000';
                    // 清空图片
                    selectedFeedbackImages = [];
                    updateFeedbackImageInput();
                    previewFeedbackImages();
                } else {
                    showToast('提交失败：' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('提交失败，请检查网络连接后重试');
            })
            .finally(() => {
                // 恢复按钮状态
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
        
        // 移动端隐藏平台标识（确保覆盖内联样式）
        (function() {
            function hidePlatformFooterOnMobile() {
                const footer = document.getElementById('dkfile-platform-footer-in-buttons');
                if (footer && window.innerWidth <= 768) {
                    footer.style.setProperty('display', 'none', 'important');
                } else if (footer && window.innerWidth > 768) {
                    footer.style.setProperty('display', 'flex', 'important');
                }
            }
            
            // 页面加载时执行
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', hidePlatformFooterOnMobile);
            } else {
                hidePlatformFooterOnMobile();
            }
            
            // 窗口大小改变时重新检查
            window.addEventListener('resize', hidePlatformFooterOnMobile);
        })();
        
    </script>
    
    <!-- CSRF Token 自动添加脚本 -->
    <script>
    // 自动为所有 AJAX 请求添加 CSRF token
    (function() {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        
        if (csrfToken) {
            // 判断是否为同源请求（包括相对路径）
            function isSameOrigin(url) {
                if (typeof url !== 'string') return false;
                // 相对路径视为同源
                if (url.startsWith('/')) return true;
                // 绝对路径检查协议和域名
                try {
                    const urlObj = new URL(url, window.location.href);
                    return urlObj.origin === window.location.origin;
                } catch (e) {
                    return false;
                }
            }
            
            // 为 fetch 请求添加 CSRF token
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const [url, options = {}] = args;
                
                // 只对同源请求且为状态修改的请求添加 CSRF token
                if (options.method && ['POST', 'PUT', 'DELETE', 'PATCH'].includes(options.method.toUpperCase()) &&
                    isSameOrigin(url)) {
                    // 确保 headers 对象存在
                    if (!options.headers) {
                        options.headers = {};
                    }
                    // 如果 headers 是 Headers 对象，使用 set 方法
                    if (options.headers instanceof Headers) {
                        options.headers.set('X-CSRF-Token', csrfToken);
                    } else {
                        // 普通对象，直接设置
                        options.headers = {
                            ...options.headers,
                            'X-CSRF-Token': csrfToken
                        };
                    }
                }
                
                return originalFetch.apply(this, args);
            };
            
            // 为 XMLHttpRequest 添加 CSRF token
            const originalXHROpen = XMLHttpRequest.prototype.open;
            const originalXHRSend = XMLHttpRequest.prototype.send;
            
            XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
                this._xhrUrl = url;
                this._xhrMethod = method;
                return originalXHROpen.call(this, method, url, async, user, password);
            };
            
            XMLHttpRequest.prototype.send = function(data) {
                // 只对同源请求且为状态修改的请求添加 CSRF token
                if (this._xhrMethod && ['POST', 'PUT', 'DELETE', 'PATCH'].includes(this._xhrMethod.toUpperCase()) &&
                    isSameOrigin(this._xhrUrl)) {
                    this.setRequestHeader('X-CSRF-Token', csrfToken);
                }
                return originalXHRSend.call(this, data);
            };
            
            // 为表单提交添加 CSRF token（动态表单）
            document.addEventListener('submit', function(e) {
                const form = e.target;
                if (form.tagName === 'FORM' && !form.querySelector('input[name="csrf_token"]')) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'csrf_token';
                    input.value = csrfToken;
                    form.appendChild(input);
                }
            });
        }
    })();
    </script>
</body>
</html>
